<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>謀定鄴都</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="apple-touch-icon" href="icon2.jpg">
<!-- 让 Safari 以“App 模式”打开 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="谋定邺都">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600&display=swap');
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Serif TC", serif;
      background: linear-gradient(135deg, #fdfbf7 0%, #f7f3ed 50%, #fef9f3 100%);
      color: #3d3529;
    }
    header {
      background: rgba(255,252,245,0.97);
      border-bottom: 1px solid rgba(178,144,90,0.2);
      padding: 16px 20px;
    }
    header.header-hidden {
      transform: translateY(-100%);
    }
   .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 16px;
      align-items: center;
    }
    .header-left {
      justify-self: start;
    }
    .header-center {
      justify-self: center;
      text-align: center;
    }
    .header-right {
      justify-self: end;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }
    .header-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .clock {
      font-size: 28px;
      font-weight: 300;
      color: #5c4d3d;
      letter-spacing: 4px;
    }
    .date-text {
      font-size: 12px;
      color: #8b7355;
    }
    .era-text {
      font-size: 18px;
      color: #8b6914;
      font-weight: 500;
      letter-spacing: 2px;
    }
    .era-desc {
      font-size: 11px;
      color: #a08060;
      max-width: 280px;
    }
    .title-main {
      font-size: 20px;
      color: #8b6914;
      font-weight: 600;
      letter-spacing: 4px;
      text-align: center;
      margin-bottom: 4px;
    }
    .title-era {
      font-size: 15px;
      color: #8b6914;
      font-weight: 500;
      letter-spacing: 2px;
    }
    .date-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .date-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(178,144,90,0.4);
      background: rgba(255,255,255,0.9);
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .header-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .header-buttons .btn {
      font-size: 11px;
      padding: 6px 12px;
    }
    .header-right {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }
    .header-stats-panel {
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      border: 1px solid rgba(178,144,90,0.25);
      padding: 8px 12px;
      display: flex;
      gap: 16px;
      font-size: 10px;
    }
    .header-stats-area {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }
    .daily-attr-item.standalone {
      background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(255,255,255,0.9));
      border: 1px solid rgba(212,175,55,0.4);
      border-radius: 8px;
      padding: 8px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 65px;
    }
    
    .daily-attr-item {
      background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(255,255,255,0.9));
      border: 1px solid rgba(212,175,55,0.4);
      border-radius: 8px;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 60px;
    }
    .daily-attr-label {
      font-size: 10px;
      color: #8b6914;
      margin-bottom: 2px;
    }
    .daily-attr-value {
      font-size: 18px;
      font-weight: 700;
      color: #8b6914;
    }
    .daily-attr-value.value-high { color: #4a7c59; }
    .daily-attr-value.value-mid { color: #c08020; }
    .daily-attr-value.value-low { color: #c04040; }
    .header-stat-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .header-stat-title {
      font-size: 9px;
      color: #a08060;
      font-weight: 500;
      margin-bottom: 2px;
    }
    .header-stat-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .header-stat-row span {
      color: #6b5a4a;
    }
    .header-stat-row .stat-val {
      font-weight: 600;
      color: #8b6914;
      min-width: 28px;
      text-align: center;
    }

    /* 工具按鈕欄 */
  .toolbar {
      background: rgba(250,246,236,0.95);
      border-bottom: 1px solid rgba(178,144,90,0.2);
      padding: 8px 20px;
      /* 不再吸頂，變成正常內嵌區塊 */
      position: static;
      transition: transform 0.3s ease;
    }

    .toolbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .toolbar-btn {
      flex: 1;
      min-width: 80px;
      max-width: 140px;
      text-align: center;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(178,144,90,0.4);
      background: rgba(255,255,255,0.9);
      font-size: 11px;
      cursor: pointer;
      font-family: "Noto Serif TC", serif;
      color: #6b5a4a;
      transition: all 0.2s;
    }
    .toolbar-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(178,144,90,0.4);
      background: rgba(255,255,255,0.9);
      font-size: 11px;
      cursor: pointer;
      font-family: "Noto Serif TC", serif;
      color: #6b5a4a;
      transition: all 0.2s;
    }
    .toolbar-btn:hover {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #fff;
      border-color: #d4af37;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 20px 40px;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      max-width: 900px;
      margin: 0 auto;
    }
    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
    }
    .left-col { display: flex; flex-direction: column; gap: 16px; }
    .right-col { display: flex; flex-direction: column; gap: 16px; }

    .section-card {
      background: rgba(255,255,255,0.75);
      border-radius: 14px;
      border: 1px solid rgba(178,144,90,0.18);
      padding: 16px 18px 14px;
      box-shadow: 0 6px 18px rgba(139,105,20,0.06);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .section-title {
      font-size: 16px;
      color: #8b6914;
      font-weight: 600;
      letter-spacing: 2px;
    }
    .section-subtitle {
      font-size: 11px;
      color: #a08060;
    }
    .section-body {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.1fr);
      gap: 12px;
    }
  
    @media (max-width: 768px) {
      .header-inner { 
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .header-left,
      .header-center,
      .header-right {
        justify-self: center;
        width: 100%;
      }
      .header-center {
        order: -1;
      }
      .period-card {
        grid-template-columns: 1fr;
        min-width: auto;
        max-width: 100%;
        gap: 8px;
      }
      .period-card .period-left {
        align-items: flex-start;
        text-align: left;
      }
      .period-card .period-info {
        justify-content: flex-start;
      }
      .period-card .period-right {
        text-align: left;
      }
      .clock {
        font-size: 20px;
        letter-spacing: 2px;
      }
      .title-main {
        font-size: 16px;
        letter-spacing: 3px;
      }
      .title-era {
        font-size: 13px;
      }
      .era-desc {
        font-size: 10px;
        max-width: 100%;
        text-align: center;
      }
      header {
        padding: 10px 12px;
      }
      .date-selector {
        justify-content: center;
      }
      .header-stats-wrapper {
        flex-direction: column;
        gap: 8px;
        align-items: center;
        width: 100%;
      }
      .header-stats-wrapper .daily-attr-standalone {
        flex-direction: row;
        gap: 8px;
        padding: 6px 12px;
        width: auto;
      }
      .header-stats-panel {
        flex-direction: column;
        gap: 8px;
        width: 100%;
        text-align: center;
        align-items: center;
      }
      .header-stat-row {
        justify-content: center;
      }
      .toolbar {
        padding: 6px 10px;
      }
      .toolbar-inner {
        justify-content: center;
      }
      .toolbar-btn {
        font-size: 10px;
        padding: 5px 8px;
        flex: 0 1 auto;
        min-width: 60px;
        max-width: none;
      }
      main { padding: 12px 10px 28px; }
      .section-body { grid-template-columns: 1fr; }
    }

    .panel {
      background: rgba(255,255,255,0.85);
      border-radius: 10px;
      border: 1px solid rgba(178,144,90,0.16);
      padding: 10px 10px 8px;
      font-size: 12px;
    }
    .panel-title {
      font-size: 12px;
      font-weight: 500;
      color: #6b5a4a;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .panel-title span.small {
      font-size: 10px;
      color: #a08060;
      font-weight: 400;
    }
    .form-row {
      display: flex;
      gap: 6px;
      margin-bottom: 3px;
      flex-wrap: wrap;
    }
    .form-row > * {
      flex: 1;
      min-width: 80px;
    }
    .label-small {
      font-size: 11px;
      color: #8b7355;
      margin-bottom: 2px;
      display: block;
    }
    .input, .select, .textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(178,144,90,0.4);
      background: rgba(255,255,255,0.95);
      font-family: "Noto Serif TC", serif;
      font-size: 12px;
      outline: none;
    }
/* ===== 行動裝置樣式調整 ===== */
@media (max-width: 768px) {

  .input,
  .select,
  .textarea {
    padding: 4px 6px;
    border-radius: 4px;
  }

  .notepad-content {
    padding: 8px;
    line-height: 1.6;
  }
}
 /* 閱讀項目進度條在移動端的調整 */
  .read-project-item {
    padding: 8px 10px;
  }
  .read-project-update {
    flex-wrap: wrap;
  }
  .read-project-update input {
    width: 60px;
  }

  /* 閱讀項目進度條樣式 */
    .read-project-item {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(178,144,90,0.25);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }
    .read-project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .read-project-name {
      font-size: 13px;
      font-weight: 500;
      color: #5c4d3d;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .read-project-name .done-badge {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #fff;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 999px;
    }
    .read-project-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .read-project-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .progress-bar-wrap {
      flex: 1;
      height: 8px;
      background: rgba(178,144,90,0.15);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #d4af37, #e8c848);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .progress-bar-fill.complete {
      background: linear-gradient(90deg, #4a7c59, #5d9a6e);
    }
    .progress-text {
      font-size: 11px;
      color: #8b7355;
      min-width: 70px;
      text-align: right;
    }
    .read-project-update {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }
    .read-project-update input {
      width: 70px;
      padding: 3px 6px;
      font-size: 11px;
    }
    .read-project-update button {
      padding: 3px 8px;
      font-size: 10px;
    }
    .read-project-item.is-done {
      background: linear-gradient(135deg, rgba(212,175,55,0.08), rgba(255,255,255,0.9));
      border-color: rgba(212,175,55,0.4);
    }

    .textarea {
      min-height: 60px;
      resize: vertical;
    }
    .input:focus, .select:focus, .textarea:focus {
      border-color: #d4af37;
      box-shadow: 0 0 0 1px rgba(212,175,55,0.3);
    }
    .btn {
      border-radius: 6px;
      border: none;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: "Noto Serif TC", serif;
    }
    .btn-primary {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #fff;
    }
    .btn-ghost {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(178,144,90,0.4);
      color: #6b5a4a;
    }
    .btn-danger {
      background: transparent;
      border: 1px solid #c04040;
      color: #c04040;
    }

    .formula-block {
      background: rgba(250,246,236,0.9);
      border-radius: 8px;
      padding: 6px 8px;
      border: 1px dashed rgba(178,144,90,0.5);
      margin-bottom: 6px;
      font-size: 11px;
      color: #6b5a4a;
      line-height: 1.5;
    }
/* 謄錄經典項目緊湊樣式 */
    .read-projects-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    .read-project-item-compact {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(178,144,90,0.25);
      border-radius: 6px;
      padding: 8px;
    }
    .read-project-item-compact.is-done {
      background: linear-gradient(135deg, rgba(212,175,55,0.08), rgba(255,255,255,0.9));
      border-color: rgba(212,175,55,0.4);
    }
    .read-project-header-compact {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .read-project-name-compact {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #5c4d3d;
    }
    .done-badge-small {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #fff;
      font-size: 8px;
      padding: 1px 4px;
      border-radius: 999px;
    }
    .btn-del-small {
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 3px;
      border: 1px solid #c04040;
      background: transparent;
      color: #c04040;
      cursor: pointer;
    }
    .read-project-progress-compact {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .progress-bar-wrap-compact {
      flex: 1;
      height: 6px;
      background: rgba(178,144,90,0.15);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-text-compact {
      font-size: 10px;
      color: #8b7355;
      min-width: 45px;
      text-align: right;
    }
    .read-project-update-compact {
      display: flex;
      gap: 4px;
    }
    .read-project-update-compact input {
      flex: 1;
      padding: 2px 4px;
      font-size: 10px;
    }
    .read-project-update-compact button {
      padding: 2px 6px;
      font-size: 9px;
    }

    @media (max-width: 500px) {
      .read-projects-grid {
        grid-template-columns: 1fr;
      }
    }

/* 內嵌記錄區塊統一風格 */
    .record-block {
      margin: 8px 0;
      padding: 8px;
      background: rgba(250,246,236,0.6);
      border-radius: 6px;
      border: 1px solid rgba(178,144,90,0.2);
    }
    .record-block .panel-title {
      margin-bottom: 6px;
    }

    .formula-highlight {
      color: #8b6914;
      font-weight: 600;
    }
    .value-positive { color: #4a7c59; }
    .value-neutral { color: #b8860b; }
    .value-negative { color: #a04040; }
    .tag-pill {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(212,175,55,0.1);
      color: #8b6914;
      border: 1px solid rgba(212,175,55,0.4);
    }
    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .badge-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(178,144,90,0.4);
      font-size: 10px;
      cursor: pointer;
    }
    .badge-item input {
      width: 12px;
      height: 12px;
      cursor: pointer;
    }
    .badge-item.badge-on {
      background: linear-gradient(135deg, rgba(212,175,55,0.18), rgba(255,255,255,0.9));
      border-color: rgba(212,175,55,0.7);
      box-shadow: 0 0 0 1px rgba(212,175,55,0.4);
    }
    .badge-item .btn-edit, .badge-item .btn-del {
      font-size: 9px;
      padding: 1px 4px;
      margin-left: 2px;
      cursor: pointer;
      border-radius: 3px;
      border: 1px solid rgba(178,144,90,0.3);
      background: rgba(255,255,255,0.8);
    }
    .badge-item .btn-del { border-color: #c04040; color: #c04040; }

    .summary-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      font-size: 12px;
      margin: 2px 0;
    }
    .summary-main {
      font-size: 12px;
      font-weight: 500;
      color: #6b5a4a;
    }
    .summary-main span.value {
      font-size: 14px;
      margin-left: 3px;
    }
    .summary-sub {
      font-size: 12px;
      color: #a08060;
    }
    .gray-note {
      display: none;
    }
    /* === 新版公式展示 === */
    .hero-stats {
      display: flex;
      gap: 16px;
      align-items: baseline;
      flex-wrap: wrap;
      padding: 6px 0;
      border-bottom: 1px solid rgba(178,144,90,0.15);
      margin-bottom: 6px;
    }
    .hero-stat {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }
    .hero-stat-label {
      font-size: 12px;
      color: #8b6914;
      font-weight: 500;
    }
    .hero-stat-value {
      font-size: 22px;
      font-weight: 700;
      color: #8b6914;
    }
    .hero-stat-sub {
      font-size: 11px;
      color: #a08060;
    }
    .formula-detail {
      font-size: 11px;
      color: #6b5a4a;
      line-height: 1.6;
      padding: 2px 0;
    }
    .formula-detail .vh {
      font-size: 15px;
      font-weight: 700;
      color: #8b6914;
    }
    .formula-detail .op {
      color: #a08060;
      margin: 0 2px;
    }
    .trend-wrap {
      margin-top: 12px;
      padding: 6px 8px;
      background: rgba(255,255,255,0.6);
      border-radius: 8px;
      border: 1px solid rgba(178,144,90,0.1);
    }
    .trend-title {
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      color: #6b5a4a;
      margin-bottom: 6px;
    }
    .trend-hdr {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
      align-items: center;
    }
    .trend-hdr select, .trend-hdr input[type="date"] {
      font-size: 10px;
      padding: 2px 4px;
      border: 1px solid rgba(178,144,90,0.3);
      border-radius: 4px;
      background: #fff;
      color: #5c4d3d;
      font-family: "Noto Serif TC", serif;
    }
    .trend-hdr input[type="date"] {
      width: 115px;
    }
    .trend-hdr .trend-date-sep {
      font-size: 10px;
      color: #a08060;
    }
    .trend-summary {
      font-size: 10px;
      color: #8b6914;
      font-weight: 500;
      width: 100%;
      text-align: right;
    }
    .trend-canvas {
      width: 100%;
      height: 110px;
    }
    .tip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 15px;
      height: 15px;
      font-size: 9px;
      color: #a08060;
      border: 1px solid rgba(178,144,90,0.3);
      border-radius: 50%;
      cursor: help;
      position: relative;
      vertical-align: middle;
      margin-left: 4px;
    }
    .tip-icon:hover::after {
      content: attr(data-tip);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #3a3020;
      color: #f5f0e0;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 10px;
      white-space: normal;
      z-index: 100;
      min-width: 180px;
      max-width: 300px;
      width: max-content;
      line-height: 1.5;
      text-align: center;
      word-break: break-word;
    }

    .mini-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }
    .mini-table th, .mini-table td {
      padding: 2px 4px;
      border-bottom: 1px solid rgba(178,144,90,0.15);
      text-align: right;
    }
    .mini-table th:first-child,
    .mini-table td:first-child { text-align: left; }
    .mini-table .actions-cell { text-align: center; }
    .mini-table .btn-edit, .mini-table .btn-del {
      font-size: 9px;
      padding: 1px 4px;
      cursor: pointer;
      border-radius: 3px;
      border: 1px solid rgba(178,144,90,0.3);
      background: rgba(255,255,255,0.8);
      margin: 0 1px;
    }
    .mini-table .btn-del { border-color: #c04040; color: #c04040; }

    .pill-offer {
      font-size: 10px;
      /* 去除膠囊外框與背景，只保留輕微對齊用的間距 */
      padding: 0;
      border-radius: 0;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      flex-shrink: 0;
    }


    /* Modal 彈窗 */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(60,50,40,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(3px);
    }
    .modal {
      background: linear-gradient(135deg, #fffef8, #f8f4e8);
      border-radius: 12px;
      padding: 16px 18px;
      border: 1px solid rgba(178,144,90,0.4);
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 {
      margin: 0 0 12px;
      font-size: 15px;
      color: #6b5a4a;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-top: 6px;
    }
    .calendar-cell {
      padding: 4px;
      border-radius: 6px;
      border: none;
      font-size: 11px;
      background: rgba(255,255,255,0.9);
      cursor: pointer;
      font-family: "Noto Serif TC", serif;
    }
    .calendar-cell.today {
      border: 1px solid rgba(212,175,55,0.8);
    }
    .calendar-cell.selected {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #fff;
      font-weight: 500;
    }
    .calendar-cell.has-data {
      background: rgba(212,175,55,0.15);
    }
    .calendar-cell.has-data {
  background: rgba(212,175,55,0.15);
}
.calendar-weekday {
  font-size: 10px;
  color: #a08060;
  text-align: center;
  padding: 2px;
}

/* 月經紅點標記 */
.calendar-cell.period-day {
  position: relative;
}
.calendar-cell.period-day::after {
  content: '';
  position: absolute;
  bottom: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #e57373;
}
.calendar-cell.period-predict {
  position: relative;
}
.calendar-cell.period-predict::after {
  content: '';
  position: absolute;
  bottom: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(229, 115, 115, 0.4);
  border: 1px dashed #e57373;
}

    /* 動態軸 */
    .timeline-card {
      background: rgba(255,255,255,0.75);
      border-radius: 14px;
      border: 1px solid rgba(178,144,90,0.18);
      padding: 12px;
    }
    .timeline-header {
      font-size: 13px;
      color: #8b6914;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .timeline-post-area {
      margin-bottom: 10px;
    }
    .timeline-post-area .textarea {
      font-size: 11px;
      min-height: 50px;
    }
    .timeline-post-area .post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 6px;
    }
    .timeline-post-area .image-preview {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .timeline-post-area .image-preview img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }
    .timeline-post-area .image-preview .img-wrap {
      position: relative;
    }
    .timeline-post-area .image-preview .img-del {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #c04040;
      color: #fff;
      font-size: 8px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .timeline-body {
      max-height: 500px;
      overflow-y: auto;
      position: relative;
      padding-left: 20px;
    }
    .timeline-body::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: repeating-linear-gradient(
        to bottom,
        rgba(178,144,90,0.3) 0px,
        rgba(178,144,90,0.3) 4px,
        transparent 4px,
        transparent 8px
      );
    }
 .timeline-item {
      position: relative;
      margin-bottom: 12px;
      padding: 8px 50px 8px 10px;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      border: 1px solid rgba(178,144,90,0.15);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -17px;
      top: 12px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #d4af37;
      border: 2px solid #fff;
    }
    .timeline-item .time-label {
      font-size: 10px;
      color: #a08060;
      margin-bottom: 4px;
      cursor: pointer;
    }
    .timeline-item .content {
      font-size: 11px;
      color: #5c4d3d;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .timeline-item .images {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .timeline-item .images img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      cursor: zoom-in;
    }
    .timeline-item .item-actions {
      position: absolute;
      top: 6px;
      right: 8px;
      display: flex;
      gap: 4px;
    }
    .timeline-item .tag-dots {
      display: flex;
      gap: 3px;
      margin-left: 8px;
    }
    .tag-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .tag-dot.yellow { background: #f0c040; }
    .tag-dot.orange { background: #e07020; }
    .tag-dot.red { background: #c04040; }
    .tag-dot.empty { background: transparent; border: 1px dashed #aaa; }

    /* 動態軸原地編輯 */
    .timeline-item .inline-edit-form {
      display: none;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed rgba(178,144,90,0.3);
    }
    .timeline-item .inline-edit-form.active {
      display: block;
    }
    .timeline-item .inline-edit-form textarea {
      width: 100%;
      min-height: 60px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(178,144,90,0.4);
      background: rgba(255,255,255,0.95);
      font-family: "Noto Serif TC", serif;
      font-size: 11px;
      resize: vertical;
    }
    .timeline-item .inline-edit-form textarea:focus {
      outline: none;
      border-color: #d4af37;
    }
    .timeline-item .inline-edit-form .edit-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      justify-content: flex-end;
    }
    .timeline-item .inline-edit-images {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .timeline-item .inline-edit-images .img-wrap {
      position: relative;
    }
    .timeline-item .inline-edit-images img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }
    .timeline-item .inline-edit-images .img-del {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #c04040;
      color: #fff;
      font-size: 7px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 發佈彈窗圖片預覽 - 縮小尺寸 */
    #timelineImagePreview {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    #timelineImagePreview .img-wrap {
      position: relative;
    }
    #timelineImagePreview .img-wrap img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }
    #timelineImagePreview .img-del {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #c04040;
      color: #fff;
      font-size: 8px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 記事本彈窗內容 */
    .notepad-toolbar {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .notepad-toolbar button {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid rgba(178,144,90,0.3);
      background: rgba(255,255,255,0.9);
      cursor: pointer;
    }
    .notepad-toolbar button.active {
      background: rgba(212,175,55,0.2);
      border-color: #d4af37;
    }
    .notepad-content {
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(255,255,255,0.95);
      border-radius: 6px;
      border: 1px solid rgba(178,144,90,0.2);
      font-size: 12px;
      line-height: 1.6;
    }
    .notepad-content ul,
    .notepad-content ol {
      margin: 2px 0;
      padding-left: 12px;
      -webkit-padding-start: 12px;
    }
    .notepad-content li {
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    .notepad-content:focus {
      outline: none;
      border-color: #d4af37;
    }
    .notepad-content .tag-inline {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      vertical-align: middle;
      margin: 0 2px;
    }

    /* 日結屬性 */
    .daily-attr-card {
      background: rgba(255,255,255,0.75);
      border-radius: 14px;
      border: 1px solid rgba(178,144,90,0.18);
      padding: 12px;
    }
    .daily-attr-header {
      font-size: 13px;
      color: #8b6914;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .daily-attr-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      background: rgba(250,246,236,0.9);
      border-radius: 6px;
      margin-bottom: 6px;
    }
    .daily-attr-row .attr-name {
      font-size: 12px;
      color: #6b5a4a;
    }
    .daily-attr-row .attr-value {
      font-size: 14px;
      font-weight: 600;
    }
    .clean-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 8px;
      background: rgba(255,255,255,0.6);
      border-radius: 5px;
      margin-bottom: 4px;
    }
    .clean-row span { font-size: 11px; color: #5c4d3d; }
    .clean-row select {
      font-size: 10px;
      padding: 3px 5px;
    }

    /* 獎杯一覽 */
    .trophy-card {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 7px;
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(178,144,90,0.15);
    }
    .trophy-card.unlocked {
      background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(255,255,255,0.8));
      border-color: rgba(212,175,55,0.3);
    }
    .trophy-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .trophy-icon {
      font-size: 18px;
    }
    .trophy-name {
      font-size: 13px;
      font-weight: 500;
      color: #8b6914;
    }
    .trophy-date {
      font-size: 10px;
      color: #a08060;
    }
    .trophy-conditions label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: #6b5a4a;
      padding: 2px 0;
      cursor: pointer;
    }
    .trophy-conditions input {
      width: 12px;
      height: 12px;
    }

    /* 轉盤 */
    .spinner-wheel {
      width: 220px;
      height: 220px;
      margin: 0 auto 16px;
      position: relative;
    }
    .spinner-circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid #d4af37;
      position: relative;
    }
    .spinner-pointer {
      position: absolute;
      top: -7px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 9px solid transparent;
      border-right: 9px solid transparent;
      border-top: 16px solid #8b6914;
      z-index: 10;
    }
    .spinner-avatar {
      position: absolute;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b6914, #a67c00);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .spinner-result {
      text-align: center;
      min-height: 60px;
      margin-bottom: 8px;
    }
    .spinner-locked {
      text-align: center;
      padding: 30px;
      color: #a08060;
      font-size: 12px;
    }

    /* 閱讀項目進度條樣式 */
    .read-project-item {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(178,144,90,0.25);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }
    .read-project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .read-project-name {
      font-size: 13px;
      font-weight: 500;
      color: #5c4d3d;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .read-project-name .done-badge {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #fff;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 999px;
    }
    .read-project-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .read-project-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .progress-bar-wrap {
      flex: 1;
      height: 8px;
      background: rgba(178,144,90,0.15);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #d4af37, #e8c848);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .progress-bar-fill.complete {
      background: linear-gradient(90deg, #4a7c59, #5d9a6e);
    }
    .progress-text {
      font-size: 11px;
      color: #8b7355;
      min-width: 70px;
      text-align: right;
    }
    .read-project-update {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }
    .read-project-update input {
      width: 70px;
      padding: 3px 6px;
      font-size: 11px;
    }
    .read-project-update button {
      padding: 3px 8px;
      font-size: 10px;
    }
    .read-project-item.is-done {
      background: linear-gradient(135deg, rgba(212,175,55,0.08), rgba(255,255,255,0.9));
      border-color: rgba(212,175,55,0.4);
    }

    /* 月經助手樣式 - Header左側卡片 */
    .period-card {
      background: linear-gradient(135deg, #fff5f5, #ffe8e8);
      border: 1px solid rgba(192, 100, 100, 0.25);
      border-radius: 10px;
      padding: 10px 14px;
      box-shadow: 0 3px 10px rgba(192, 100, 100, 0.1);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
      min-width: 280px;
      max-width: 340px;
    }
    .period-card .period-left {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .period-card .period-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .period-card .period-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e57373, #c04040);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 12px;
      flex-shrink: 0;
    }
    .period-card .period-title {
      font-size: 11px;
      font-weight: 500;
      color: #8b5a5a;
    }
    .period-card .period-status {
      font-size: 10px;
      color: #5c3d3d;
      line-height: 1.4;
    }
    .period-card .period-info {
      display: flex;
      gap: 10px;
      font-size: 9px;
      color: #a06060;
      justify-content: flex-start;
    }
    .period-card .period-info-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .period-card .period-info-item .info-value {
      font-size: 12px;
      font-weight: 600;
      color: #c04040;
    }
    .period-card .period-right {
      background: rgba(255,255,255,0.7);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 10px;
      color: #5c3d3d;
      line-height: 1.5;
      min-height: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .period-card .period-right .msg-from {
      font-size: 9px;
      color: #a06060;
      margin-bottom: 3px;
    }
    .period-card.no-data {
      opacity: 0.7;
    }
    .period-card.no-data .period-right {
      display: none;
    }

.back-to-top {
      position: fixed;
      right: 16px;
      bottom: 20px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      padding: 0;
      display: none;                 /* 預設隱藏，捲動後才顯示 */
      align-items: center;
      justify-content: center;
      font-size: 18px;               /* 箭頭大小 */
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      color: #a08060;
      cursor: pointer;
      z-index: 60;
    }
    .back-to-top.show {
      display: flex;
    }


/* 金風玉露面板 */
    .romance-char-tab {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(178,144,90,0.3);
      background: rgba(255,255,255,0.9);
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .romance-char-tab.active {
      background: linear-gradient(135deg, #d4af37, #b8960c);
      color: #fff;
      border-color: #d4af37;
    }
    .romance-char-tab.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .romance-char-tab .char-avatar-small {
      width: 20px;
      height: 20px;
      min-width: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b6914, #a67c00);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 10px;
      flex-shrink: 0;
      aspect-ratio: 1;
    }
    
    .romance-panel {
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 14px;
      border: 1px solid rgba(178,144,90,0.2);
    }
    .romance-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(178,144,90,0.15);
      flex-wrap: wrap;
    }
    .romance-avatar {
      width: 50px;
      height: 50px;
      min-width: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b6914, #a67c00);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 20px;
      font-weight: 500;
      flex-shrink: 0;
      aspect-ratio: 1;
    }
    .romance-info h4 {
      margin: 0 0 4px;
      font-size: 15px;
      color: #8b6914;
    }
    .romance-info .subtitle {
      font-size: 11px;
      color: #a08060;
    }
    .romance-stats {
      display: flex;
      gap: 16px;
      margin-left: auto;
      text-align: center;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .romance-stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .romance-stat-item .stat-label {
      font-size: 10px;
      color: #a08060;
      white-space: nowrap;
    }
    .romance-stat-item .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #8b6914;
    }
    
.romance-story-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .romance-story-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      background: rgba(250,246,236,0.8);
      border: 1px solid rgba(178,144,90,0.15);
    }
    .romance-story-item.unlocked {
      background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(255,255,255,0.9));
      border-color: rgba(212,175,55,0.4);
    }
    .romance-story-item.available {
      border-color: rgba(74,124,89,0.5);
      background: rgba(74,124,89,0.08);
    }
    .romance-story-item.blocked-overlay {
      position: relative;
      opacity: 0.5;
      pointer-events: none;
    }
    .romance-story-item.blocked-overlay::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(200,200,200,0.35);
      border-radius: 6px;
      background-image: linear-gradient(
        to bottom right,
        transparent calc(50% - 1px),
        #555 calc(50% - 1px),
        #555 calc(50% + 1px),
        transparent calc(50% + 1px)
      );
    }
    .romance-story-item.be {
      background: rgba(192,64,64,0.08);
      border-color: rgba(192,64,64,0.3);
    }
    .romance-story-item.be.unlocked {
      background: rgba(192,64,64,0.15);
    }
    .story-icon {
      font-size: 16px;
      width: 24px;
      text-align: center;
    }
    .story-content {
      flex: 1;
    }
    .story-title {
      font-size: 12px;
      font-weight: 500;
      color: #5c4d3d;
    }
    .story-title.locked { color: #999; }
    .story-date {
      font-size: 10px;
      color: #a08060;
      margin-top: 2px;
    }
    .story-conditions {
      font-size: 9px;
      margin-top: 4px;
      line-height: 1.4;
    }
    .cond-met { color: #4a7c59; }
    .cond-unmet { color: #999; }
    .cond-be-met { color: #c04040; }
    .cond-be-unmet { color: #3d3529; }
    .story-unlock-btn {
      font-size: 10px;
      padding: 3px 8px;
    }
.story-row {
      display: flex;
      gap: 8px;
      margin-bottom: 0;
    }
    .story-row .romance-story-item {
      flex: 1;
      margin-bottom: 0;
    }
  .romance-story-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .romance-story-list > .story-row,
    .romance-story-list > .romance-story-item {
      margin-bottom: 0;
    }
    
    .romance-spinner-section {
      text-align: center;
      padding: 12px;
    }
    .romance-spinner-locked {
      color: #a08060;
      font-size: 12px;
      padding: 20px;
    }
    .romance-result-card {
      background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(255,255,255,0.9));
      border-radius: 10px;
      padding: 14px;
      margin-top: 12px;
      border: 1px solid rgba(212,175,55,0.3);
    }
    .affinity-formula {
      font-size: 11px;
      color: #6b5a4a;
      background: rgba(250,246,236,0.9);
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
      text-align: left;
    }

    /* 圖片大圖 */
    .image-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: zoom-out;
    }
    .image-overlay img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 8px;
    }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: rgba(178,144,90,0.1); }
    ::-webkit-scrollbar-thumb { background: rgba(178,144,90,0.3); border-radius: 3px; }
  
/* === V5 新增：Toggle 按鈕 === */
.body-toggle-area {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}
.body-toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 12px;
  border-radius: 16px;
  border: 1.5px solid rgba(178,144,90,0.3);
  background: rgba(255,255,255,0.6);
  font-family: "Noto Serif TC", serif;
  font-size: 11px;
  color: #8b6914;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
}
.body-toggle-btn:hover { background: rgba(250,246,236,0.9); }
.body-toggle-btn.active {
  background: linear-gradient(135deg, #c04040, #d46060);
  color: #fff;
  border-color: #c04040;
}
.body-toggle-btn.mast-active {
  background: linear-gradient(135deg, #7b68ae, #9080c0);
  color: #fff;
  border-color: #7b68ae;
}
.body-toggle-btn.bowel-active {
  background: linear-gradient(135deg, #3a8a3a, #50a050);
  color: #fff;
  border-color: #3a8a3a;
}
.body-toggle-btn.sleep-active {
  background: linear-gradient(135deg, #3a4a7a, #506090);
  color: #fff;
  border-color: #3a4a7a;
}
.body-toggle-btn.wake-active {
  background: linear-gradient(135deg, #c08a10, #d4a020);
  color: #fff;
  border-color: #c08a10;
}

/* === V5 新增：多次記錄輸入區 === */
.multi-record-area {
  margin: 3px 0;
  padding: 4px 10px;
  background: transparent;
  border-radius: 6px;
  border: none;
}
.multi-record-area .panel-title { margin-bottom: 2px; }
.multi-record-row {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-bottom: 2px;
  flex-wrap: wrap;
}
.multi-record-row .input { flex: 1; min-width: 60px; }
.multi-record-row .select { flex: 0 0 auto; width: auto; min-width: 70px; }
.multi-record-row .btn { flex: 0 0 auto; font-size: 10px; padding: 3px 10px; }

/* === V5 新增：記錄Log表格 === */
#lifeLogTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
  margin-top: 8px;
}
#lifeLogTable th {
  background: rgba(178,144,90,0.1);
  color: #8b6914;
  font-weight: 500;
  padding: 4px 6px;
  text-align: left;
  font-size: 10px;
}
#lifeLogTable td {
  padding: 3px 6px;
  border-bottom: 1px solid rgba(178,144,90,0.1);
  color: #5c4d3d;
}
#lifeLogTable .btn-del {
  background: none;
  border: none;
  color: #c04040;
  cursor: pointer;
  font-size: 11px;
  padding: 1px 4px;
}

/* 統一聯絡客戶和雅客宴遊的記錄Log樣式，與組織經營一致 */
#jobTable,
#thesisTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
  margin-top: 8px;
}
#jobTable th,
#thesisTable th {
  background: rgba(178,144,90,0.1);
  color: #8b6914;
  font-weight: 500;
  padding: 4px 6px;
  text-align: left;
  font-size: 10px;
}
#jobTable td,
#thesisTable td {
  padding: 3px 6px;
  border-bottom: 1px solid rgba(178,144,90,0.1);
  color: #5c4d3d;
}
#jobTable .btn-del,
#thesisTable .btn-del,
#jobTable .btn-edit,
#thesisTable .btn-edit {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 11px;
  padding: 1px 4px;
}
#jobTable .btn-del,
#thesisTable .btn-del {
  color: #c04040;
}
#moneyTable,
#fictionTable,
#readTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
  margin-top: 8px;
}
#moneyTable th,
#fictionTable th,
#readTable th {
  background: rgba(178,144,90,0.1);
  color: #8b6914;
  font-weight: 500;
  padding: 4px 6px;
  text-align: left;
  font-size: 10px;
}
#moneyTable td,
#fictionTable td,
#readTable td {
  padding: 3px 6px;
  border-bottom: 1px solid rgba(178,144,90,0.1);
  color: #5c4d3d;
}
#moneyTable .btn-del,
#fictionTable .btn-del,
#readTable .btn-del,
#moneyTable .btn-edit,
#fictionTable .btn-edit,
#readTable .btn-edit {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 11px;
  padding: 1px 4px;
}
#moneyTable .btn-del,
#fictionTable .btn-del,
#readTable .btn-del {
  color: #c04040;
}

/* === V5 新增：店鋪狀態四欄佈局 === */
.shop-status-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  padding: 12px;
}
.shop-status-panel {
  background: rgba(255,255,255,0.7);
  border: 1px solid rgba(178,144,90,0.2);
  border-radius: 8px;
  padding: 10px;
  min-height: 200px;
}
.shop-status-panel h4 {
  margin: 0 0 8px;
  font-size: 12px;
  color: #8b6914;
  border-bottom: 1px solid rgba(178,144,90,0.15);
  padding-bottom: 4px;
}
.shop-status-panel .notepad-content {
  min-height: 120px;
  max-height: 300px;
  overflow-y: auto;
}
.shop-status-panel .timeline-body {
  max-height: 300px;
  overflow-y: auto;
}

/* === V5 新增：即時動態區（發佈+動態軸合併） === */
.instant-feed-section {
  width: 100%;
}
.instant-feed-post {
  margin-bottom: 12px;
  padding: 10px;
  background: rgba(250,246,236,0.6);
  border-radius: 8px;
  border: 1px solid rgba(178,144,90,0.2);
}
.instant-feed-post textarea {
  width: 100%;
  min-height: 80px;
  border: 1px solid rgba(178,144,90,0.2);
  border-radius: 6px;
  padding: 8px;
  font-size: 12px;
  resize: vertical;
  background: #fffef8;
  color: #5c4d3d;
  box-sizing: border-box;
}

/* === V5 新增：記事本增強 === */
.notepad-toolbar button[data-cmd="underline"] { text-decoration: underline; }

/* 響應式 */
@media (max-width: 900px) {
  .shop-status-grid {
    grid-template-columns: 1fr 1fr;
  }
}
@media (max-width: 600px) {
  .shop-status-grid {
    grid-template-columns: 1fr;
  }
}

</style>
</head>
<body>
    <header>
    <div class="header-inner">
      <!-- 左側：月經助手 -->
      <div class="header-left">
        <div class="body-toggle-area">
          <button id="periodToggleBtn" class="body-toggle-btn" title="標記今日月經">🌸 月經</button>
          <button id="mastToggleBtn" class="body-toggle-btn" title="標記今日自慰">💜 自慰</button>
          <button id="bowelToggleBtn" class="body-toggle-btn" title="標記今日排便">💚 排便</button>
          <div style="display:inline-flex;align-items:center;gap:4px;margin-left:4px;">
            <span style="font-size:11px;color:#8b7355;font-family:'Noto Serif TC',serif;">體重</span>
            <input id="weightQuickInput" type="number" step="0.1" class="input" style="width:56px;padding:3px 6px;font-size:11px;" placeholder="kg" />
          </div>
        </div>
        <div id="periodCard" class="period-card">
          <div class="period-left">
            <div class="period-header">
              <div class="period-icon">🌸</div>
              <div class="period-title">月經助手</div>
            </div>
            <div id="periodStatus" class="period-status">暫無記錄</div>
            <div class="period-info">
              <div class="period-info-item">
                <span class="info-value" id="periodLastEnd">--</span>
                <span>上次結束</span>
              </div>
              <div class="period-info-item">
                <span class="info-value" id="periodDaysSince">--</span>
                <span>已過天數</span>
              </div>
              <div class="period-info-item">
                <span class="info-value" id="periodPredict">--</span>
                <span>預計下次</span>
              </div>
            </div>
          </div>
          <div class="period-right" id="periodMessage">
            <div class="msg-from" id="periodMsgFrom">來自曹丕的關心</div>
            <div id="periodMsgText">「……」</div>
          </div>
        </div>
      </div>

      <!-- 中間：時間與標題 -->
      <div class="header-center">
        <div id="clock" class="clock"></div>
        <div id="dateText" class="date-text"></div>
        <div class="title-main">謀定鄴都 · <span id="eraText"></span></div>
        <div id="eraDesc" class="era-desc" style="text-align:center;max-width:100%;"></div>
      </div>

         <div class="header-right">
        <div class="date-selector">
          <button id="sleepQuickBtn" class="body-toggle-btn" title="記錄入睡" style="font-size:11px;padding:4px 10px;">🌙</button>
          <button id="wakeQuickBtn" class="body-toggle-btn" title="記錄起床" style="font-size:11px;padding:4px 10px;">☀️</button>
          <button id="prevDayBtn" class="btn btn-ghost" style="padding:4px 8px;font-size:11px;">◀ 昨日</button>
          <div id="datePill" class="date-pill">📅 <span id="datePillText"></span></div>
          <button id="nextDayBtn" class="btn btn-ghost" style="padding:4px 8px;font-size:11px;">明日 ▶</button>
        </div>
  <!-- 屬性一覽區域 → 改為下次頭銜解鎖提示 -->
        <div class="header-stats-area">
          <div id="nextTitlePanel" style="background:linear-gradient(135deg, rgba(255,254,248,0.97), rgba(250,243,225,0.95));border-radius:8px;border:1px solid rgba(178,144,90,0.25);padding:7px 10px;font-size:10px;max-height:160px;overflow-y:auto;position:relative;box-shadow:0 1px 4px rgba(139,105,20,0.06);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid rgba(178,144,90,0.12);">
              <div style="font-size:11px;color:#8b6914;font-weight:600;">📜 <span id="currentTitleLabel">下次可解鎖頭銜</span></div>
              <div style="display:flex;gap:4px;align-items:center;">
                <button id="titlePrevBtn" onclick="cycleTitlePage(-1)" style="border:none;background:none;cursor:pointer;font-size:10px;color:#8b6914;padding:0 2px;">◀</button>
                <span id="titlePageIndicator" style="font-size:9px;color:#a08060;">1/1</span>
                <button id="titleNextBtn" onclick="cycleTitlePage(1)" style="border:none;background:none;cursor:pointer;font-size:10px;color:#8b6914;padding:0 2px;">▶</button>
              </div>
            </div>
            <div id="nextTitleContent" style="line-height:1.5;"></div>
          </div>
        </div>
  </header>

  <!-- 工具按鈕欄 -->
  <div class="toolbar">
    <div class="toolbar-inner">
      <button onclick="document.getElementById('section-life').scrollIntoView({behavior:'smooth'})" class="toolbar-btn" style="font-size:10px;">組織經營</button>
      <button onclick="document.getElementById('section-money').scrollIntoView({behavior:'smooth'})" class="toolbar-btn" style="font-size:10px;">財務管理</button>
      <button onclick="document.getElementById('section-job').scrollIntoView({behavior:'smooth'})" class="toolbar-btn" style="font-size:10px;">聯絡客戶</button>
      <button onclick="document.getElementById('section-reading').scrollIntoView({behavior:'smooth'})" class="toolbar-btn" style="font-size:10px;">謄錄經典</button>
      <button onclick="document.getElementById('section-thesis').scrollIntoView({behavior:'smooth'})" class="toolbar-btn" style="font-size:10px;">雅客宴遊</button>
      <button onclick="document.getElementById('section-fiction').scrollIntoView({behavior:'smooth'})" class="toolbar-btn" style="font-size:10px;">新書發布</button>
      <button id="btnFeedViewer" class="toolbar-btn">今日動態</button>
      <button id="btnTrophies" class="toolbar-btn">獎盃一覽</button>
      <button id="btnSpinner" class="toolbar-btn">金風玉露</button>
      <button id="btnAffinity" class="toolbar-btn">好感度轉盤</button>
      <button id="btnTrendViewer" class="toolbar-btn">圖策天下</button>
      <button id="btnDataManager" class="toolbar-btn">數據管理</button>
    </div>
  </div>

  <!-- 吴质助手弹窗 -->
  <div id="wuZhiToast" style="position:fixed;bottom:28px;left:28px;background:#fffef8;border:1px solid rgba(178,144,90,0.3);border-radius:12px;padding:12px 16px;box-shadow:0 6px 20px rgba(139,105,20,0.15);z-index:100;max-width:240px;display:none;">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#b8960c);display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:500;">質</div>
      <div>
        <div style="font-size:10px;color:#a08060;">助手吳質</div>
        <div id="wuZhiMessage" style="font-size:12px;color:#5c4d3d;"></div>
      </div>
    </div>
  </div>

  <!-- 角色问候弹窗 -->
  <div id="charToast" style="position:fixed;top:100px;right:28px;background:#fffef8;border:1px solid rgba(178,144,90,0.3);border-radius:12px;padding:12px 16px;box-shadow:0 6px 20px rgba(139,105,20,0.15);z-index:100;max-width:260px;display:none;">
    <div style="display:flex;align-items:flex-start;gap:10px;">
      <div id="charAvatar" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#8b6914,#a67c00);display:flex;align-items:center;justify-content:center;color:#fff;font-size:15px;font-weight:500;">丕</div>
      <div>
        <div id="charName" style="font-size:12px;color:#8b6914;font-weight:500;">曹丕</div>
        <div id="charTitle" style="font-size:10px;color:#a08060;margin-bottom:3px;">五官中郎將</div>
        <div id="charGreeting" style="font-size:12px;color:#5c4d3d;font-style:italic;">「……」</div>
      </div>
    </div>
  </div>

 <main>


        <!-- 店鋪狀態 -->
        <section class="section-card" id="section-shop-status">
          <div class="section-header">
            <div>
              <div class="section-title">店鋪狀態</div>
              <div class="section-subtitle">記事本・即時動態・家務・魅力氣質</div>
            </div>
          </div>
          <div>
            <div class="shop-status-grid">
              <!-- 第1欄：記事本 -->
              <div class="shop-status-panel">
                <h4>📝 計劃記事本</h4>
                <div class="notepad-toolbar" style="margin-bottom:4px;">
                  <button onclick="execNotepadCommand('bold')" title="粗體"><b>B</b></button>
                  <button onclick="execNotepadCommand('underline')" title="下劃線"><u>U</u></button>
                  <button onclick="execNotepadCommand('strikethrough')" title="刪除線"><s>S</s></button>
                  <button onclick="execNotepadCommand('foreColor','#000000')" title="黑色字體" style="color:#000;">A</button>
                  <button onclick="execNotepadCommand('foreColor','#c04040')" title="紅色" style="color:#c04040;">A</button>
                  <button onclick="execNotepadCommand('foreColor','#2060a0')" title="藍色" style="color:#2060a0;">A</button>
                  <button onclick="execNotepadCommand('foreColor','#308030')" title="綠色" style="color:#308030;">A</button>
                  <button onclick="execNotepadCommand('insertUnorderedList')" title="無序列表">•</button>
                  <button onclick="execNotepadCommand('insertOrderedList')" title="有序列表">1.</button>
                  <button onclick="document.execCommand('indent',false,null)" title="增加縮進">⇥</button>
                  <button onclick="document.execCommand('outdent',false,null)" title="減少縮進">⇤</button>
                  <button onclick="insertNotepadTag('yellow')" title="黃色標籤">🟡</button>
                  <button onclick="insertNotepadTag('orange')" title="橘色標籤">🟠</button>
                  <button onclick="insertNotepadTag('red')" title="紅色標籤">🔴</button>
                </div>
                <div id="shopNotepadContent" class="notepad-content" contenteditable="true" style="min-height:150px;"></div>
                <div style="font-size:9px;color:#a08060;margin-top:4px;">
                  自動保存｜標籤規則：在動態軸中點擊同色標籤＝已執行，魅力 = 執行÷計劃
                </div>
              </div>

              <!-- 第2欄：即時動態（僅輸入口） -->
              <div class="shop-status-panel" style="display:flex;flex-direction:column;">
                <h4>📰 即時動態</h4>
                <div class="instant-feed-post" style="flex:1;display:flex;flex-direction:column;">
                  <textarea id="shopTimelinePostText" placeholder="記錄此刻..." style="flex:1;min-height:180px;width:100%;box-sizing:border-box;font-size:12px;line-height:1.6;padding:8px;border:1px solid rgba(178,144,90,0.2);border-radius:6px;background:rgba(255,255,255,0.95);resize:vertical;"></textarea>
                  <div style="margin-top:4px;display:flex;gap:4px;align-items:center;">
                    <input type="file" id="shopTimelineImageInput" accept="image/*" multiple style="display:none;" />
                    <button id="shopTimelineImageBtn" class="btn btn-ghost" style="font-size:9px;padding:2px 6px;">📷 圖片</button>
                    <div id="shopTimelineImagePreview" class="image-preview" style="flex:1;"></div>
                    <button id="shopTimelinePostBtn" class="btn btn-primary" style="font-size:10px;padding:3px 10px;">發佈</button>
                  </div>
                </div>
              </div>

              <!-- 第3欄：家務（店鋪清潔） -->
              <div class="shop-status-panel">
                <h4>🧹 店鋪清潔（氣質）</h4>
                <div id="shopCleaningRows"></div>
              </div>

              <!-- 第4欄：魅力 + 氣質公式 -->
              <div class="shop-status-panel">
                <h4>💄 魅力・氣質</h4>
                <div style="margin-bottom:12px;">
                  <div style="font-size:11px;color:#8b6914;font-weight:500;margin-bottom:4px;">氣質（店鋪清潔分數）</div>
                  <div id="shopEleganceDisplay" style="font-size:20px;font-weight:600;color:#8b6914;">100</div>
                  <div id="shopEleganceFormula" style="font-size:10px;color:#6b5a4a;line-height:1.5;margin-top:4px;"></div>
                </div>
                <div style="margin-bottom:12px;">
                  <div style="font-size:11px;color:#8b6914;font-weight:500;margin-bottom:4px;">魅力（計劃執行率）</div>
                  <div id="shopCharmDisplay" style="font-size:20px;font-weight:600;color:#8b6914;">100</div>
                  <div id="shopCharmFormula" style="font-size:10px;color:#6b5a4a;line-height:1.5;margin-top:4px;"></div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- 組織經營（生活習慣） -->
        <section class="section-card" id="section-life">
          <div class="section-header">
            <div>
              <div class="section-title">組織經營</div>
              <div class="section-subtitle">生活習慣與身心健康｜基礎：德行　工具：起居錄　加權：風儀</div>
            </div>
          </div>
          <div class="section-body">
            <div class="panel">
              <div class="panel-title">當日習慣紀錄</div>

              <!-- 飲水記錄（選擇在前） -->
              <div class="multi-record-area">
                <div class="panel-title" style="margin-bottom:4px;">飲水記錄 <span class="small">每次記一筆自動累加｜累計：<strong id="lifeTotalWaterDisplay">0</strong> ml</span></div>
                <div class="multi-record-row">
                  <select id="lifeWaterType" class="select">
                    <option value="water">水</option>
                    <option value="juice">果汁飲料</option>
                    <option value="tea">茶奶咖啡</option>
                    <option value="alcohol">酒</option>
                  </select>
                  <input id="lifeWaterInput" type="number" class="input" placeholder="ml（如250）" />
                  <button id="lifeWaterAddBtn" class="btn btn-primary">添加</button>
                </div>
              </div>

              <!-- 營養評估（選擇在前） -->
              <div class="multi-record-area">
                <div class="panel-title" style="margin-bottom:4px;">營養評估 <span class="small">每餐記一筆累加｜累計：<strong id="lifeTotalNutritionDisplay">0</strong> 分</span></div>
                <div class="multi-record-row">
                  <select id="lifeNutritionMeal" class="select">
                    <option value="breakfast">早餐</option>
                    <option value="lunch">中餐</option>
                    <option value="dinner">晚餐</option>
                    <option value="snack">小食</option>
                  </select>
                  <input id="lifeNutritionInput" type="number" class="input" placeholder="分數（0-100）" />
                  <input id="lifeNutritionNote" type="text" class="input" placeholder="備註" style="flex:2;" />
                  <button id="lifeNutritionAddBtn" class="btn btn-primary">添加</button>
                </div>
              </div>

              <!-- 自我啟發（獨占一行） -->
              <div class="multi-record-area">
                <div class="panel-title" style="margin-bottom:4px;">自我啟發 <span class="small">累計：<strong id="lifeTotalSelfDevDisplay">0</strong> h</span></div>
                <div class="multi-record-row">
                  <input id="lifeSelfDevInput" type="number" step="0.5" class="input" placeholder="時數" />
                  <input id="lifeSelfDevNote" type="text" class="input" placeholder="備註" style="flex:2;" />
                  <button id="lifeSelfDevAddBtn" class="btn btn-primary">添加</button>
                </div>
              </div>

              <!-- 外出遊玩（獨占一行） -->
              <div class="multi-record-area">
                <div class="panel-title" style="margin-bottom:4px;">外出遊玩 <span class="small">累計：<strong id="lifeTotalOutingDisplay">0</strong> 次</span></div>
                <div class="multi-record-row">
                  <input id="lifeOutingInput" type="number" class="input" placeholder="次數" />
                  <input id="lifeOutingNote" type="text" class="input" placeholder="備註" style="flex:2;" />
                  <button id="lifeOutingAddBtn" class="btn btn-primary">添加</button>
                </div>
              </div>

              <!-- 專注於樂（獨占一行） -->
              <div class="multi-record-area">
                <div class="panel-title" style="margin-bottom:4px;">專注於樂 <span class="small">累計：<strong id="lifeTotalFunDisplay">0</strong> h</span></div>
                <div class="multi-record-row">
                  <input id="lifeFunInput" type="number" step="0.5" class="input" placeholder="時數" />
                  <input id="lifeFunNote" type="text" class="input" placeholder="備註" style="flex:2;" />
                  <button id="lifeFunAddBtn" class="btn btn-primary">添加</button>
                </div>
              </div>

              <!-- 空虛內耗（獨占一行） -->
              <div class="multi-record-area">
                <div class="panel-title" style="margin-bottom:4px;">空虛內耗 <span class="small">累計：<strong id="lifeTotalEmptyDisplay">0</strong> h</span></div>
                <div class="multi-record-row">
                  <input id="lifeEmptyInput" type="number" step="0.5" class="input" placeholder="時數" />
                  <input id="lifeEmptyNote" type="text" class="input" placeholder="備註" style="flex:2;" />
                  <button id="lifeEmptyAddBtn" class="btn btn-primary">添加</button>
                </div>
              </div>

              <!-- 入睡＋起床（補填用）＋深度護膚，三項並列 -->
              <div class="form-row" style="margin-top:6px;">
                <div>
                  <label class="label-small">入睡時間（24h・補填）</label>
                  <input id="lifeSleepTime" type="number" step="0.5" class="input" data-life-field="sleepTime" placeholder="如23.5" />
                </div>
                <div>
                  <label class="label-small">起床時間（24h・補填）</label>
                  <input id="lifeWakeTime" type="number" step="0.5" class="input" data-life-field="wakeTime" placeholder="如7" />
                </div>
                <div>
                  <label class="label-small">深度護膚（0–100）</label>
                  <input id="lifeSkin" type="number" class="input" data-life-field="skin" />
                </div>
              </div>

              <div style="text-align:right;margin-top:4px;">
                <button id="lifeSaveBtn" class="btn btn-primary">保存基本欄位</button>
              </div>
            </div>

            <div class="panel">
              <!-- 核心數值 -->
              <div class="hero-stats">
                <div class="hero-stat">
                  <span class="hero-stat-label">德行：</span>
                  <span class="hero-stat-value" id="lifeTodayScore">0</span>
                  <span class="hero-stat-sub">（累計：<span id="lifeTotalScore">0</span>）</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">起居錄：</span>
                  <span class="hero-stat-value" id="lifeStreak">0</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">風儀：</span>
                  <span class="hero-stat-value" id="lifeGrace">0.5</span>
                  <span class="tip-icon" data-tip="起居錄 < 15 → 0.5；≥15 且 ≤60 → 1；> 60 → 2">?</span>
                </div>
              </div>
              <!-- 計算公式 -->
              <div id="lifeFormula" class="formula-detail"></div>
              <!-- 記錄Log表格 -->
              <div style="margin-top:12px;">
                <div style="text-align:center;font-size:12px;font-weight:500;color:#6b5a4a;margin-bottom:6px;">今日記錄Log</div>
                <table id="lifeLogTable">
                  <thead><tr><th>項目</th><th>數值</th><th>備註</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <!-- 趨勢圖 -->
              <div class="trend-wrap">
                <div class="trend-title">數據趨勢圖</div>
                <div class="trend-hdr">
                  <select id="lifeTrendSelect">
                    <optgroup label="── 記錄細目 ──">
                      <option value="water">飲水量</option>
                      <option value="nutrition">營養評估</option>
                      <option value="selfDev">自我啟發</option>
                      <option value="fun">專注於樂</option>
                      <option value="outing">外出遊玩</option>
                      <option value="empty">空虛內耗</option>
                      <option value="weight">體重</option>
                      <option value="bowel">排便</option>
                      <option value="sleepTime">入睡時間</option>
                      <option value="wakeTime">起床時間</option>
                    </optgroup>
                    <optgroup label="── 基礎屬性 ──">
                      <option value="score">德行（日分）</option>
                    </optgroup>
                    <optgroup label="── 工具屬性 ──">
                      <option value="streak">起居錄</option>
                    </optgroup>
                    <optgroup label="── 加權屬性 ──">
                      <option value="grace">風儀</option>
                    </optgroup>
                  </select>
                  <select id="lifeTrendGroup">
                    <option value="day">按日</option>
                    <option value="week">按週</option>
                    <option value="month">按月</option>
                  </select>
                </div>
                <div class="trend-hdr">
                  <input type="date" id="lifeTrendFrom" />
                  <span class="trend-date-sep">至</span>
                  <input type="date" id="lifeTrendTo" />
                  <span class="trend-summary" id="lifeTrendSummary"></span>
                </div>
                <canvas id="lifeTrendCanvas" class="trend-canvas"></canvas>
              </div>
            </div>
          </div>
        </section>
        <!-- 財務管理 -->
        <section class="section-card" id="section-money">
          <div class="section-header">
            <div>
              <div class="section-title">財務管理</div>
              <div class="section-subtitle">理財意識｜基礎：財富　工具：聚寶盆　加權：逍遙</div>
            </div>
          </div>
          <div class="section-body">
            <div class="panel">
              <div class="panel-title">
                當日收支紀錄
                <span class="small">金額以日圓計算</span>
              </div>
              <div class="form-row">
                <div>
                  <label class="label-small">主類別</label>
                  <select id="moneyMainType" class="select">
                    <option value="dailyOut">日常支出</option>
                    <option value="basicOut">基本支出</option>
                    <option value="specialOut">特殊支出</option>
                    <option value="income">日常收入</option>
                  </select>
                </div>
                <div id="moneySubWrapper">
                  <label class="label-small">細項</label>
                  <select id="moneySubType" class="select">
                    <option value="food">外食外賣</option>
                    <option value="drink">咖啡飲料</option>
                    <option value="dessert">外食甜品</option>
                    <option value="fresh">生鮮果蔬</option>
                    <option value="snack">零食小吃</option>
                    <option value="life">生活用品</option>
                    <option value="entertain">娛樂支出</option>
                  </select>
                </div>
                <div>
                  <label class="label-small">金額</label>
                  <input id="moneyAmount" type="number" class="input" placeholder="輸入金額" />
                </div>
              </div>
              <div class="form-row" style="margin-top:4px;">
                <div style="flex:1;">
                  <label class="label-small">備註（選填）</label>
                  <input id="moneyNote" type="text" class="input" placeholder="具體內容說明" />
                </div>
                <div style="flex:0 0 auto;min-width:90px;">
                  <label class="label-small">錢包</label>
                  <select id="moneyWallet" class="select">
                    <option value="">不指定</option>
                    <option value="wechat">微信支付</option>
                    <option value="alipay">支付寶</option>
                    <option value="credit">信用卡</option>
                    <option value="cash">現金</option>
                    <option value="other">其他</option>
                  </select>
                </div>
              </div>
              <div style="text-align:right;margin-top:4px;">
                <button id="moneyAddBtn" class="btn btn-primary">加入今日紀錄</button>
              </div>
            </div>

            <div class="panel">
              <div class="hero-stats">
                <div class="hero-stat">
                  <span class="hero-stat-label">財富：</span>
                  <span class="hero-stat-value" id="moneyTodayScore">0</span>
                  <span class="hero-stat-sub">（累計：<span id="moneyTotalScore">0</span>）</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">聚寶盆：</span>
                  <span class="hero-stat-value" id="moneyStreak">0</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">逍遙：</span>
                  <span class="hero-stat-value" id="moneyFreedom">0.5</span>
                  <span class="tip-icon" data-tip="聚寶盆 < 15 → 0.5；≥15 且 ≤60 → 1；> 60 → 2">?</span>
                </div>
              </div>
              <div id="moneyFormula" class="formula-detail"></div>
              <!-- 今日記錄Log -->
              <div style="margin-top:12px;">
                <div style="text-align:center;font-size:12px;font-weight:500;color:#6b5a4a;margin-bottom:6px;">今日記錄Log</div>
                <table id="moneyTable">
                  <thead>
                    <tr><th>項目</th><th>金額</th><th>備註</th><th>操作</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="trend-wrap">
                <div class="trend-title">數據趨勢圖</div>
                <div class="trend-hdr">
                  <select id="moneyTrendSelect">
                    <optgroup label="── 記錄細目 ──">
                      <option value="dailyOut_total">日常支出（總額）</option>
                      <option value="dailyOut_food">日常支出－外食外賣</option>
                      <option value="dailyOut_drink">日常支出－咖啡飲料</option>
                      <option value="dailyOut_dessert">日常支出－外食甜品</option>
                      <option value="dailyOut_fresh">日常支出－生鮮果蔬</option>
                      <option value="dailyOut_snack">日常支出－零食小吃</option>
                      <option value="dailyOut_life">日常支出－生活用品</option>
                      <option value="dailyOut_entertain">日常支出－娛樂支出</option>
                      <option value="basicOut_total">基本支出（總額）</option>
                      <option value="specialOut_total">特殊支出（總額）</option>
                      <option value="income_total">日常收入（總額）</option>
                    </optgroup>
                    <optgroup label="── 錢包分類 ──">
                      <option value="wallet_wechat">微信支付</option>
                      <option value="wallet_alipay">支付寶</option>
                      <option value="wallet_credit">信用卡</option>
                      <option value="wallet_cash">現金</option>
                      <option value="wallet_other">其他錢包</option>
                    </optgroup>
                    <optgroup label="── 基礎屬性 ──">
                      <option value="score">財富（日分）</option>
                    </optgroup>
                    <optgroup label="── 工具屬性 ──">
                      <option value="streak">聚寶盆</option>
                    </optgroup>
                    <optgroup label="── 加權屬性 ──">
                      <option value="freedom">逍遙</option>
                    </optgroup>
                  </select>
                  <select id="moneyTrendGroup">
                    <option value="day">按日</option>
                    <option value="week">按週</option>
                    <option value="month">按月</option>
                  </select>
                </div>
                <div class="trend-hdr">
                  <input type="date" id="moneyTrendFrom" />
                  <span class="trend-date-sep">至</span>
                  <input type="date" id="moneyTrendTo" />
                  <span class="trend-summary" id="moneyTrendSummary"></span>
                </div>
                <canvas id="moneyTrendCanvas" class="trend-canvas"></canvas>
              </div>
            </div>
          </div>
        </section>
        <!-- 聯絡客戶 -->
        <section class="section-card" id="section-job">
          <div class="section-header">
            <div>
              <div class="section-title">聯絡客戶</div>
              <div class="section-subtitle">就職活動｜基礎屬性：才幹　工具屬性：祥瑞　加權：天命</div>
            </div>
            <div class="pill-offer">
              Offer 狀態：
              <select id="jobOfferStatus" class="select" style="width:auto;display:inline-block;padding:2px 6px;font-size:11px;">
                <option value="none">未獲得</option>
                <option value="has">已獲得（本日含）</option>
              </select>
            </div>
          </div>
          <div class="section-body">
            <div class="panel">
              <div class="panel-title">
                當日紀錄
                <span class="small">可多次提交，數值累加</span>
              </div>
              <div class="form-row">
                <div>
                  <label class="label-small">類別</label>
                  <select id="jobType" class="select">
                    <option value="research">企業調查（家）</option>
                    <option value="prep">面試對策（小時）</option>
                    <option value="writing">文書寫作（小時）</option>
                    <option value="general">綜合準備（小時）</option>
                  </select>
                </div>
                <div>
                  <label class="label-small">數量</label>
                  <input id="jobAmount" type="number" class="input" placeholder="輸入數量" />
                </div>
              </div>
              <div style="text-align:right;margin-top:6px;">
                <button id="jobAddBtn" class="btn btn-primary">加入今日紀錄</button>
              </div>

              <div style="margin-top:6px;margin-bottom:6px;">
                <div class="badge-row" id="jobBadges"></div>
              </div>
            </div>

            <div class="panel">
              <div class="hero-stats">
                <div class="hero-stat">
                  <span class="hero-stat-label">才幹：</span>
                  <span class="hero-stat-value" id="jobTodayScore">0</span>
                  <span class="hero-stat-sub">（累計：<span id="jobTotalScore">0</span>）</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">祥瑞：</span>
                  <span class="hero-stat-value" id="jobAuspiciousVal">0</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">天命：</span>
                  <span class="hero-stat-value" id="jobFate">0.5</span>
                  <span class="tip-icon" data-tip="未拿到offer前，祥瑞 < 10 → 0.5；≥ 10 → 1；拿到offer後 → 2">?</span>
                </div>
              </div>
              <div id="jobFormula" class="formula-detail"></div>
              <!-- 今日記錄Log -->
              <div style="margin-top:12px;">
                <div style="text-align:center;font-size:12px;font-weight:500;color:#6b5a4a;margin-bottom:6px;">今日記錄Log</div>
                <table id="jobTable">
                  <thead>
                    <tr><th>項目</th><th>今日數量</th><th>操作</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div id="jobAuspiciousBlock" style="display:none;"></div>
              <div class="trend-wrap">
                <div class="trend-title">數據趨勢圖</div>
                <div class="trend-hdr">
                  <select id="jobTrendSelect">
                    <optgroup label="── 記錄細目 ──">
                      <option value="survey">企業調查</option>
                      <option value="interview">面試對策</option>
                      <option value="writing">文書寫作</option>
                      <option value="prep">綜合準備</option>
                    </optgroup>
                    <optgroup label="── 基礎屬性 ──">
                      <option value="score">才幹（日分）</option>
                    </optgroup>
                    <optgroup label="── 工具屬性 ──">
                      <option value="auspicious">祥瑞</option>
                    </optgroup>
                    <optgroup label="── 加權屬性 ──">
                      <option value="fate">天命</option>
                    </optgroup>
                  </select>
                  <select id="jobTrendGroup">
                    <option value="day">按日</option>
                    <option value="week">按週</option>
                    <option value="month">按月</option>
                  </select>
                </div>
                <div class="trend-hdr">
                  <input type="date" id="jobTrendFrom" />
                  <span class="trend-date-sep">至</span>
                  <input type="date" id="jobTrendTo" />
                  <span class="trend-summary" id="jobTrendSummary"></span>
                </div>
                <canvas id="jobTrendCanvas" class="trend-canvas"></canvas>
              </div>
            </div>
          </div>
        </section>
        <!-- 謄錄經典（閱讀文獻） -->
        <section class="section-card" id="section-reading">
          <div class="section-header">
            <div>
              <div class="section-title">謄錄經典</div>
              <div class="section-subtitle">閱讀文獻｜基礎：學識　工具：人物誌　加權：異心</div>
            </div>
          </div>
          <div class="section-body">
            <div class="panel">
              <div class="panel-title">
                當日閱讀紀錄
                <span class="small">不同類型頁數換算分值</span>
              </div>
              <div class="form-row">
                <div>
                  <label class="label-small">類別</label>
                  <select id="readType" class="select">
                    <option value="philo">高難度哲學文獻</option>
                    <option value="academic">其他學術文獻</option>
                    <option value="nonfic">非學術讀物</option>
                  </select>
                </div>
                <div>
                  <label class="label-small">頁數</label>
                  <input id="readPages" type="number" class="input" placeholder="輸入頁數" />
                </div>
              </div>
              <div style="text-align:right;margin-top:6px;">
                <button id="readAddBtn" class="btn btn-primary">加入今日紀錄</button>
              </div>

              <div style="margin-bottom:8px;">
                <div class="panel-title" style="margin-bottom:4px;">
                  閱讀項目
                  <span class="small">讀完一本書，徽章 +100</span>
                </div>
                <div class="form-row" style="margin-bottom:4px;">
                  <div style="flex:2;">
                    <label class="label-small">新項目名稱</label>
                    <input id="readNewProjectName" class="input" placeholder="例如：《判斷力批判》" />
                  </div>
                  <div style="flex:1;">
                    <label class="label-small">總頁數</label>
                    <input id="readNewProjectPages" type="number" class="input" placeholder="頁數" />
                  </div>
                  <div style="align-self:flex-end;flex:0 0 auto;">
                    <button id="readAddProjectBtn" class="btn btn-ghost">新增項目</button>
                  </div>
                </div>
                <div id="readProjectsContainer"></div>
              </div>
            </div>

            <div class="panel">
              <div class="hero-stats">
                <div class="hero-stat">
                  <span class="hero-stat-label">學識：</span>
                  <span class="hero-stat-value" id="readTodayScore">0</span>
                  <span class="hero-stat-sub">（累計：<span id="readTotalScore">0</span>）</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">人物誌：</span>
                  <span class="hero-stat-value" id="readStreak">0</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">異心：</span>
                  <span class="hero-stat-value" id="readDifferent">0.5</span>
                  <span class="tip-icon" data-tip="人物誌 < 15 → 0.5；≥15 且 ≤60 → 1；> 60 → 2">?</span>
                </div>
              </div>
              <div id="readFormula" class="formula-detail"></div>
              <!-- 今日記錄Log -->
              <div style="margin-top:12px;">
                <div style="text-align:center;font-size:12px;font-weight:500;color:#6b5a4a;margin-bottom:6px;">今日記錄Log</div>
                <table id="readTable">
                  <thead>
                    <tr><th>類別</th><th>頁數</th><th>操作</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="trend-wrap">
                <div class="trend-title">數據趨勢圖</div>
                <div class="trend-hdr">
                  <select id="readTrendSelect">
                    <optgroup label="── 記錄細目 ──">
                      <option value="philo">高難度哲學文獻</option>
                      <option value="academic">其他學術文獻</option>
                      <option value="nonfic">非學術讀物</option>
                    </optgroup>
                    <optgroup label="── 基礎屬性 ──">
                      <option value="score">學識（日分）</option>
                    </optgroup>
                    <optgroup label="── 工具屬性 ──">
                      <option value="streak">人物誌</option>
                    </optgroup>
                    <optgroup label="── 加權屬性 ──">
                      <option value="different">異心</option>
                    </optgroup>
                  </select>
                  <select id="readTrendGroup">
                    <option value="day">按日</option>
                    <option value="week">按週</option>
                    <option value="month">按月</option>
                  </select>
                </div>
                <div class="trend-hdr">
                  <input type="date" id="readTrendFrom" />
                  <span class="trend-date-sep">至</span>
                  <input type="date" id="readTrendTo" />
                  <span class="trend-summary" id="readTrendSummary"></span>
                </div>
                <canvas id="readTrendCanvas" class="trend-canvas"></canvas>
              </div>
            </div>
          </div>
        </section>
        <!-- 雅客宴遊（畢業論文） -->
        <section class="section-card" id="section-thesis">
          <div class="section-header">
            <div>
              <div class="section-title">雅客宴遊</div>
              <div class="section-subtitle">畢業論文｜基礎：聲望　工具：傳聞　加權：玲瓏</div>
            </div>
          </div>
          <div class="section-body">
            <div class="panel">
              <div class="panel-title">
                當日寫作紀錄
                <span class="small">字數以 1000 字為單位計分</span>
              </div>
              <div class="form-row">
                <div>
                  <label class="label-small">今日寫作字數</label>
                  <input id="thesisWords" type="number" class="input" placeholder="輸入字數" />
                </div>
                <div>
                  <label class="label-small">貢獻至項目</label>
                  <select id="thesisProjectSelect" class="select">
                    <option value="">（無項目）</option>
                  </select>
                </div>
              </div>
              <div style="text-align:right;margin-top:6px;">
                <button id="thesisAddBtn" class="btn btn-primary">加入今日紀錄</button>
              </div>

              <div style="margin-bottom:8px;">
                <div class="panel-title" style="margin-bottom:4px;">
                  論文項目
                  <span class="small">完結徽章每項 +100</span>
                </div>
                <div class="form-row" style="margin-bottom:4px;">
                  <div>
                    <label class="label-small">新項目名稱</label>
                    <input id="thesisNewProjectName" class="input" placeholder="例如：胡金銓章節" />
                  </div>
                  <div style="align-self:flex-end;">
                    <button id="thesisAddProjectBtn" class="btn btn-ghost">新增項目</button>
                  </div>
                </div>
                <div class="badge-row" id="thesisProjectsRow"></div>
              </div>
            </div>

            <div class="panel">
              <div class="hero-stats">
                <div class="hero-stat">
                  <span class="hero-stat-label">聲望：</span>
                  <span class="hero-stat-value" id="thesisTodayScore">0</span>
                  <span class="hero-stat-sub">（累計：<span id="thesisTotalScore">0</span>）</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">傳聞：</span>
                  <span class="hero-stat-value" id="thesisRumorVal">0</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">玲瓏：</span>
                  <span class="hero-stat-value" id="thesisLeling">0.5</span>
                  <span class="tip-icon" data-tip="傳聞 ≥ 3 → 2；傳聞 < 1 → 0.5；其餘 → 1">?</span>
                </div>
              </div>
              <div id="thesisFormula" class="formula-detail"></div>
              <!-- 今日記錄Log -->
              <div style="margin-top:12px;">
                <div style="text-align:center;font-size:12px;font-weight:500;color:#6b5a4a;margin-bottom:6px;">今日記錄Log</div>
                <table id="thesisTable">
                  <thead>
                    <tr><th>項目</th><th>字數</th><th>操作</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div id="thesisRumorBlock" style="display:none;"></div>
              <div class="trend-wrap">
                <div class="trend-title">數據趨勢圖</div>
                <div class="trend-hdr">
                  <select id="thesisTrendSelect">
                    <optgroup label="── 記錄細目 ──">
                      <option value="words">寫作字數</option>
                    </optgroup>
                    <optgroup label="── 基礎屬性 ──">
                      <option value="score">聲望（日分）</option>
                    </optgroup>
                    <optgroup label="── 工具屬性 ──">
                      <option value="rumor">傳聞</option>
                    </optgroup>
                    <optgroup label="── 加權屬性 ──">
                      <option value="leling">玲瓏</option>
                    </optgroup>
                  </select>
                  <select id="thesisTrendGroup">
                    <option value="day">按日</option>
                    <option value="week">按週</option>
                    <option value="month">按月</option>
                  </select>
                </div>
                <div class="trend-hdr">
                  <input type="date" id="thesisTrendFrom" />
                  <span class="trend-date-sep">至</span>
                  <input type="date" id="thesisTrendTo" />
                  <span class="trend-summary" id="thesisTrendSummary"></span>
                </div>
                <canvas id="thesisTrendCanvas" class="trend-canvas"></canvas>
              </div>
            </div>
          </div>
        </section>
        <!-- 新書發布（創作） -->
        <section class="section-card" id="section-fiction">
          <div class="section-header">
            <div>
              <div class="section-title">新書發布</div>
              <div class="section-subtitle">創作活動｜基礎：文彩　工具：奇譚　加權：靈韻</div>
            </div>
          </div>
          <div class="section-body">
            <div class="panel">
              <div class="panel-title">
                當日創作紀錄
                <span class="small">字數以 1000 字為單位計分</span>
              </div>
              <div class="form-row">
                <div>
                  <label class="label-small">今日創作字數</label>
                  <input id="fictionWords" type="number" class="input" placeholder="輸入字數" />
                </div>
                <div>
                  <label class="label-small">貢獻至項目</label>
                  <select id="fictionProjectSelect" class="select">
                    <option value="">（無項目）</option>
                  </select>
                </div>
              </div>
              <div style="text-align:right;margin-top:6px;">
                <button id="fictionAddBtn" class="btn btn-primary">加入今日紀錄</button>
              </div>

              <div style="margin-bottom:8px;">
                <div class="panel-title" style="margin-bottom:4px;">
                  創作項目
                  <span class="small">完結一部作品，徽章 +300</span>
                </div>
                <div class="form-row" style="margin-bottom:4px;">
                  <div>
                    <label class="label-small">新項目名稱</label>
                    <input id="fictionNewProjectName" class="input" placeholder="例如：曹丕同人" />
                  </div>
                  <div style="align-self:flex-end;">
                    <button id="fictionAddProjectBtn" class="btn btn-ghost">新增項目</button>
                  </div>
                </div>
                <div class="badge-row" id="fictionProjectsRow"></div>
              </div>
            </div>

            <div class="panel">
              <div class="hero-stats">
                <div class="hero-stat">
                  <span class="hero-stat-label">文彩：</span>
                  <span class="hero-stat-value" id="fictionTodayScore">0</span>
                  <span class="hero-stat-sub">（累計：<span id="fictionTotalScore">0</span>）</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">奇譚：</span>
                  <span class="hero-stat-value" id="fictionTaleVal">0</span>
                </div>
                <div class="hero-stat">
                  <span class="hero-stat-label">靈韻：</span>
                  <span class="hero-stat-value" id="fictionSpirit">1</span>
                  <span class="tip-icon" data-tip="奇譚 ≥ 3 → 4；< 1 → 1；1–<3 → 2">?</span>
                </div>
              </div>
              <div id="fictionFormula" class="formula-detail"></div>
              <!-- 今日記錄Log -->
              <div style="margin-top:12px;">
                <div style="text-align:center;font-size:12px;font-weight:500;color:#6b5a4a;margin-bottom:6px;">今日記錄Log</div>
                <table id="fictionTable">
                  <thead>
                    <tr><th>項目</th><th>字數</th><th>操作</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div id="fictionTaleBlock" style="display:none;"></div>
              <div class="trend-wrap">
                <div class="trend-title">數據趨勢圖</div>
                <div class="trend-hdr">
                  <select id="fictionTrendSelect">
                    <optgroup label="── 記錄細目 ──">
                      <option value="words">創作字數</option>
                    </optgroup>
                    <optgroup label="── 基礎屬性 ──">
                      <option value="score">文彩（日分）</option>
                    </optgroup>
                    <optgroup label="── 工具屬性 ──">
                      <option value="tale">奇譚</option>
                    </optgroup>
                    <optgroup label="── 加權屬性 ──">
                      <option value="spirit">靈韻</option>
                    </optgroup>
                  </select>
                  <select id="fictionTrendGroup">
                    <option value="day">按日</option>
                    <option value="week">按週</option>
                    <option value="month">按月</option>
                  </select>
                </div>
                <div class="trend-hdr">
                  <input type="date" id="fictionTrendFrom" />
                  <span class="trend-date-sep">至</span>
                  <input type="date" id="fictionTrendTo" />
                  <span class="trend-summary" id="fictionTrendSummary"></span>
                </div>
                <canvas id="fictionTrendCanvas" class="trend-canvas"></canvas>
              </div>
            </div>
          </div>
        </section>


</main>

  <!-- 今日動態彈窗 -->
  <div id="feedViewerModalOverlay" class="modal-overlay">
    <div class="modal" style="width:550px;max-height:85vh;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;">📰 今日動態</h3>
        <div style="display:flex;align-items:center;gap:6px;">
          <button id="feedPrevDay" class="btn btn-ghost" style="font-size:10px;padding:2px 6px;">◀</button>
          <span id="feedDateLabel" style="font-size:12px;font-weight:600;color:#8b6914;min-width:80px;text-align:center;"></span>
          <button id="feedNextDay" class="btn btn-ghost" style="font-size:10px;padding:2px 6px;">▶</button>
          <input type="date" id="feedDatePicker" style="font-size:10px;padding:2px 4px;border:1px solid rgba(178,144,90,0.3);border-radius:4px;" />
        </div>
        <button id="feedCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
      </div>
      <div id="feedTimelineBody" class="timeline-body" style="max-height:calc(85vh - 80px);overflow-y:auto;"></div>
    </div>
  </div>

  <!-- 動態軸彈窗 -->
  <div id="timelineModalOverlay" class="modal-overlay">
    <div class="modal" style="width:500px;max-height:85vh;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;">動態軸</h3>
        <button id="timelineCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
      </div>
      
      <!-- 魅力計算公式 -->
      <div id="charmFormulaPanel" style="background:rgba(250,246,236,0.9);border-radius:8px;padding:10px;margin-bottom:12px;border:1px dashed rgba(178,144,90,0.4);">
        <div style="font-size:11px;color:#8b6914;font-weight:500;margin-bottom:6px;">💄 魅力計算公式</div>
        <div id="charmFormula" style="font-size:10px;color:#6b5a4a;line-height:1.5;"></div>
      </div>
      
      <div id="timelineBody" class="timeline-body" style="max-height:calc(85vh - 180px);overflow-y:auto;"></div>
    </div>
  </div>

  <!-- 日期選擇彈窗 -->
  <div id="dateModalOverlay" class="modal-overlay">
    <div class="modal" style="min-width:280px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;">
        <div style="font-size:13px;color:#6b5a4a;font-weight:500;">選擇日期</div>
        <button id="dateModalClose" class="btn btn-ghost" style="padding:3px 8px;font-size:11px;">關閉</button>
      </div>
      <div style="margin-top:6px;display:flex;gap:6px;align-items:center;">
        <button id="calPrevMonth" class="btn btn-ghost" style="padding:2px 6px;font-size:11px;">◀</button>
        <select id="calYear" class="select" style="width:auto;padding:3px 6px;font-size:11px;"></select>
        <select id="calMonth" class="select" style="width:auto;padding:3px 6px;font-size:11px;"></select>
        <button id="calNextMonth" class="btn btn-ghost" style="padding:2px 6px;font-size:11px;">▶</button>
      </div>
      <div class="calendar-grid" id="calWeekRow" style="margin-top:6px;"></div>
      <div class="calendar-grid" id="calDays"></div>
    </div>
  </div>

  <!-- 店鋪清潔彈窗 -->
  <div id="cleaningModalOverlay" class="modal-overlay">
    <div class="modal" style="width:400px;">
      <h3>店鋪清潔（氣質評分）</h3>
      <div style="font-size:11px;color:#a08060;margin-bottom:10px;">
        初始 100 分，「可做未做」-5分，「必做未做」-20分
      </div>
      <div id="cleaningRows"></div>
      <div style="margin-top:12px;text-align:right;">
        <button class="btn btn-primary" id="cleaningCloseBtn">完成</button>
      </div>
    </div>
  </div>

  <!-- 記事本彈窗 -->
  <div id="notepadModalOverlay" class="modal-overlay">
    <div class="modal" style="width:500px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;">計劃記事本</h3>
        <div>
          <button id="notepadSaveBtn" class="btn btn-primary" style="font-size:11px;margin-right:6px;">保存</button>
          <button id="notepadCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
        </div>
      </div>
      
      <div class="notepad-toolbar">
        <button id="notepadBold" title="粗體"><b>B</b></button>
        <button id="notepadUnderline" title="下劃線"><u>U</u></button>
        <button id="notepadStrike" title="刪除線"><s>S</s></button>
        <button id="notepadColorBlack" title="黑色" style="color:#000;">A</button>
        <button id="notepadColorRed" title="紅色" style="color:#c04040;">A</button>
        <button id="notepadColorBlue" title="藍色" style="color:#2060a0;">A</button>
        <button id="notepadColorGreen" title="綠色" style="color:#308030;">A</button>
        <button id="notepadBullet" title="Bullet列表">•</button>
        <button id="notepadIndent" title="增加縮進">⇥</button>
        <button id="notepadOutdent" title="減少縮進">⇤</button>
        <button id="notepadTagYellow" title="黃色標籤（一般）">🟡</button>
        <button id="notepadTagOrange" title="橘色標籤（中等）">🟠</button>
        <button id="notepadTagRed" title="紅色標籤（高難）">🔴</button>
        <button id="notepadTagDelete" title="刪除選中標籤" style="color:#c04040;font-size:10px;">🗑</button>
      </div>
      <div id="notepadContent" class="notepad-content" contenteditable="true"></div>
      <div style="font-size:10px;color:#a08060;margin-top:6px;">
        提示：添加標籤後，在動態軸中點擊相同顏色的標籤表示已執行該計劃項目，魅力 = 執行÷計劃
      </div>
    </div>
  </div>

  <!-- 動態發佈彈窗 -->
  <div id="timelinePostModalOverlay" class="modal-overlay">
    <div class="modal" style="width:400px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;">發佈動態</h3>
        <button id="timelinePostCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
      </div>
      <textarea id="timelinePostText" class="textarea" placeholder="記錄此刻..." style="min-height:200px;font-size:13px;"></textarea>
      <div style="margin-top:8px;">
        <input type="file" id="timelineImageInput" accept="image/*" multiple style="display:none;" />
        <button id="timelineImageBtn" class="btn btn-ghost" style="font-size:10px;padding:3px 6px;">📷 添加圖片</button>
        <div id="timelineImagePreview" class="image-preview" style="margin-top:6px;"></div>
      </div>
      <div style="margin-top:12px;text-align:right;">
        <button id="timelinePostBtn" class="btn btn-primary" style="font-size:11px;">發佈</button>
      </div>
    </div>
  </div>

  <!-- 獎盃一覽彈窗 -->
  <div id="trophyModalOverlay" class="modal-overlay">
    <div class="modal" style="width:500px;">
      <h3>獎盃一覽</h3>
      <div id="trophyList" style="max-height:400px;overflow-y:auto;"></div>
      <div style="margin-top:12px;text-align:right;">
        <button class="btn btn-primary" id="trophyCloseBtn">關閉</button>
      </div>
    </div>
  </div>

  <!-- 轉盤彈窗 -->
  <div id="spinnerModalOverlay" class="modal-overlay">
    <div class="modal" style="width:340px;">
      <h3 style="text-align:center;">好感度劇情轉盤</h3>
      <div id="spinnerContent"></div>
      <div style="margin-top:12px;text-align:center;">
        <button class="btn btn-ghost" id="spinnerCloseBtn">關閉</button>
      </div>
    </div>
  </div>

  <!-- 金风玉露面板弹窗 -->
  <div id="romanceModalOverlay" class="modal-overlay">
    <div class="modal" style="width:700px;max-height:90vh;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;">金風玉露</h3>
        <button id="romanceCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
      </div>
      
      <!-- 角色選擇標籤 -->
      <div id="romanceCharTabs" style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;"></div>
      
      <!-- 角色面板內容 -->
      <div id="romanceCharPanel" style="max-height:calc(90vh - 120px);overflow-y:auto;"></div>
    </div>
  </div>

  <!-- 好感度轉盤彈窗（獨立） -->
  <div id="affinityModalOverlay" class="modal-overlay">
    <div class="modal" style="width:450px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;">好感度轉盤</h3>
        <button id="affinityCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
      </div>
      <div id="affinitySpinnerContent"></div>
    </div>
  </div>

  <!-- 結合事件確認彈窗 -->
  <div id="unionEventModalOverlay" class="modal-overlay">
    <div class="modal" style="width:360px;">
      <h3 style="text-align:center;" id="unionEventTitle">是否進入結合事件？</h3>
      <div id="unionEventContent" style="text-align:center;padding:12px;"></div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
        <button id="unionEventYes" class="btn btn-primary">進入</button>
        <button id="unionEventNo" class="btn btn-ghost">跳過</button>
      </div>
    </div>
  </div>

  <!-- 圖策天下：趨勢圖總覽彈窗 -->
  <div id="trendViewerModalOverlay" class="modal-overlay">
    <div class="modal" style="width:680px;max-height:90vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;color:#8b6914;letter-spacing:2px;">📊 圖策天下</h3>
        <button id="trendViewerCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
      </div>
      <div style="font-size:10px;color:#a08060;margin-bottom:12px;">
        自由查看六大板塊數據趨勢，可選指標、日期區間與分組方式
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;align-items:center;">
        <select id="tvModule" class="select" style="width:auto;font-size:11px;">
          <option value="life">組織經營（德行）</option>
          <option value="money">財務管理（財富）</option>
          <option value="job">聯絡客戶（才幹）</option>
          <option value="read">謄錄經典（學識）</option>
          <option value="thesis">雅客宴遊（聲望）</option>
          <option value="fiction">新書發布（文彩）</option>
        </select>
        <select id="tvMetric" class="select" style="width:auto;font-size:11px;"></select>
        <select id="tvGroup" class="select" style="width:auto;font-size:11px;">
          <option value="day">按日</option>
          <option value="week">按週</option>
          <option value="month">按月</option>
        </select>
      </div>
      <div style="display:flex;gap:6px;margin-bottom:10px;align-items:center;flex-wrap:wrap;">
        <label style="font-size:10px;color:#8b7355;">從</label>
        <input type="date" id="tvFrom" class="input" style="width:130px;font-size:11px;" />
        <label style="font-size:10px;color:#8b7355;">至</label>
        <input type="date" id="tvTo" class="input" style="width:130px;font-size:11px;" />
      </div>
      <div style="background:linear-gradient(135deg,rgba(255,252,245,0.95),rgba(247,243,237,0.95));border-radius:10px;border:1px solid rgba(178,144,90,0.15);padding:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:11px;color:#8b6914;font-weight:500;">趨勢圖</span>
          <span id="tvSummary" style="font-size:10px;color:#8b6914;font-weight:500;"></span>
        </div>
        <canvas id="tvCanvas" style="width:100%;height:200px;"></canvas>
      </div>
    </div>
  </div>

  <!-- 數據管理彈窗 -->
  <div id="dataManagerModalOverlay" class="modal-overlay">
    <div class="modal" style="width:480px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;">📦 數據管理</h3>
        <button id="dataManagerCloseBtn" class="btn btn-ghost" style="font-size:11px;">關閉</button>
      </div>
      
      <!-- 數據概覽 -->
      <div style="background:rgba(250,246,236,0.9);border-radius:8px;padding:12px;margin-bottom:16px;border:1px solid rgba(178,144,90,0.25);">
        <div style="font-size:12px;color:#8b6914;font-weight:500;margin-bottom:8px;">📊 數據概覽</div>
        <div id="dataOverview" style="font-size:11px;color:#6b5a4a;line-height:1.8;"></div>
      </div>
      
      <!-- 導出功能 -->
      <div style="background:rgba(255,255,255,0.9);border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid rgba(178,144,90,0.2);">
        <div style="font-size:12px;color:#4a7c59;font-weight:500;margin-bottom:10px;">📤 導出備份</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnExportJson" class="btn btn-primary" style="font-size:11px;">導出 JSON 檔案</button>
          <button id="btnExportClipboard" class="btn btn-ghost" style="font-size:11px;">複製到剪貼簿</button>
        </div>
        <div style="font-size:10px;color:#a08060;margin-top:8px;">
          建議定期備份數據，防止意外丟失。JSON 檔案可用於跨設備遷移。
        </div>
      </div>
      
      <!-- 導入功能 -->
      <div style="background:rgba(255,255,255,0.9);border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid rgba(178,144,90,0.2);">
        <div style="font-size:12px;color:#c08020;font-weight:500;margin-bottom:10px;">📥 導入恢復</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <input type="file" id="importFileInput" accept=".json" style="display:none;" />
          <button id="btnImportFile" class="btn btn-ghost" style="font-size:11px;">從檔案導入</button>
          <button id="btnImportClipboard" class="btn btn-ghost" style="font-size:11px;">從剪貼簿導入</button>
        </div>
        <div style="font-size:10px;color:#a08060;">
          ⚠️ 導入將覆蓋現有數據，請先備份當前數據！
        </div>
      </div>
      
      <!-- 合併功能 -->
      <div style="background:rgba(255,255,255,0.9);border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid rgba(178,144,90,0.2);">
        <div style="font-size:12px;color:#2060a0;font-weight:500;margin-bottom:10px;">🔄 智能合併</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <input type="file" id="mergeFileInput" accept=".json" style="display:none;" />
          <button id="btnMergeFile" class="btn btn-ghost" style="font-size:11px;">選擇檔案合併</button>
        </div>
        <div style="font-size:10px;color:#a08060;">
          合併模式：保留兩份數據中較新/較多的記錄，不會丟失任何數據。
        </div>
      </div>
      
      <!-- 危險操作 -->
      <div style="background:rgba(255,240,240,0.9);border-radius:8px;padding:12px;border:1px solid rgba(192,64,64,0.2);">
        <div style="font-size:12px;color:#c04040;font-weight:500;margin-bottom:10px;">⚠️ 危險操作</div>
        <button id="btnClearAllData" class="btn" style="font-size:11px;background:#c04040;color:#fff;border:none;">清除所有數據</button>
        <div style="font-size:10px;color:#c04040;margin-top:8px;">
          此操作不可恢復！請確保已備份重要數據。
        </div>
      </div>
      
      <!-- 操作日誌 -->
      <div id="dataManagerLog" style="margin-top:12px;padding:8px;background:rgba(0,0,0,0.03);border-radius:6px;font-size:10px;color:#6b5a4a;max-height:80px;overflow-y:auto;display:none;"></div>
    </div>
  </div>

  <!-- 導入預覽確認彈窗 -->
  <div id="importPreviewModalOverlay" class="modal-overlay">
    <div class="modal" style="width:420px;">
      <h3 style="margin-bottom:12px;">📋 導入數據預覽</h3>
      <div id="importPreviewContent" style="background:rgba(250,246,236,0.9);border-radius:8px;padding:12px;margin-bottom:12px;font-size:11px;color:#6b5a4a;max-height:200px;overflow-y:auto;"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="btnImportCancel" class="btn btn-ghost" style="font-size:11px;">取消</button>
        <button id="btnImportConfirm" class="btn btn-primary" style="font-size:11px;">確認導入</button>
      </div>
    </div>
  </div>

  <!-- 合併預覽確認彈窗 -->
  <div id="mergePreviewModalOverlay" class="modal-overlay">
    <div class="modal" style="width:500px;">
      <h3 style="margin-bottom:12px;">🔄 合併數據預覽</h3>
      <div id="mergePreviewContent" style="background:rgba(250,246,236,0.9);border-radius:8px;padding:12px;margin-bottom:12px;font-size:11px;color:#6b5a4a;max-height:250px;overflow-y:auto;"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="btnMergeCancel" class="btn btn-ghost" style="font-size:11px;">取消</button>
        <button id="btnMergeConfirm" class="btn btn-primary" style="font-size:11px;">確認合併</button>
      </div>
    </div>
  </div>

  <!-- 圖片大圖查看 -->
  <div id="imageOverlay" class="image-overlay">
    <img id="overlayImg" src="" alt="preview" />
  </div>
  <script>
    // ===== 常量與配置 =====
    const STORAGE_KEY = 'bookstore_growth_state_v2';

    // 歷史年份映射（現實日期 → 遊戲年份）
    const milestones = [
      { realDate: '2026-02-05', year: 210, era: '建安十五年' },
      { realDate: '2026-03-10', year: 212, era: '建安十七年' },
      { realDate: '2026-03-31', year: 213, era: '建安十八年' },
      { realDate: '2026-04-30', year: 215, era: '建安二十年' },
      { realDate: '2026-05-31', year: 216, era: '建安二十一年' },
      { realDate: '2026-06-20', year: 217, era: '建安二十二年' },
      { realDate: '2026-07-31', year: 218, era: '建安二十三年' },
      { realDate: '2026-08-31', year: 219, era: '建安二十四年' },
      { realDate: '2026-10-31', year: 220, era: '建安二十五年' },
      { realDate: '2026-11-20', year: 220, era: '黃初元年' },
      { realDate: '2027-01-31', year: 221, era: '黃初二年' },
      { realDate: '2027-02-28', year: 223, era: '黃初四年' },
      { realDate: '2027-03-28', year: 225, era: '黃初六年' },
    ];

    const historicalEvents = {
      210: '曹操建立銅雀台，曹植因才華受寵',
      212: '書店獲曹操隱性認可',
      213: '曹操獲封魏公',
      215: '曹操殺伏皇后',
      216: '曹操稱魏王',
      217: '曹丕獲封魏世子',
      218: '林娘子名聲大作',
      219: '魏諷案爆發',
      220: '曹操之死，曹丕代漢',
      221: '曹魏政權穩定',
      223: '曹植等上京面聖',
      225: '曹丕南徵病重',
    };

    // 獎杯數據（來自原文件）
    const trophyData = [
      { id: 1, name: '鄴城風雲', date: '2026-02-05', conditions: [], defaultUnlocked: true },
      { id: 2, name: '璞玉渾金', date: '2026-03-10', conditions: ['理財習慣養成30日'] },
      { id: 3, name: '珠聯璧合', date: '2026-03-10', conditions: ['作息習慣養成30日'] },
      { id: 4, name: '偏安一隅', date: '2026-04-10', conditions: ['讀完《判斷力批判》'] },
      { id: 5, name: '驚鴻', date: '2026-04-30', conditions: ['開始論文底稿寫作'] },
      { id: 6, name: '雙飛雁', date: '2026-05-20', conditions: ['理財習慣養成90日'] },
      { id: 7, name: '鳳求凰', date: '2026-05-20', conditions: ['作息習慣養成90日'] },
      { id: 8, name: '藤樹相連', date: '2026-06-20', conditions: ['獲得工作offer'] },
      { id: 9, name: '畫意', date: '2026-07-31', conditions: ['連續兩個月達成小說產出量'] },
      { id: 10, name: '食髓知味', date: '2026-08-31', conditions: ['讀完《純粹理性批判》'] },
      { id: 11, name: '鎖清秋', date: '2026-09-10', conditions: ['開始論文初稿寫作'] },
      { id: 12, name: '貓頭鷹拍檔', date: '2026-10-10', conditions: ['讀完康德實踐哲學論文集'] },
      { id: 13, name: '心囚', date: '2026-10-31', conditions: ['發布第一篇小說'] },
      { id: 14, name: '定風波', date: '2026-11-20', conditions: ['完成論文初稿寫作'] },
      { id: 15, name: '堯舜之事', date: '2026-12-20', conditions: ['完成論文定稿'] },
      { id: 16, name: '仙釀', date: '2027-02-28', conditions: ['發布第二篇小說'] },
    ];

    // 角色數據（來自原文件）
    const characters = [
      { id: 1, name: '曹丕', title: '五官中郎將', unlockCondition: null, avatar: '丕' },
      { id: 2, name: '劉協', title: '漢獻帝', unlockCondition: '驚鴻', avatar: '協' },
      { id: 3, name: '郭嘉', title: '軍師祭酒', unlockCondition: '璞玉渾金', avatar: '嘉' },
      { id: 4, name: '荀彧', title: '侍中尚書令', unlockCondition: '珠聯璧合', avatar: '彧' },
      { id: 5, name: '曹植', title: '公子', unlockCondition: '畫意', avatar: '植' },
      { id: 6, name: '司馬懿', title: '文學掾', unlockCondition: '偏安一隅', avatar: '懿' },
    ];

// 角色劇情數據
    const romanceData = {
      '曹丕': {
        attribute: '天命',
        attributeKey: 'jobFate',
        unionEvent: '巫山',
        unionKey: 'wushan',
        stories: [
          { id: 'cp_s1', type: 'S', name: '舍人', date: '2026-02-05', conditions: [], desc: '初識' },
          { id: 'cp_s2', type: 'S', name: '策士', date: '2026-03-10', conditions: [
            { text: '才幹 > 1000', check: (s, k) => computeJobTotalUntil(k) > 1000 },
            { text: '學識 > 1000', check: (s, k) => computeReadTotalUntil(k) > 1000 }
          ]},
          { id: 'cp_r0', type: 'R', name: '金屋藏嬌', altName: '樂未央', altType: 'F', date: '2026-04-20', conditions: [
            { text: '好感度 > 2800', check: (s, k) => getCharAffinity(s, '曹丕', k) > 2800, common: true },
            { text: '巫山 > 10', check: (s, k) => getUnionCount(s, '曹丕', k) > 10, forR: true },
            { text: '文彩 > 700', check: (s, k) => computeFictionTotalUntil(k) > 700, forR: true },
            { text: '財富 > 9000', check: (s, k) => computeMoneyTotalUntil(k) > 9000, forR: true },
            { text: '學識 > 2000', check: (s, k) => computeReadTotalUntil(k) > 2000, forF: true },
            { text: '聲望 > 700', check: (s, k) => computeThesisTotalUntil(k) > 700, forF: true },
            { text: '德行 > 1700', check: (s, k) => computeLifeTotalUntil(k) > 1700, forF: true }
          ]},
          { id: 'cp_be1', type: 'BE', name: '花落人亡', altName: '連理枝', altType: 'R', date: '2026-06-20', conditions: [
            { text: '未獲得【藤樹相連】或學識 < 4000', check: (s, k) => !s.trophyConditions['獲得工作offer'] || computeReadTotalUntil(k) < 4000, forBE: true },
            { text: '獲得【藤樹相連】', check: (s, k) => !!s.trophyConditions['獲得工作offer'], forR: true },
            { text: '好感度 > 3500', check: (s, k) => getCharAffinity(s, '曹丕', k) > 3500, forR: true },
            { text: '巫山 > 20', check: (s, k) => getUnionCount(s, '曹丕', k) > 20, forR: true },
            { text: '文彩 > 2000', check: (s, k) => computeFictionTotalUntil(k) > 2000, forR: true },
            { text: '財富 > 17000', check: (s, k) => computeMoneyTotalUntil(k) > 17000, forR: true }
          ]},
          { id: 'cp_r2', type: 'R', name: '三千寵愛', date: '2026-12-20', conditions: [
            { text: '獲得【堯舜之事】', check: (s, k) => !!s.trophyConditions['完成論文定稿'] },
            { text: '好感度 > 6000', check: (s, k) => getCharAffinity(s, '曹丕', k) > 6000 },
            { text: '巫山 > 40', check: (s, k) => getUnionCount(s, '曹丕', k) > 40 },
            { text: '財富 > 41000', check: (s, k) => computeMoneyTotalUntil(k) > 41000 },
            { text: '德行 > 8000', check: (s, k) => computeLifeTotalUntil(k) > 8000 },
            { text: '聲望 > 6200', check: (s, k) => computeThesisTotalUntil(k) > 6200 }
          ]},
       { id: 'cp_ge', type: 'GE', name: '大魏帝后', altName: '長門事', altType: 'BE', date: '2027-01-31', conditions: [
            { text: '好感度<7000 或 巫山<45 或 才幹<7200 或 聲望<6600 或 財富<42000 或 德行<8500 或 文彩<7200 或 學識<10000', check: (s, k) => getCharAffinity(s, '曹丕', k) < 7000 || getUnionCount(s, '曹丕', k) < 45 || computeJobTotalUntil(k) < 7200 || computeThesisTotalUntil(k) < 6600 || computeMoneyTotalUntil(k) < 42000 || computeLifeTotalUntil(k) < 8500 || computeFictionTotalUntil(k) < 7200 || computeReadTotalUntil(k) < 10000, forBE: true },
            { text: '好感度 > 8000', check: (s, k) => getCharAffinity(s, '曹丕', k) > 8000, forGE: true },
            { text: '巫山 > 50', check: (s, k) => getUnionCount(s, '曹丕', k) > 50, forGE: true },
            { text: '聲望 > 7000', check: (s, k) => computeThesisTotalUntil(k) > 7000, forGE: true },
            { text: '文彩 > 7500', check: (s, k) => computeFictionTotalUntil(k) > 7500, forGE: true },
            { text: '才幹 > 7500', check: (s, k) => computeJobTotalUntil(k) > 7500, forGE: true },
            { text: '德行 > 9000', check: (s, k) => computeLifeTotalUntil(k) > 9000, forGE: true },
            { text: '財富 > 46000', check: (s, k) => computeMoneyTotalUntil(k) > 46000, forGE: true }
          ]},
          { id: 'cp_se', type: 'SE', name: '情牽兩世', altName: '孤塚難尋', altType: 'BE', date: '2027-03-31', conditions: [
            { text: '司馬懿為GE狀態', check: (s, k) => s.romance?.['司馬懿']?.unlocked?.includes('smy_ge_ge'), forBE: true },
            { text: '巫山 > 野合 且 曹植好感度 > 司馬懿', check: (s, k) => getUnionCount(s, '曹丕', k) > getUnionCount(s, '司馬懿', k) && getCharAffinity(s, '曹植', k) > getCharAffinity(s, '司馬懿', k), forSE: true }
          ]}
        ]
      },
      '劉協': {
        attribute: '玲瓏',
        attributeKey: 'thesisLeling',
        unionEvent: '雲雨',
        unionKey: 'yunyu',
        stories: [
          { id: 'lx_s1', type: 'S', name: '民女', date: '2026-04-30', conditions: [
            { text: '獲得【驚鴻】', check: (s, k) => !!s.trophyConditions['開始論文底稿寫作'] }
          ]},
          { id: 'lx_s2', type: 'S', name: '名士', date: '2026-07-10', conditions: [
            { text: '文彩 > 2500', check: (s, k) => computeFictionTotalUntil(k) > 2500 },
            { text: '聲望 > 2300', check: (s, k) => computeThesisTotalUntil(k) > 2300 }
          ]},
          { id: 'lx_r1', type: 'R', name: '月滿西樓', altName: '顏如玉', altType: 'F', date: '2026-09-30', conditions: [
            { text: '獲得【鎖清秋】', check: (s, k) => !!s.trophyConditions['開始論文初稿寫作'], common: true },
            { text: '好感度 > 2500', check: (s, k) => getCharAffinity(s, '劉協', k) > 2500, common: true },
            { text: '雲雨 > 10', check: (s, k) => getUnionCount(s, '劉協', k) > 10, forR: true },
            { text: '聲望 > 4400', check: (s, k) => computeThesisTotalUntil(k) > 4400, forR: true },
            { text: '德行 > 5900', check: (s, k) => computeLifeTotalUntil(k) > 5900, forR: true },
            { text: '學識 > 7500', check: (s, k) => computeReadTotalUntil(k) > 7500, forF: true },
            { text: '文彩 > 4800', check: (s, k) => computeFictionTotalUntil(k) > 4800, forF: true }
          ]},
          { id: 'lx_be1', type: 'BE', name: '東風惡', date: '2026-10-31', conditions: [
            { text: '學識 < 8200 或聲望 < 4700 或荀彧BE', check: (s, k) => computeReadTotalUntil(k) < 8200 || computeThesisTotalUntil(k) < 4700 || isCharBE(s, '荀彧'), forBE: true }
          ]},
          { id: 'lx_r2', type: 'R', name: '鵲橋仙', altName: '幾多愁', altType: 'BE', date: '2026-12-20', conditions: [
            { text: '德行 < 7500 或聲望 < 6000 或未獲得【定風波】', check: (s, k) => computeLifeTotalUntil(k) < 7500 || computeThesisTotalUntil(k) < 6000 || !s.trophyConditions['完成論文初稿寫作'], forBE: true },
            { text: '獲得【定風波】', check: (s, k) => !!s.trophyConditions['完成論文初稿寫作'], forR: true },
            { text: '好感度 > 3500', check: (s, k) => getCharAffinity(s, '劉協', k) > 3500, forR: true },
            { text: '雲雨 > 15', check: (s, k) => getUnionCount(s, '劉協', k) > 15, forR: true },
            { text: '學識 > 9900', check: (s, k) => computeReadTotalUntil(k) > 9900, forR: true },
            { text: '財富 > 40000', check: (s, k) => computeMoneyTotalUntil(k) > 40000, forR: true }
          ]},
          { id: 'lx_ge', type: 'GE', name: '懸壺濟世', date: '2027-01-20', conditions: [
            { text: '好感度 > 4500', check: (s, k) => getCharAffinity(s, '劉協', k) > 4500 },
            { text: '雲雨 > 20', check: (s, k) => getUnionCount(s, '劉協', k) > 20 },
            { text: '獲得【堯舜之事】', check: (s, k) => !!s.trophyConditions['完成論文定稿'] },
            { text: '與曹丕、荀彧均保持F關係', check: (s, k) => isCharF(s, '曹丕') && isCharF(s, '荀彧') }
          ]}
        ]
      },
      '曹植': {
        attribute: '靈韻',
        attributeKey: 'fictionSpirit',
        unionEvent: '神交',
        unionKey: 'shenjiao',
        stories: [
          { id: 'cz_s1', type: 'S', name: '書倌', date: '2026-07-31', conditions: [
            { text: '獲得【畫意】', check: (s, k) => !!s.trophyConditions['連續兩個月達成小說產出量'] }
          ]},
          { id: 'cz_s2', type: 'S', name: '佳人', date: '2026-08-31', conditions: [
            { text: '德行 > 5200', check: (s, k) => computeLifeTotalUntil(k) > 5200 },
            { text: '文彩 > 3800', check: (s, k) => computeFictionTotalUntil(k) > 3800 }
          ]},
          { id: 'cz_r1', type: 'R', name: '在水一方', altName: '君子之交', altType: 'F', date: '2026-11-30', conditions: [
            { text: '獲得【心囚】', check: (s, k) => !!s.trophyConditions['發布第一篇小說'], common: true },
            { text: '好感度 > 2500', check: (s, k) => getCharAffinity(s, '曹植', k) > 2500, common: true },
            { text: '神交 > 10', check: (s, k) => getUnionCount(s, '曹植', k) > 10, forR: true },
            { text: '文彩 > 6000', check: (s, k) => computeFictionTotalUntil(k) > 6000, forR: true },
            { text: '聲望 > 5800', check: (s, k) => computeThesisTotalUntil(k) > 5800, forR: true },
            { text: '學識 > 9500', check: (s, k) => computeReadTotalUntil(k) > 9500, forF: true },
            { text: '才幹 > 6500', check: (s, k) => computeJobTotalUntil(k) > 6500, forF: true }
          ]},
          { id: 'cz_be1', type: 'BE', name: '洛川遺恨', date: '2027-01-10', conditions: [
            { text: '文彩 < 6800 或學識 < 10000 或未獲得【心囚】', check: (s, k) => computeFictionTotalUntil(k) < 6800 || computeReadTotalUntil(k) < 10000 || !s.trophyConditions['發布第一篇小說'], forBE: true }
          ]},
          { id: 'cz_r2', type: 'R', name: '揾英雄淚', altName: '別後悠悠', altType: 'BE', date: '2027-02-28', conditions: [
            { text: '德行 < 9000 或學識 < 11000 或未獲得【仙釀】', check: (s, k) => computeLifeTotalUntil(k) < 9000 || computeReadTotalUntil(k) < 11000 || !s.trophyConditions['發布第二篇小說'], forBE: true },
            { text: '獲得【仙釀】', check: (s, k) => !!s.trophyConditions['發布第二篇小說'], forR: true },
            { text: '好感度 > 4500', check: (s, k) => getCharAffinity(s, '曹植', k) > 4500, forR: true },
            { text: '神交 > 20', check: (s, k) => getUnionCount(s, '曹植', k) > 20, forR: true },
            { text: '文彩 > 8200', check: (s, k) => computeFictionTotalUntil(k) > 8200, forR: true },
            { text: '財富 > 50000', check: (s, k) => computeMoneyTotalUntil(k) > 50000, forR: true }
          ]},
          { id: 'cz_ge', type: 'GE', name: '神遊八級', date: '2027-03-30', conditions: [
            { text: '好感度 > 5500', check: (s, k) => getCharAffinity(s, '曹植', k) > 5500 },
            { text: '神交 > 25', check: (s, k) => getUnionCount(s, '曹植', k) > 25 },
            { text: '文彩 > 9000', check: (s, k) => computeFictionTotalUntil(k) > 9000 }
          ]}
        ]
      },
      '郭嘉': {
        attribute: '逍遙',
        attributeKey: 'moneyFreedom',
        unionEvent: '春江',
        unionKey: 'chunjiang',
        stories: [
          { id: 'gj_s1', type: 'S', name: '巧娘', date: '2026-03-10', conditions: [
            { text: '獲得【璞玉渾金】', check: (s, k) => !!s.trophyConditions['理財習慣養成30日'] }
          ]},
          { id: 'gj_s2', type: 'S', name: '明珠', date: '2026-03-31', conditions: [
            { text: '才幹 > 1500', check: (s, k) => computeJobTotalUntil(k) > 1500 },
            { text: '聲望 > 500', check: (s, k) => computeThesisTotalUntil(k) > 500 }
          ]},
          { id: 'gj_r1', type: 'R', name: '心有靈犀', altName: '林中客', altType: 'F', date: '2026-05-20', isBEAlt: true, beName: '空悲切', conditions: [
            { text: '獲得【雙飛雁】', check: (s, k) => !!s.trophyConditions['理財習慣養成90日'] || !!s.trophyConditions['作息習慣養成90日'], forR: true },
            { text: '獲得【雙飛雁】', check: (s, k) => !!s.trophyConditions['理財習慣養成90日'] || !!s.trophyConditions['作息習慣養成90日'], forF: true },
            { text: '好感度 > 1500', check: (s, k) => getCharAffinity(s, '郭嘉', k) > 1500, forR: true },
            { text: '好感度 > 1500', check: (s, k) => getCharAffinity(s, '郭嘉', k) > 1500, forF: true },
            { text: '春江 > 10', check: (s, k) => getUnionCount(s, '郭嘉', k) > 10, forR: true },
            { text: '聲望 > 1400', check: (s, k) => computeThesisTotalUntil(k) > 1400, forR: true },
            { text: '學識 > 3200', check: (s, k) => computeReadTotalUntil(k) > 3200, forR: true },
            { text: '德行 > 2400', check: (s, k) => computeLifeTotalUntil(k) > 2400, forF: true },
            { text: '財富 > 13000', check: (s, k) => computeMoneyTotalUntil(k) > 13000, forF: true },
            { text: '才幹 < 2400 或 起居錄 < 60', check: (s, k) => computeJobTotalUntil(k) < 2400 || computeLifeStreakUntil(k) < 60, forBE: true }
          ]},
          { id: 'gj_r2', type: 'R', name: '渡情', altName: '神傷夢碎', altType: 'BE', date: '2026-06-30', conditions: [
            { text: '聲望 < 2000 或財富 < 17000 或荀彧好感度 < 1800', check: (s, k) => computeThesisTotalUntil(k) < 2000 || computeMoneyTotalUntil(k) < 17000 || getCharAffinity(s, '荀彧', k) < 1800, forBE: true },
            { text: '好感度 > 2400', check: (s, k) => getCharAffinity(s, '郭嘉', k) > 2400, forR: true },
            { text: '春江 > 15', check: (s, k) => getUnionCount(s, '郭嘉', k) > 15, forR: true },
            { text: '德行 > 3600', check: (s, k) => computeLifeTotalUntil(k) > 3600, forR: true },
            { text: '才幹 > 4300', check: (s, k) => computeJobTotalUntil(k) > 4300, forR: true },
            { text: '學識 > 4500', check: (s, k) => computeReadTotalUntil(k) > 4500, forR: true }
          ]},
          { id: 'gj_ge', type: 'GE', name: '比翼齊飛', date: '2026-09-10', conditions: [
            { text: '好感度 > 3000', check: (s, k) => getCharAffinity(s, '郭嘉', k) > 3000 },
            { text: '春江 > 25', check: (s, k) => getUnionCount(s, '郭嘉', k) > 25 },
            { text: '才幹 > 5500', check: (s, k) => computeJobTotalUntil(k) > 5500 },
            { text: '學識 > 6800', check: (s, k) => computeReadTotalUntil(k) > 6800 },
            { text: '文彩 > 4000', check: (s, k) => computeFictionTotalUntil(k) > 4000 },
            { text: '財富 > 28000', check: (s, k) => computeMoneyTotalUntil(k) > 28000 }
          ]}
        ]
      },
      '荀彧': {
        attribute: '風儀',
        attributeKey: 'lifeGrace',
        unionEvent: '蘭澤',
        unionKey: 'lanze',
        stories: [
          { id: 'xy_s1', type: 'S', name: '門人', date: '2026-03-10', conditions: [
            { text: '獲得【珠聯璧合】', check: (s, k) => !!s.trophyConditions['作息習慣養成30日'] }
          ]},
          { id: 'xy_s2', type: 'S', name: '奇才', date: '2026-03-31', conditions: [
            { text: '學識 > 1500', check: (s, k) => computeReadTotalUntil(k) > 1500 },
            { text: '文彩 > 500', check: (s, k) => computeFictionTotalUntil(k) > 500 }
          ]},
         { id: 'xy_r1', type: 'R', name: '人面桃花', altName: '誼切岑苔', altType: 'F', date: '2026-05-20', isBEAlt: true, beName: '尋尋覓覓', conditions: [
            { text: '獲得【鳳求凰】', check: (s, k) => !!s.trophyConditions['理財習慣養成90日'] || !!s.trophyConditions['作息習慣養成90日'], forR: true },
            { text: '獲得【鳳求凰】', check: (s, k) => !!s.trophyConditions['理財習慣養成90日'] || !!s.trophyConditions['作息習慣養成90日'], forF: true },
            { text: '好感度 > 1500', check: (s, k) => getCharAffinity(s, '荀彧', k) > 1500, forR: true },
            { text: '好感度 > 1500', check: (s, k) => getCharAffinity(s, '荀彧', k) > 1500, forF: true },
            { text: '蘭澤 > 10', check: (s, k) => getUnionCount(s, '荀彧', k) > 10, forR: true },
            { text: '文彩 > 1500', check: (s, k) => computeFictionTotalUntil(k) > 1500, forR: true },
            { text: '德行 > 2600', check: (s, k) => computeLifeTotalUntil(k) > 2600, forR: true },
            { text: '才幹 > 2600', check: (s, k) => computeJobTotalUntil(k) > 2600, forF: true },
            { text: '學識 > 3000', check: (s, k) => computeReadTotalUntil(k) > 3000, forF: true },
            { text: '聲望 < 1200 或 聚寶盆 < 60', check: (s, k) => computeThesisTotalUntil(k) < 1200 || computeMoneyStreakUntil(k) < 60, forBE: true }
          ]},
          { id: 'xy_r2', type: 'R', name: '家有萌妻', date: '2026-06-10', conditions: [
            { text: '好感度 > 2000', check: (s, k) => getCharAffinity(s, '荀彧', k) > 2000 },
            { text: '蘭澤 > 12', check: (s, k) => getUnionCount(s, '荀彧', k) > 12 },
            { text: '聲望 > 1800', check: (s, k) => computeThesisTotalUntil(k) > 1800 },
            { text: '才幹 > 3000', check: (s, k) => computeJobTotalUntil(k) > 3000 }
          ]},
          { id: 'xy_be2', type: 'BE', name: '離騷', date: '2026-08-31', conditions: [
            { text: '聲望 < 3500 或學識 < 6200 或郭嘉BE', check: (s, k) => computeThesisTotalUntil(k) < 3500 || computeReadTotalUntil(k) < 6200 || isCharBE(s, '郭嘉'), forBE: true }
          ]},
          { id: 'xy_ge', type: 'GE', name: '舉案齊眉', date: '2026-10-31', conditions: [
            { text: '好感度 > 4000', check: (s, k) => getCharAffinity(s, '荀彧', k) > 4000 },
            { text: '蘭澤 > 30', check: (s, k) => getUnionCount(s, '荀彧', k) > 30 },
            { text: '聲望 > 5000', check: (s, k) => computeThesisTotalUntil(k) > 5000 },
            { text: '德行 > 6800', check: (s, k) => computeLifeTotalUntil(k) > 6800 },
            { text: '才幹 > 6200', check: (s, k) => computeJobTotalUntil(k) > 6200 },
            { text: '學識 > 8500', check: (s, k) => computeReadTotalUntil(k) > 8500 }
          ]}
        ]
      },
      '司馬懿': {
        attribute: '異心',
        attributeKey: 'readDifferent',
        unionEvent: '野合',
        unionKey: 'yehe',
        stories: [
          { id: 'smy_s1', type: 'S', name: '丫頭', date: '2026-04-10', conditions: [
            { text: '獲得【偏安一隅】', check: (s, k) => !!s.trophyConditions['讀完《判斷力批判》'] }
          ]},
          { id: 'smy_s2', type: 'S', name: '同僚', date: '2026-04-30', conditions: [
            { text: '才幹 > 2000', check: (s, k) => computeJobTotalUntil(k) > 2000 },
            { text: '學識 > 2500', check: (s, k) => computeReadTotalUntil(k) > 2500 }
          ]},
          { id: 'smy_r1', type: 'R', name: '暗送秋波', altName: '鷹視狼顧', altType: 'F', date: '2026-08-10', conditions: [
            { text: '好感度 > 2000', check: (s, k) => getCharAffinity(s, '司馬懿', k) > 2000, common: true },
            { text: '野合 > 10', check: (s, k) => getUnionCount(s, '司馬懿', k) > 10, forR: true },
            { text: '財富 > 24000', check: (s, k) => computeMoneyTotalUntil(k) > 24000, forR: true },
            { text: '才幹 > 4900', check: (s, k) => computeJobTotalUntil(k) > 4900, forR: true },
            { text: '聲望 > 3200', check: (s, k) => computeThesisTotalUntil(k) > 3200, forF: true },
            { text: '學識 > 5800', check: (s, k) => computeReadTotalUntil(k) > 5800, forF: true }
          ]},
          { id: 'smy_r2', type: 'R', name: '紅杏出牆', date: '2026-10-10', conditions: [
            { text: '獲得【食髓知味】或【貓頭鷹拍檔】', check: (s, k) => !!s.trophyConditions['讀完《純粹理性批判》'] || !!s.trophyConditions['讀完康德實踐哲學論文集'] },
            { text: '好感度 > 3000', check: (s, k) => getCharAffinity(s, '司馬懿', k) > 3000 },
            { text: '野合 > 20', check: (s, k) => getUnionCount(s, '司馬懿', k) > 20 },
            { text: '才幹 > 5900', check: (s, k) => computeJobTotalUntil(k) > 5900 },
            { text: '財富 > 32000', check: (s, k) => computeMoneyTotalUntil(k) > 32000 }
          ]},
          { id: 'smy_be1', type: 'BE', name: '利令智昏', date: '2026-11-20', conditions: [
            { text: '與劉協R1/F且學識<9000或德行<7000或聲望<5200', check: (s, k) => (hasCharRorF(s, '劉協', 1)) && (computeReadTotalUntil(k) < 9000 || computeLifeTotalUntil(k) < 7000 || computeThesisTotalUntil(k) < 5200), forBE: true }
          ]},
          { id: 'smy_be2', type: 'BE', name: '背信棄義', date: '2027-02-01', conditions: [
            { text: '曹丕為BE2狀態', check: (s, k) => s.romance?.['曹丕']?.unlocked?.includes('cp_ge_be'), forBE: true }
          ]},
          { id: 'smy_ge', type: 'GE', name: '日月同輝', altName: '招魂楚些', altType: 'BE', date: '2027-03-30', conditions: [
            { text: '達成曹丕GE後', check: (s, k) => s.romance?.['曹丕']?.unlocked?.includes('cp_ge_ge'), forGE: true },
            { text: '達成曹丕GE後', check: (s, k) => s.romance?.['曹丕']?.unlocked?.includes('cp_ge_ge'), forBE: true },
            { text: '野合 > 巫山', check: (s, k) => getUnionCount(s, '司馬懿', k) > getUnionCount(s, '曹丕', k), forGE: true },
            { text: '野合 > 巫山', check: (s, k) => getUnionCount(s, '司馬懿', k) > getUnionCount(s, '曹丕', k), forBE: true },
            { text: '曹丕好感度 > 司馬懿 或 未同時獲得【食髓知味】和【貓頭鷹拍檔】', check: (s, k) => getCharAffinity(s, '曹丕', k) > getCharAffinity(s, '司馬懿', k) || !(s.trophyConditions['讀完《純粹理性批判》'] && s.trophyConditions['讀完康德實踐哲學論文集']), forBE: true },
            { text: '同時獲得【食髓知味】和【貓頭鷹拍檔】', check: (s, k) => !!s.trophyConditions['讀完《純粹理性批判》'] && !!s.trophyConditions['讀完康德實踐哲學論文集'], forGE: true },
            { text: '曹丕好感度 < 司馬懿', check: (s, k) => getCharAffinity(s, '曹丕', k) < getCharAffinity(s, '司馬懿', k), forGE: true }
          ]}
        ]
      }
    };

    // 輔助函數：獲取角色好感度
    function getCharAffinity(s, charName, untilKey) {
      if (!s.romance || !s.romance[charName]) return 0;
      let total = 0;
      const records = s.romance[charName].affinityRecords || [];
      records.forEach(r => {
        if (r.date <= untilKey) total += r.value;
      });
      return total;
    }

    // 輔助函數：獲取結合事件次數
    function getUnionCount(s, charName, untilKey) {
      if (!s.romance || !s.romance[charName]) return 0;
      const records = s.romance[charName].affinityRecords || [];
      let count = 0;
      records.forEach(r => {
        if (r.date <= untilKey && r.hasUnion) count++;
      });
      return count;
    }

    // 輔助函數：判斷角色是否處於BE狀態
    function isCharBE(s, charName) {
      if (!s.romance || !s.romance[charName]) return false;
      const unlocked = s.romance[charName].unlocked || [];
      return unlocked.some(id => id.includes('_be'));
    }

    // 輔助函數：判斷角色是否處於F關係
    function isCharF(s, charName) {
      if (!s.romance || !s.romance[charName]) return false;
      const unlocked = s.romance[charName].unlocked || [];
      return unlocked.some(id => id.includes('_f'));
    }

    // 輔助函數：判斷角色是否有R或F達到某階段
    function hasCharRorF(s, charName, stage) {
      if (!s.romance || !s.romance[charName]) return false;
      const unlocked = s.romance[charName].unlocked || [];
      return unlocked.some(id => id.includes(`_r${stage}`) || id.includes(`_f`));
    }

// 判斷角色是否解鎖（可查看面板）- 根據獎盃條件判斷
    function isCharUnlocked(s, charName) {
      // 曹丕默認解鎖
      if (charName === '曹丕') return true;
      
      // 根據characters數據中的unlockCondition判斷
      const char = characters.find(c => c.name === charName);
      if (!char) return false;
      if (!char.unlockCondition) return true; // 無解鎖條件則默認解鎖
      
      // 查找對應的獎盃
      const trophy = trophyData.find(t => t.name === char.unlockCondition);
      if (!trophy) return false;
      
      // 檢查獎盃條件是否全部達成
      if (trophy.defaultUnlocked) return true;
      if (!trophy.conditions || trophy.conditions.length === 0) return true;
      
      return trophy.conditions.every(c => !!s.trophyConditions[c]);
    }

    // 判斷今日是否已轉過轉盤
    function hasSpunToday(s, dateKey) {
      return s.romance?.spinHistory?.[dateKey] === true;
    }

    // 角色問候語（來自原文件）
    const greetings = {
      '曹丕': {
        morning: ['晨光熹微，卿可安好？','今日之計在於晨。','早起之人，方能掌局。'],
        afternoon: ['午後慵懶，不妨小憩。','午后之時，宜思今日大計。'],
        evening: ['暮色將至，卿今日可還順遂？','斜陽在外，心事在懷。'],
        night: ['夜深人靜，卿可還未安寢？','月色正好，莫累壞身子。']
      },
      '劉協': {
        morning: ['朕今日研習醫術。'],
        afternoon: ['午間閒適，朕翻閱古籍。'],
        evening: ['日落西山，朕佇立窗前。'],
        night: ['願卿今夜好眠。']
      },
      '郭嘉': {
        morning: ['呵，這麼早？'],
        afternoon: ['午後小酌，人生樂事。'],
        evening: ['人生苦短，當及時行樂。'],
        night: ['夜色正好，適合飲酒作樂。']
      },
      '荀彧': {
        morning: ['晨起當思今日之事。'],
        afternoon: ['午後當靜心養性。'],
        evening: ['日暮歸鴉，卿今日辛苦了。'],
        night: ['夜深露重，卿當注意身體。']
      },
      '曹植': {
        morning: ['晨光如詩！'],
        afternoon: ['才思泉湧！'],
        evening: ['斜陽入酒，詩意盎然。'],
        night: ['月下獨酌，思卿如狂。']
      },
      '司馬懿': {
        morning: ['早安。今日有何打算？'],
        afternoon: ['午後宜靜觀其變。'],
        evening: ['日落而息，明日再戰。'],
        night: ['夜深了，卿還不休息？']
      }
    };

    // 家務項目（店鋪清潔 / 氣質）
    const houseworkItems = [
      { id: 'floor', name: '地面清潔' },
      { id: 'dishes', name: '碗筷廚房' },
      { id: 'trash', name: '垃圾雜物' },
      { id: 'laundry', name: '洗曬外衣' },
      { id: 'underwear', name: '內衣褲襪' },
      { id: 'deep', name: '深度清潔' }
    ];

    const houseworkStates = [
      { value: 'reasonable', label: '合理擱置', deduction: 0 },
      { value: 'canDo_notDone', label: '可做未做', deduction: 5 },
      { value: 'canDo_done', label: '可做已做', deduction: 0 },
      { value: 'mustDo_notDone', label: '必做未做', deduction: 20 },
      { value: 'mustDo_done', label: '必做已做', deduction: 0 }
    ];

    // 標籤顏色與選項
    const tagColors = { yellow: '#f0c020', orange: '#e07020', red: '#c04040', none: 'transparent' };
    const tagOptions = [
      { value: 'none', label: '無', color: 'transparent' },
      { value: 'yellow', label: '一般', color: '#f0c020' },
      { value: 'orange', label: '中等', color: '#e07020' },
      { value: 'red', label: '高難', color: '#c04040' },
    ];

    // ===== 工具函數 =====
    const todayKey = () => dateKeyFromDate(new Date());

    function dateKeyFromDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function dateFromKey(key) {
      const [y, m, d] = key.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function addDays(d, delta) {
      const nd = new Date(d.getTime());
      nd.setDate(nd.getDate() + delta);
      return nd;
    }

    function getGameYear(date) {
      let result = { year: 210, era: '建安十五年' };
      for (const m of milestones) {
        if (date >= new Date(m.realDate)) result = { year: m.year, era: m.era };
      }
      return result;
    }

    function formatTime(date) {
      return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }

    function formatDateFull(date) {
      return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    // 判斷某日期是否 <= 選中的日期（用於累計計算）
    function isDateOnOrBefore(checkKey, referenceKey) {
      return checkKey <= referenceKey;
    }

    // ===== 狀態管理 =====
    let state = {
      selectedDateKey: todayKey(),
      
      // 聯絡客戶
      job: {
        offerDate: null,
        badges: { stage1: false, stage2: false, stage3: false, final: false },
        dailyEntries: {} // dateKey -> [{id, type, amount, timestamp}]
      },
      
      // 雅客宴遊（論文）
      thesis: {
        projects: [], // [{id, name, done, doneDate}]
        dailyEntries: {} // dateKey -> [{id, words, projectId, timestamp}]
      },
      
      // 財務管理
      money: {
        dailyEntries: {} // dateKey -> [{id, main, sub, amount, note, timestamp}]
      },
      
      // 組織經營（生活）
      life: {
        daily: {}, // dateKey -> {sleepTime, wakeTime, water, bowel, ...}
        waterLogs: {}, // dateKey -> [{id, amount, type, timestamp}]
        nutritionLogs: {}, // dateKey -> [{id, score, meal, note, timestamp}]
        selfDevLogs: {}, // dateKey -> [{id, hours, note, timestamp}]
        outingLogs: {}, // dateKey -> [{id, count, note, timestamp}]
        funLogs: {}, // dateKey -> [{id, hours, note, timestamp}]
        emptyLogs: {} // dateKey -> [{id, hours, note, timestamp}]
      },
      
      // 新書發布（創作）
      fiction: {
        projects: [],
        dailyEntries: {}
      },
      
      // 謄錄經典（閱讀）
      reading: {
        projects: [], // [{id, name, totalPages, currentPage, done, doneDate}]
        dailyEntries: {}
      },
      
      // 店鋪清潔（氣質）- 按日期存儲
      housework: {}, // dateKey -> {floor: 'reasonable', ...}
      
      // 動態軸
      timeline: {}, // dateKey -> [{id, text, images:[], timestamp, tag, isAuto, autoData}]
      
      // 記事本
      notepad: {}, // dateKey -> htmlContent
      
      // 獎杯條件
      trophyConditions: {}
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const obj = JSON.parse(raw);
          state = deepMerge(state, obj);
        }
      } catch (e) {
        console.error('loadState error', e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('saveState error', e);
      }
    }

    function deepMerge(target, source) {
      const result = { ...target };
      for (const key in source) {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
          result[key] = deepMerge(target[key] || {}, source[key]);
        } else {
          result[key] = source[key];
        }
      }
      return result;
    }

    // ===== 數據管理功能 =====
    
    // 獲取數據概覽信息
    function getDataOverview() {
      const stats = {
        totalDays: Object.keys(state.life.daily || {}).length,
        jobEntries: Object.values(state.job.dailyEntries || {}).flat().length,
        thesisEntries: Object.values(state.thesis.dailyEntries || {}).flat().length,
        moneyEntries: Object.values(state.money.dailyEntries || {}).flat().length,
        fictionEntries: Object.values(state.fiction.dailyEntries || {}).flat().length,
        readingEntries: Object.values(state.reading.dailyEntries || {}).flat().length,
        timelineEntries: Object.values(state.timeline || {}).flat().length,
        thesisProjects: (state.thesis.projects || []).length,
        fictionProjects: (state.fiction.projects || []).length,
        readingProjects: (state.reading.projects || []).length,
        trophies: Object.keys(state.trophyConditions || {}).filter(k => state.trophyConditions[k]).length,
        romanceChars: Object.keys(state.romance || {}).length
      };
      
      // 計算數據大小
      const dataStr = JSON.stringify(state);
      const dataSize = new Blob([dataStr]).size;
      const dataSizeKB = (dataSize / 1024).toFixed(2);
      
      return { ...stats, dataSize: dataSizeKB };
    }
    
    // 渲染數據概覽
    function renderDataOverview() {
      const overview = getDataOverview();
      const el = document.getElementById('dataOverview');
      if (!el) return;
      
      el.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;">
          <div>📅 記錄天數：<strong>${overview.totalDays}</strong> 天</div>
          <div>💼 就職記錄：<strong>${overview.jobEntries}</strong> 條</div>
          <div>📝 論文記錄：<strong>${overview.thesisEntries}</strong> 條</div>
          <div>💰 財務記錄：<strong>${overview.moneyEntries}</strong> 條</div>
          <div>✍️ 創作記錄：<strong>${overview.fictionEntries}</strong> 條</div>
          <div>📚 閱讀記錄：<strong>${overview.readingEntries}</strong> 條</div>
          <div>📜 動態數量：<strong>${overview.timelineEntries}</strong> 條</div>
          <div>🏆 獲得獎盃：<strong>${overview.trophies}</strong> 個</div>
          <div>💕 戀愛進度：<strong>${overview.romanceChars}</strong> 位角色</div>
          <div>📦 數據大小：<strong>${overview.dataSize}</strong> KB</div>
        </div>
      `;
    }
    
    // 顯示操作日誌
    function showDataManagerLog(message, isError = false) {
      const log = document.getElementById('dataManagerLog');
      if (!log) return;
      
      log.style.display = 'block';
      const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const color = isError ? '#c04040' : '#4a7c59';
      log.innerHTML = `<span style="color:${color}">[${time}] ${message}</span><br>` + log.innerHTML;
      
      // 限制日誌長度
      const lines = log.innerHTML.split('<br>');
      if (lines.length > 10) {
        log.innerHTML = lines.slice(0, 10).join('<br>');
      }
    }
    
    // 導出為 JSON 檔案
    function exportToJsonFile() {
      try {
        const exportData = {
          version: '4.8',
          exportDate: new Date().toISOString(),
          exportDateKey: todayKey(),
          data: state
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `caopi_backup_${todayKey()}_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showDataManagerLog('數據已成功導出為 JSON 檔案');
      } catch (e) {
        console.error('Export error:', e);
        showDataManagerLog('導出失敗：' + e.message, true);
      }
    }
    
    // 複製到剪貼簿
    async function exportToClipboard() {
      try {
        const exportData = {
          version: '4.8',
          exportDate: new Date().toISOString(),
          exportDateKey: todayKey(),
          data: state
        };
        
        const dataStr = JSON.stringify(exportData);
        await navigator.clipboard.writeText(dataStr);
        showDataManagerLog('數據已複製到剪貼簿');
        alert('數據已複製到剪貼簿！');
      } catch (e) {
        console.error('Clipboard export error:', e);
        showDataManagerLog('複製失敗：' + e.message, true);
        alert('複製失敗，請嘗試導出為檔案');
      }
    }
    
    // 暫存導入數據
    let pendingImportData = null;
    let pendingMergeData = null;
    
    // 解析導入數據
    function parseImportData(dataStr) {
      try {
        const parsed = JSON.parse(dataStr);
        
        // 檢查是否為有效的備份格式
        if (parsed.data && typeof parsed.data === 'object') {
          return { 
            success: true, 
            data: parsed.data, 
            meta: {
              version: parsed.version || '未知',
              exportDate: parsed.exportDate || '未知',
              exportDateKey: parsed.exportDateKey || '未知'
            }
          };
        } else if (parsed.selectedDateKey !== undefined) {
          // 舊格式：直接是 state 物件
          return { 
            success: true, 
            data: parsed,
            meta: {
              version: '舊版本',
              exportDate: '未知',
              exportDateKey: '未知'
            }
          };
        }
        
        return { success: false, error: '無法識別的數據格式' };
      } catch (e) {
        return { success: false, error: '解析 JSON 失敗：' + e.message };
      }
    }
    
    // 生成導入預覽
    function generateImportPreview(importData, meta) {
      const currentOverview = getDataOverview();
      
      // 計算導入數據的概覽
      const importStats = {
        totalDays: Object.keys(importData.life?.daily || {}).length,
        jobEntries: Object.values(importData.job?.dailyEntries || {}).flat().length,
        thesisEntries: Object.values(importData.thesis?.dailyEntries || {}).flat().length,
        moneyEntries: Object.values(importData.money?.dailyEntries || {}).flat().length,
        fictionEntries: Object.values(importData.fiction?.dailyEntries || {}).flat().length,
        readingEntries: Object.values(importData.reading?.dailyEntries || {}).flat().length,
        timelineEntries: Object.values(importData.timeline || {}).flat().length,
        trophies: Object.keys(importData.trophyConditions || {}).filter(k => importData.trophyConditions[k]).length
      };
      
      return `
        <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px dashed rgba(178,144,90,0.3);">
          <strong>備份信息</strong><br>
          版本：${meta.version}<br>
          導出時間：${meta.exportDate !== '未知' ? new Date(meta.exportDate).toLocaleString('zh-TW') : '未知'}<br>
          導出日期：${meta.exportDateKey}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div>
            <strong>當前數據</strong><br>
            記錄天數：${currentOverview.totalDays}<br>
            就職記錄：${currentOverview.jobEntries}<br>
            論文記錄：${currentOverview.thesisEntries}<br>
            財務記錄：${currentOverview.moneyEntries}<br>
            動態數量：${currentOverview.timelineEntries}<br>
            獎盃數量：${currentOverview.trophies}
          </div>
          <div>
            <strong style="color:#c08020;">導入數據</strong><br>
            記錄天數：${importStats.totalDays}<br>
            就職記錄：${importStats.jobEntries}<br>
            論文記錄：${importStats.thesisEntries}<br>
            財務記錄：${importStats.moneyEntries}<br>
            動態數量：${importStats.timelineEntries}<br>
            獎盃數量：${importStats.trophies}
          </div>
        </div>
        <div style="margin-top:10px;padding:8px;background:rgba(192,64,64,0.1);border-radius:4px;color:#c04040;">
          ⚠️ 確認導入將完全覆蓋當前數據！
        </div>
      `;
    }
    
    // 執行導入
    function executeImport(importData) {
      try {
        state = deepMerge({
          selectedDateKey: todayKey(),
          job: { offerDate: null, badges: {}, dailyEntries: {} },
          thesis: { projects: [], dailyEntries: {} },
          money: { dailyEntries: {} },
          life: { daily: {} },
          fiction: { projects: [], dailyEntries: {} },
          reading: { projects: [], dailyEntries: {} },
          housework: {},
          timeline: {},
          notepad: {},
          trophyConditions: {},
          romance: {}
        }, importData);
        
        state.selectedDateKey = todayKey(); // 強制設為今天
        saveState();
        renderAll();
        renderDataOverview();
        showDataManagerLog('數據導入成功！');
        alert('數據導入成功！');
        return true;
      } catch (e) {
        console.error('Import execute error:', e);
        showDataManagerLog('導入執行失敗：' + e.message, true);
        alert('導入失敗：' + e.message);
        return false;
      }
    }
    
    // 從檔案導入
    function importFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = parseImportData(e.target.result);
        if (result.success) {
          pendingImportData = result.data;
          document.getElementById('importPreviewContent').innerHTML = 
            generateImportPreview(result.data, result.meta);
          openModal('importPreviewModalOverlay');
        } else {
          showDataManagerLog(result.error, true);
          alert('導入失敗：' + result.error);
        }
      };
      reader.onerror = () => {
        showDataManagerLog('讀取檔案失敗', true);
        alert('讀取檔案失敗');
      };
      reader.readAsText(file);
    }
    
    // 從剪貼簿導入
    async function importFromClipboard() {
      try {
        const dataStr = await navigator.clipboard.readText();
        const result = parseImportData(dataStr);
        if (result.success) {
          pendingImportData = result.data;
          document.getElementById('importPreviewContent').innerHTML = 
            generateImportPreview(result.data, result.meta);
          openModal('importPreviewModalOverlay');
        } else {
          showDataManagerLog(result.error, true);
          alert('導入失敗：' + result.error);
        }
      } catch (e) {
        showDataManagerLog('讀取剪貼簿失敗：' + e.message, true);
        alert('讀取剪貼簿失敗，請確認已複製有效的備份數據');
      }
    }
    
    // 智能合併兩份數據
    function mergeData(currentData, newData) {
      const merged = JSON.parse(JSON.stringify(currentData)); // 深拷貝
      
      // 合併每日條目類數據（取並集）
      const mergeEntries = (current, incoming) => {
        const result = { ...current };
        for (const dateKey in incoming) {
          if (!result[dateKey]) {
            result[dateKey] = incoming[dateKey];
          } else {
            // 合併同一天的條目，根據 id 去重
            const existingIds = new Set(result[dateKey].map(e => e.id));
            incoming[dateKey].forEach(entry => {
              if (!existingIds.has(entry.id)) {
                result[dateKey].push(entry);
              }
            });
          }
        }
        return result;
      };
      
      // 合併項目列表（根據 id 去重）
      const mergeProjects = (current, incoming) => {
        const result = [...current];
        const existingMap = new Map(result.map(p => [p.id, p]));
        incoming.forEach(proj => {
          if (!existingMap.has(proj.id)) {
            result.push(proj);
          } else {
            // 合併現有項目的進度（取較大的頁碼）
            const existing = existingMap.get(proj.id);
            if (proj.currentPage !== undefined && (existing.currentPage === undefined || proj.currentPage > existing.currentPage)) {
              existing.currentPage = proj.currentPage;
            }
            if (proj.totalPages !== undefined && !existing.totalPages) {
              existing.totalPages = proj.totalPages;
            }
            // 如果新數據已完成，標記為完成
            if (proj.done && !existing.done) {
              existing.done = true;
              existing.doneDate = proj.doneDate;
            }
          }
        });
        return result;
      };
      
      // 合併生活習慣數據（較新的優先）
      const mergeLifeDaily = (current, incoming) => {
        const result = { ...current };
        for (const dateKey in incoming) {
          if (!result[dateKey]) {
            result[dateKey] = incoming[dateKey];
          } else {
            // 保留有值的欄位
            for (const field in incoming[dateKey]) {
              if (incoming[dateKey][field] !== null && result[dateKey][field] === null) {
                result[dateKey][field] = incoming[dateKey][field];
              }
            }
          }
        }
        return result;
      };
      
      // 合併獎盃（OR 運算）
      const mergeTrophies = (current, incoming) => {
        const result = { ...current };
        for (const key in incoming) {
          if (incoming[key]) {
            result[key] = true;
          }
        }
        return result;
      };
      
      // 執行合併
      if (newData.job?.dailyEntries) {
        merged.job.dailyEntries = mergeEntries(merged.job?.dailyEntries || {}, newData.job.dailyEntries);
      }
      if (newData.thesis?.dailyEntries) {
        merged.thesis.dailyEntries = mergeEntries(merged.thesis?.dailyEntries || {}, newData.thesis.dailyEntries);
      }
      if (newData.thesis?.projects) {
        merged.thesis.projects = mergeProjects(merged.thesis?.projects || [], newData.thesis.projects);
      }
      if (newData.money?.dailyEntries) {
        merged.money.dailyEntries = mergeEntries(merged.money?.dailyEntries || {}, newData.money.dailyEntries);
      }
      if (newData.fiction?.dailyEntries) {
        merged.fiction.dailyEntries = mergeEntries(merged.fiction?.dailyEntries || {}, newData.fiction.dailyEntries);
      }
      if (newData.fiction?.projects) {
        merged.fiction.projects = mergeProjects(merged.fiction?.projects || [], newData.fiction.projects);
      }
      if (newData.reading?.dailyEntries) {
        merged.reading.dailyEntries = mergeEntries(merged.reading?.dailyEntries || {}, newData.reading.dailyEntries);
      }
      if (newData.reading?.projects) {
        merged.reading.projects = mergeProjects(merged.reading?.projects || [], newData.reading.projects);
      }
      if (newData.life?.daily) {
        merged.life.daily = mergeLifeDaily(merged.life?.daily || {}, newData.life.daily);
      }
      if (newData.life?.waterLogs) {
        merged.life.waterLogs = merged.life.waterLogs || {};
        for (const dateKey in newData.life.waterLogs) {
          if (!merged.life.waterLogs[dateKey]) {
            merged.life.waterLogs[dateKey] = newData.life.waterLogs[dateKey];
          } else {
            const existingIds = new Set(merged.life.waterLogs[dateKey].map(l => l.id));
            newData.life.waterLogs[dateKey].forEach(log => {
              if (!existingIds.has(log.id)) {
                merged.life.waterLogs[dateKey].push(log);
              }
            });
          }
        }
      }
      if (newData.timeline) {
        merged.timeline = mergeEntries(merged.timeline || {}, newData.timeline);
      }
      if (newData.notepad) {
        // 記事本：新數據優先
        merged.notepad = { ...(merged.notepad || {}), ...newData.notepad };
      }
      if (newData.housework) {
        // 家務：新數據優先
        merged.housework = { ...(merged.housework || {}), ...newData.housework };
      }
      if (newData.trophyConditions) {
        merged.trophyConditions = mergeTrophies(merged.trophyConditions || {}, newData.trophyConditions);
      }
      if (newData.romance) {
        // 戀愛進度：深度合併
        merged.romance = merged.romance || {};
        for (const charName in newData.romance) {
          if (!merged.romance[charName]) {
            merged.romance[charName] = newData.romance[charName];
          } else {
            // 合併好感度記錄
            if (newData.romance[charName].affinityRecords) {
              const existingIds = new Set((merged.romance[charName].affinityRecords || []).map(r => r.id || (r.date + r.value)));
              (newData.romance[charName].affinityRecords || []).forEach(record => {
                const recordId = record.id || (record.date + record.value);
                if (!existingIds.has(recordId)) {
                  merged.romance[charName].affinityRecords = merged.romance[charName].affinityRecords || [];
                  merged.romance[charName].affinityRecords.push(record);
                }
              });
            }
            // 合併解鎖的劇情
            if (newData.romance[charName].unlocked) {
              merged.romance[charName].unlocked = merged.romance[charName].unlocked || [];
              newData.romance[charName].unlocked.forEach(item => {
                if (!merged.romance[charName].unlocked.includes(item)) {
                  merged.romance[charName].unlocked.push(item);
                }
              });
            }
            // 合併結合事件記錄
            if (newData.romance[charName].unionRecords) {
              const existingIds = new Set((merged.romance[charName].unionRecords || []).map(r => r.id || r.date));
              (newData.romance[charName].unionRecords || []).forEach(record => {
                const recordId = record.id || record.date;
                if (!existingIds.has(recordId)) {
                  merged.romance[charName].unionRecords = merged.romance[charName].unionRecords || [];
                  merged.romance[charName].unionRecords.push(record);
                }
              });
            }
          }
        }
      }
      
      // Job badges 合併（OR 運算）
      if (newData.job?.badges) {
        merged.job.badges = merged.job.badges || {};
        for (const key in newData.job.badges) {
          if (newData.job.badges[key]) {
            merged.job.badges[key] = true;
          }
        }
      }
      
      // Offer date 取較早的
      if (newData.job?.offerDate && (!merged.job.offerDate || newData.job.offerDate < merged.job.offerDate)) {
        merged.job.offerDate = newData.job.offerDate;
      }
      
      return merged;
    }
    
    // 生成合併預覽
    function generateMergePreview(currentData, newData, mergedData) {
      const currentStats = getDataOverview();
      
      // 計算新數據和合併後數據的統計
      const getStats = (data) => ({
        totalDays: Object.keys(data.life?.daily || {}).length,
        jobEntries: Object.values(data.job?.dailyEntries || {}).flat().length,
        thesisEntries: Object.values(data.thesis?.dailyEntries || {}).flat().length,
        moneyEntries: Object.values(data.money?.dailyEntries || {}).flat().length,
        timelineEntries: Object.values(data.timeline || {}).flat().length,
        trophies: Object.keys(data.trophyConditions || {}).filter(k => data.trophyConditions[k]).length
      });
      
      const newStats = getStats(newData);
      const mergedStats = getStats(mergedData);
      
      return `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:10px;">
          <div style="padding:8px;background:rgba(255,255,255,0.5);border-radius:4px;">
            <strong>當前數據</strong><br>
            天數：${currentStats.totalDays}<br>
            就職：${currentStats.jobEntries}<br>
            論文：${currentStats.thesisEntries}<br>
            財務：${currentStats.moneyEntries}<br>
            動態：${currentStats.timelineEntries}<br>
            獎盃：${currentStats.trophies}
          </div>
          <div style="padding:8px;background:rgba(255,255,255,0.5);border-radius:4px;">
            <strong style="color:#c08020;">導入數據</strong><br>
            天數：${newStats.totalDays}<br>
            就職：${newStats.jobEntries}<br>
            論文：${newStats.thesisEntries}<br>
            財務：${newStats.moneyEntries}<br>
            動態：${newStats.timelineEntries}<br>
            獎盃：${newStats.trophies}
          </div>
          <div style="padding:8px;background:rgba(74,124,89,0.1);border-radius:4px;">
            <strong style="color:#4a7c59;">合併結果</strong><br>
            天數：${mergedStats.totalDays}<br>
            就職：${mergedStats.jobEntries}<br>
            論文：${mergedStats.thesisEntries}<br>
            財務：${mergedStats.moneyEntries}<br>
            動態：${mergedStats.timelineEntries}<br>
            獎盃：${mergedStats.trophies}
          </div>
        </div>
        <div style="margin-top:10px;padding:8px;background:rgba(32,96,160,0.1);border-radius:4px;color:#2060a0;">
          ℹ️ 合併將保留兩份數據中所有的記錄，不會丟失任何數據。
        </div>
      `;
    }
    
    // 從檔案合併
    function mergeFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = parseImportData(e.target.result);
        if (result.success) {
          const mergedData = mergeData(state, result.data);
          pendingMergeData = mergedData;
          document.getElementById('mergePreviewContent').innerHTML = 
            generateMergePreview(state, result.data, mergedData);
          openModal('mergePreviewModalOverlay');
        } else {
          showDataManagerLog(result.error, true);
          alert('合併失敗：' + result.error);
        }
      };
      reader.onerror = () => {
        showDataManagerLog('讀取檔案失敗', true);
        alert('讀取檔案失敗');
      };
      reader.readAsText(file);
    }
    
    // 執行合併
    function executeMerge(mergedData) {
      try {
        state = mergedData;
        state.selectedDateKey = todayKey();
        saveState();
        renderAll();
        renderDataOverview();
        showDataManagerLog('數據合併成功！');
        alert('數據合併成功！');
        return true;
      } catch (e) {
        console.error('Merge execute error:', e);
        showDataManagerLog('合併執行失敗：' + e.message, true);
        alert('合併失敗：' + e.message);
        return false;
      }
    }
    
    // 清除所有數據
    function clearAllData() {
      if (!confirm('確定要清除所有數據嗎？此操作不可恢復！')) return;
      if (!confirm('最後確認：真的要清除所有數據嗎？\n\n建議先導出備份！')) return;
      
      try {
        localStorage.removeItem(STORAGE_KEY);
        state = {
          selectedDateKey: todayKey(),
          job: { offerDate: null, badges: {}, dailyEntries: {} },
          thesis: { projects: [], dailyEntries: {} },
          money: { dailyEntries: {} },
          life: { daily: {} },
          fiction: { projects: [], dailyEntries: {} },
          reading: { projects: [], dailyEntries: {} },
          housework: {},
          timeline: {},
          notepad: {},
          trophyConditions: {},
          romance: {}
        };
        saveState();
        renderAll();
        renderDataOverview();
        showDataManagerLog('所有數據已清除');
        alert('所有數據已清除！');
      } catch (e) {
        console.error('Clear data error:', e);
        showDataManagerLog('清除失敗：' + e.message, true);
        alert('清除失敗：' + e.message);
      }
    }

    // ===== 獲取每日數據的輔助函數 =====
    function getJobEntries(key) {
      if (!state.job.dailyEntries[key]) state.job.dailyEntries[key] = [];
      return state.job.dailyEntries[key];
    }

    function getThesisEntries(key) {
      if (!state.thesis.dailyEntries[key]) state.thesis.dailyEntries[key] = [];
      return state.thesis.dailyEntries[key];
    }

    function getMoneyEntries(key) {
      if (!state.money.dailyEntries[key]) state.money.dailyEntries[key] = [];
      return state.money.dailyEntries[key];
    }

    function getLifeDaily(key) {
      if (!state.life.daily[key]) {
        // 所有數值默認為 null（未填入），計算時視為 0
        state.life.daily[key] = {
          sleepTime: null, wakeTime: null, water: null, bowel: null,
          nutrition: null, skin: null, selfDev: null, fun: null,
          outing: null, empty: null, period: null, masturbation: null, weight: null
        };
      }
      return state.life.daily[key];
    }

    function getWaterLogs(key) {
      if (!state.life.waterLogs) state.life.waterLogs = {};
      if (!state.life.waterLogs[key]) state.life.waterLogs[key] = [];
      return state.life.waterLogs[key];
    }

    function getTotalWater(key) {
      const logs = getWaterLogs(key);
      return logs.reduce((sum, log) => sum + (Number(log.amount) || 0), 0);
    }

    function getNutritionLogs(key) {
      if (!state.life.nutritionLogs) state.life.nutritionLogs = {};
      if (!state.life.nutritionLogs[key]) state.life.nutritionLogs[key] = [];
      return state.life.nutritionLogs[key];
    }
    function getTotalNutrition(key) {
      return getNutritionLogs(key).reduce((sum, log) => sum + (Number(log.score) || 0), 0);
    }
    function getSelfDevLogs(key) {
      if (!state.life.selfDevLogs) state.life.selfDevLogs = {};
      if (!state.life.selfDevLogs[key]) state.life.selfDevLogs[key] = [];
      return state.life.selfDevLogs[key];
    }
    function getTotalSelfDev(key) {
      return getSelfDevLogs(key).reduce((sum, log) => sum + (Number(log.hours) || 0), 0);
    }
    function getOutingLogs(key) {
      if (!state.life.outingLogs) state.life.outingLogs = {};
      if (!state.life.outingLogs[key]) state.life.outingLogs[key] = [];
      return state.life.outingLogs[key];
    }
    function getTotalOuting(key) {
      return getOutingLogs(key).reduce((sum, log) => sum + (Number(log.count) || 0), 0);
    }
    function getFunLogs(key) {
      if (!state.life.funLogs) state.life.funLogs = {};
      if (!state.life.funLogs[key]) state.life.funLogs[key] = [];
      return state.life.funLogs[key];
    }
    function getTotalFun(key) {
      return getFunLogs(key).reduce((sum, log) => sum + (Number(log.hours) || 0), 0);
    }
    function getEmptyLogs(key) {
      if (!state.life.emptyLogs) state.life.emptyLogs = {};
      if (!state.life.emptyLogs[key]) state.life.emptyLogs[key] = [];
      return state.life.emptyLogs[key];
    }
    function getTotalEmpty(key) {
      return getEmptyLogs(key).reduce((sum, log) => sum + (Number(log.hours) || 0), 0);
    }

    function getFictionEntries(key) {
      if (!state.fiction.dailyEntries[key]) state.fiction.dailyEntries[key] = [];
      return state.fiction.dailyEntries[key];
    }

    function getReadEntries(key) {
      if (!state.reading.dailyEntries[key]) state.reading.dailyEntries[key] = [];
      return state.reading.dailyEntries[key];
    }

    function getHousework(key) {
      if (!state.housework[key]) {
        const hw = {};
        houseworkItems.forEach(i => hw[i.id] = 'reasonable');
        state.housework[key] = hw;
      }
      return state.housework[key];
    }

    function getTimeline(key) {
      if (!state.timeline[key]) state.timeline[key] = [];
      return state.timeline[key];
    }

    function getNotepad(key) {
      return state.notepad[key] || '';
    }

    // ===== 動態軸：添加自動記錄 =====
    function addAutoTimeline(text, autoData = {}) {
      const key = state.selectedDateKey;
      const now = new Date();
      const timeline = getTimeline(key);
      timeline.push({
        id: generateId(),
        text: text,
        images: [],
        timestamp: now.getTime(),
        hour: now.getHours(),
        minute: now.getMinutes(),
        tag: null,
        isAuto: true,
        autoData: autoData
      });
      saveState();
      renderTimeline();
    }

    // ===== 動態軸：刪除關聯記錄 =====
    function removeAutoTimeline(module, entryId) {
      const key = state.selectedDateKey;
      const timeline = getTimeline(key);
      const idx = timeline.findIndex(t => t.isAuto && t.autoData && t.autoData.module === module && t.autoData.entryId === entryId);
      if (idx !== -1) {
        timeline.splice(idx, 1);
        saveState();
      }
    }
    // ===== 聯絡客戶 計算與渲染 =====
    function computeJobForDay(key) {
      const entries = getJobEntries(key);
      let research = 0, prep = 0, writing = 0, general = 0;
      entries.forEach(e => {
        const amt = Number(e.amount) || 0;
        if (e.type === 'research') research += amt;
        else if (e.type === 'prep') prep += amt;
        else if (e.type === 'writing') writing += amt;
        else if (e.type === 'general') general += amt;
      });
      const base = research * 1 + prep * 30 + writing * 15 + general * 15;
      let passive = 0;
      if (state.job.offerDate && key >= state.job.offerDate) {
        passive = 10;
      }
      return { research, prep, writing, general, base, passive, total: base + passive };
    }

    // 計算到指定日期為止的累計值
    function computeJobTotalUntil(untilKey) {
      let sum = 0;
      Object.keys(state.job.dailyEntries).forEach(key => {
        if (isDateOnOrBefore(key, untilKey)) {
          sum += computeJobForDay(key).total;
        }
      });
      const bonusPerBadge = 250;
      const badgeCount = Object.values(state.job.badges).filter(Boolean).length;
      sum += badgeCount * bonusPerBadge;
      if (state.job.offerDate && state.job.offerDate <= untilKey) sum += 1000;
      return sum;
    }

    function computeJobAuspiciousForWeek(referenceKey) {
      const refDate = dateFromKey(referenceKey);
      const day = refDate.getDay();
      const monday = addDays(refDate, -((day + 6) % 7));
      const lastMonday = addDays(monday, -7);
      let sum = 0;
      const dailyLines = [];
      for (let i = 0; i < 7; i++) {
        const d = addDays(lastMonday, i);
        const key = dateKeyFromDate(d);
        const entries = getJobEntries(key);
        let count = 0;
        entries.forEach(e => { if (e.type === 'research') count += Number(e.amount) || 0; });
        sum += count;
        const weekdayName = ['一','二','三','四','五','六','日'][i];
        dailyLines.push(`週${weekdayName}${count}`);
      }
      return { sum, dailyLines };
    }

    function computeJobFate(auspicious) {
      if (state.job.offerDate) return 2;
      return auspicious < 10 ? 0.5 : 1;
    }

    function renderJobSection() {
      const key = state.selectedDateKey;
      const entries = getJobEntries(key);
      const computed = computeJobForDay(key);

      // 表格
      const tbody = document.querySelector('#jobTable tbody');
      tbody.innerHTML = '';
      const typeLabels = {
        research: '企業調查（家）',
        prep: '面試對策（小時）',
        writing: '文書寫作（小時）',
        general: '綜合準備（小時）'
      };
      
      entries.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${typeLabels[e.type] || e.type}</td>
          <td>${e.amount}</td>
          <td class="actions-cell">
            <button class="btn-del" data-idx="${idx}">✕</button>
          </td>
        `;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('job', e.id);
          entries.splice(idx, 1);
          saveState();
          renderAll();
        };
        tbody.appendChild(tr);
      });

      // 公式
      const formulaEl = document.getElementById('jobFormula');
      formulaEl.innerHTML =
        `企業調查 <span class="formula-highlight">${computed.research}</span> × 1` +
        ` ＋ 面試對策 <span class="formula-highlight">${computed.prep}</span> × 30` +
        ` ＋ 文書寫作 <span class="formula-highlight">${computed.writing}</span> × 15` +
        ` ＋ 綜合準備 <span class="formula-highlight">${computed.general}</span> × 15` +
        ` = <span class="formula-highlight">${computed.base}</span>` +
        (computed.passive ? ` ＋ 被動 <span class="formula-highlight">+${computed.passive}</span>` : '') +
        ` ⇒ 今日 <span class="formula-highlight">${computed.total}</span> 分`;

      document.getElementById('jobTodayScore').textContent = computed.total;
      document.getElementById('jobTotalScore').textContent = computeJobTotalUntil(key);

      // 祥瑞 & 天命
      const aus = computeJobAuspiciousForWeek(key);
      document.getElementById('jobAuspiciousBlock').innerHTML =
        `上週企業調查：${aus.dailyLines.join(' ＋ ')} = <span class="formula-highlight">${aus.sum}</span> 家`;
      document.getElementById('jobAuspiciousVal').textContent = aus.sum;
      document.getElementById('jobFate').textContent = computeJobFate(aus.sum);

      // offer 狀態
      document.getElementById('jobOfferStatus').value = state.job.offerDate ? 'has' : 'none';

      // 徽章
      renderJobBadges();
    }

    function renderJobBadges() {
      const wrap = document.getElementById('jobBadges');
      wrap.innerHTML = '';
      const defs = [
        { id: 'stage1', label: '初次書類通過' },
        { id: 'stage2', label: '一次面試通過' },
        { id: 'stage3', label: '最終面試通過' },
        { id: 'final', label: '正式 offer 確定' }
      ];
      defs.forEach(def => {
        const label = document.createElement('label');
        label.className = 'badge-item' + (state.job.badges[def.id] ? ' badge-on' : '');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!state.job.badges[def.id];
        chk.onchange = () => {
          const wasChecked = state.job.badges[def.id];
          state.job.badges[def.id] = chk.checked;
          saveState();
          
          // 添加到動態軸
          if (chk.checked && !wasChecked) {
            const timeline = getTimeline(state.selectedDateKey);
            const now = new Date();
            timeline.push({
              id: generateId(),
              text: `🏅 獲得徽章【${def.label}】(+250)`,
              images: [],
              timestamp: now.getTime(),
              hour: now.getHours(),
              minute: now.getMinutes(),
              tag: null,
              isAuto: true,
              autoData: { module: 'job', type: 'badge', badgeId: def.id }
            });
            saveState();
          } else if (!chk.checked && wasChecked) {
            // 取消勾選時刪除對應的動態軸記錄
            const timeline = getTimeline(state.selectedDateKey);
            const idx = timeline.findIndex(t => t.isAuto && t.autoData?.module === 'job' && t.autoData?.type === 'badge' && t.autoData?.badgeId === def.id);
            if (idx !== -1) {
              timeline.splice(idx, 1);
              saveState();
            }
          }
          
          renderAll();
        };
        label.appendChild(chk);
        const span = document.createElement('span');
        span.textContent = def.label + ' (+250)';
        label.appendChild(span);
        wrap.appendChild(label);
      });
    }

    // ===== 雅客宴遊（論文）計算與渲染 =====
    function computeThesisDayScore(key) {
      const entries = getThesisEntries(key);
      let words = 0;
      entries.forEach(e => words += Number(e.words) || 0);
      const unit = Math.floor(words / 1000);
      const base = unit * 30;
      return { words, unit, base };
    }

    function computeThesisTotalUntil(untilKey) {
      let sum = 0;
      Object.keys(state.thesis.dailyEntries).forEach(key => {
        if (isDateOnOrBefore(key, untilKey)) {
          sum += computeThesisDayScore(key).base;
        }
      });
      // 項目徽章：只計算在該日期前完成的
      const bonus = state.thesis.projects.filter(p => p.done && (!p.doneDate || p.doneDate <= untilKey)).length * 100;
      return sum + bonus;
    }

    function computeWeeklyWords(dailyEntries, referenceKey) {
      const ref = dateFromKey(referenceKey);
      const day = ref.getDay();
      const monday = addDays(ref, -((day + 6) % 7));
      let sum = 0;
      const dailyLines = [];
      for (let i = 0; i < 7; i++) {
        const d = addDays(monday, i);
        const key = dateKeyFromDate(d);
        const entries = dailyEntries[key] || [];
        let dayWords = 0;
        entries.forEach(e => dayWords += Number(e.words) || 0);
        sum += dayWords;
        const weekdayName = ['一','二','三','四','五','六','日'][i];
        dailyLines.push(`週${weekdayName}${dayWords}`);
      }
      return { words: sum, dailyLines };
    }

    function renderThesisSection() {
      const key = state.selectedDateKey;
      const entries = getThesisEntries(key);
      const { words, unit, base } = computeThesisDayScore(key);

      // 表格
      const tbody = document.querySelector('#thesisTable tbody');
      tbody.innerHTML = '';
      entries.forEach((e, idx) => {
        const proj = state.thesis.projects.find(p => p.id === e.projectId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${proj ? proj.name : '（無項目）'}</td>
          <td>${e.words}</td>
          <td class="actions-cell">
            <button class="btn-del" data-idx="${idx}">✕</button>
          </td>
        `;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('thesis', e.id);
          entries.splice(idx, 1);
          saveState();
          renderAll();
        };
        tbody.appendChild(tr);
      });

      // 公式
      document.getElementById('thesisFormula').innerHTML =
        `今日字數 <span class="formula-highlight">${words}</span> ÷ 1000 = ` +
        `<span class="formula-highlight">${unit}</span> 單位 × 30 ⇒ ` +
        `今日 <span class="formula-highlight">${base}</span> 分`;

      document.getElementById('thesisTodayScore').textContent = base;
      document.getElementById('thesisTotalScore').textContent = computeThesisTotalUntil(key);

      // 傳聞 & 玲瓏
      const weekly = computeWeeklyWords(state.thesis.dailyEntries, key);
      const rumor = weekly.words / 1000;
      document.getElementById('thesisRumorBlock').innerHTML =
        `本週字數：${weekly.dailyLines.join(' ＋ ')} = <span class="formula-highlight">${weekly.words}</span> 字；` +
        `傳聞 = <span class="formula-highlight">${rumor.toFixed(2)}</span>`;
      document.getElementById('thesisRumorVal').textContent = rumor.toFixed(2);
      let leling = rumor >= 3 ? 2 : (rumor < 1 ? 0.5 : 1);
      document.getElementById('thesisLeling').textContent = leling;

      // 項目下拉 & 徽章
      renderThesisProjects();
    }

  function renderThesisProjects() {
      const wrap = document.getElementById('thesisProjectsRow');
      const select = document.getElementById('thesisProjectSelect');
      wrap.innerHTML = '';
      select.innerHTML = '<option value="">（無項目）</option>';
      state.thesis.projects.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);

        const label = document.createElement('label');
        label.className = 'badge-item' + (p.done ? ' badge-on' : '');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!p.done;
        chk.onchange = () => {
          const wasChecked = p.done;
          p.done = chk.checked;
          p.doneDate = chk.checked ? state.selectedDateKey : null;
          saveState();
          
          // 添加到動態軸
          if (chk.checked && !wasChecked) {
            const timeline = getTimeline(state.selectedDateKey);
            const now = new Date();
            timeline.push({
              id: generateId(),
              text: `🏅 完成論文項目【${p.name}】(+100)`,
              images: [],
              timestamp: now.getTime(),
              hour: now.getHours(),
              minute: now.getMinutes(),
              tag: null,
              isAuto: true,
              autoData: { module: 'thesis', type: 'project', projectId: p.id }
            });
            saveState();
          } else if (!chk.checked && wasChecked) {
            const timeline = getTimeline(state.selectedDateKey);
            const idx = timeline.findIndex(t => t.isAuto && t.autoData?.module === 'thesis' && t.autoData?.type === 'project' && t.autoData?.projectId === p.id);
            if (idx !== -1) {
              timeline.splice(idx, 1);
              saveState();
            }
          }
          
          renderAll();
        };
        label.appendChild(chk);
        const span = document.createElement('span');
        span.textContent = p.name + ' (+100)';
        label.appendChild(span);
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-del';
        delBtn.textContent = '✕';
        delBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          state.thesis.projects.splice(idx, 1);
          saveState();
          renderAll();
        };
        label.appendChild(delBtn);
        wrap.appendChild(label);
      });
    }

    // ===== 財務管理 計算與渲染 =====
    function computeMoneyDayScore(key) {
      const entries = getMoneyEntries(key);
      // 無任何紀錄時返回 0
      if (entries.length === 0) {
        return { dailyOut: 0, income: 0, special: 0, base: 0, hasData: false };
      }
      
      let dailyOut = 0, special = 0, income = 0;
      entries.forEach(e => {
        const amt = Number(e.amount) || 0;
        if (e.main === 'dailyOut') dailyOut += amt;
        else if (e.main === 'specialOut') special += amt;
        else if (e.main === 'income') income += amt;
      });
      
      // 修正後的公式
      let base = 0;
      if (dailyOut >= 6000) base = -150;
      else if (dailyOut > 5000) base = 0;
      else if (dailyOut >= 2000) base = 100;
      else base = 200;
      
      base += Math.floor(income / 60);
      base -= Math.floor(special / 60);
      
      return { dailyOut, income, special, base, hasData: true };
    }

    function computeMoneyTotalUntil(untilKey) {
      let sum = 0;
      Object.keys(state.money.dailyEntries).forEach(key => {
        if (isDateOnOrBefore(key, untilKey)) {
          const result = computeMoneyDayScore(key);
          if (result.hasData) sum += result.base;
        }
      });
      return sum;
    }

    function computeMoneyStreakUntil(key) {
      let streak = 0;
      const today = dateFromKey(key);
      let d = addDays(today, -1);
      while (true) {
        const k = dateKeyFromDate(d);
        const result = computeMoneyDayScore(k);
        if (!result.hasData) break;
        if (result.base >= 100) {
          streak++;
          d = addDays(d, -1);
        } else break;
      }
      return streak;
    }

    function renderMoneySection() {
      const key = state.selectedDateKey;
      const entries = getMoneyEntries(key);
      const { dailyOut, income, special, base, hasData } = computeMoneyDayScore(key);

      // 表格
      const tbody = document.querySelector('#moneyTable tbody');
      tbody.innerHTML = '';
      const mainMap = { dailyOut: '日常支出', basicOut: '基本支出', specialOut: '特殊支出', income: '日常收入' };
      const subMap = { food: '外食外賣', drink: '咖啡飲料', dessert: '外食甜品', fresh: '生鮮果蔬', snack: '零食小吃', life: '生活用品', entertain: '娛樂支出' };
      
      entries.forEach((e, idx) => {
        let label = mainMap[e.main] || e.main;
        if (e.main === 'dailyOut' && e.sub) label += '－' + (subMap[e.sub] || e.sub);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${label}</td>
          <td style="color:${e.main === 'income' ? '#2f7d4a' : '#333'}">${e.amount}</td>
          <td style="font-size:10px;color:#666;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${e.note || ''}">${e.note || ''}</td>
          <td class="actions-cell">
            <button class="btn-del" data-idx="${idx}">✕</button>
          </td>
        `;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('money', e.id);
          entries.splice(idx, 1);
          saveState();
          renderAll();
        };
        tbody.appendChild(tr);
      });

      // 公式 - 無數據時顯示 0
      if (!hasData) {
        document.getElementById('moneyFormula').innerHTML =
          `今日暫無紀錄 ⇒ 今日 <span class="formula-highlight">0</span> 分`;
      } else {
        const rangeText = dailyOut >= 6000 ? '≥6000 → -150' :
                          dailyOut > 5000 ? '5000–6000 → 0' :
                          dailyOut >= 2000 ? '2000–5000 → +100' : '<2000 → +200';
        document.getElementById('moneyFormula').innerHTML =
          `日常支出 <span class="formula-highlight">${dailyOut}</span> 日圓 ⇒ ${rangeText}` +
          `<br/>＋ 收入 <span class="formula-highlight">${income}</span> ÷ 60` +
          (special ? ` － 特殊支出 <span class="formula-highlight">${special}</span> ÷ 60` : '') +
          ` ⇒ 今日 <span class="formula-highlight">${base}</span> 分`;
      }

      document.getElementById('moneyTodayScore').textContent = hasData ? base : 0;
      document.getElementById('moneyTotalScore').textContent = computeMoneyTotalUntil(key);

      const streak = computeMoneyStreakUntil(key);
      document.getElementById('moneyStreak').textContent = streak;
      let freedom = streak < 15 ? 0.5 : (streak > 60 ? 2 : 1);
      document.getElementById('moneyFreedom').textContent = freedom;
    }

    // ===== 組織經營（生活）計算與渲染 =====
    function computeLifeDayScore(key) {
      const d = getLifeDaily(key);
      
      // 計算各log累計值
      const totalWater = getTotalWater(key);
      const totalNutrition = getTotalNutrition(key);
      const totalSelfDev = getTotalSelfDev(key);
      const totalFun = getTotalFun(key);
      const totalOuting = getTotalOuting(key);
      const totalEmpty = getTotalEmpty(key);
      
      // 同步到daily供向後兼容
      d.water = totalWater || d.water;
      d.nutrition = totalNutrition || d.nutrition;
      d.selfDev = totalSelfDev || d.selfDev;
      d.fun = totalFun || d.fun;
      d.outing = totalOuting || d.outing;
      d.empty = totalEmpty || d.empty;
      
      // 檢查是否有任何數據
      const hasAnyData = Object.values(d).some(v => v !== null && v !== '') ||
        totalWater > 0 || totalNutrition > 0 || totalSelfDev > 0 || totalFun > 0 || totalOuting > 0 || totalEmpty > 0;
      if (!hasAnyData) {
        return { score: 0, hasData: false, details: d };
      }
      
      let score = 0;
      const sleep = d.sleepTime !== null ? Number(d.sleepTime) : null;
      const wake = d.wakeTime !== null ? Number(d.wakeTime) : null;
      const water = totalWater || (d.water !== null ? Number(d.water) : null);
      const bowel = d.bowel !== null ? Number(d.bowel) : 0;
      const nutrition = totalNutrition || (d.nutrition !== null ? Number(d.nutrition) : 0);
      const skin = d.skin !== null ? Number(d.skin) : 0;
      const selfDev = totalSelfDev || (d.selfDev !== null ? Number(d.selfDev) : 0);
      const fun = totalFun || (d.fun !== null ? Number(d.fun) : 0);
      const outing = totalOuting || (d.outing !== null ? Number(d.outing) : 0);
      const empty = totalEmpty || (d.empty !== null ? Number(d.empty) : 0);

      // 入睡（修正後公式：24=0點，25=1點，26=2點...）
      // 24點前（包括24點）得5分；0～2點（包括2點）0分；2～3點（包括3點）扣5分；
      // 3～4點（包括4點）扣7分；4～6點（包括6點）扣10分；6點後扣20分
      if (sleep !== null && !isNaN(sleep)) {
        if (sleep <= 24) score += 5;           // 24點及以前（即0點及以前）
        else if (sleep <= 26) score += 0;      // 0點後～2點（包括2點）
        else if (sleep <= 27) score -= 5;      // 2點後～3點（包括3點）
        else if (sleep <= 28) score -= 7;      // 3點後～4點（包括4點）
        else if (sleep <= 30) score -= 10;     // 4點後～6點（包括6點）
        else score -= 20;                       // 6點後
      }
      
      // 起床（修正後公式）
      // 6點前（包括6點）得10分；6～9點得5分；9～11點（包括9點不包括11點）扣5分；11點及以後扣10分
      if (wake !== null && !isNaN(wake)) {
        if (wake <= 6) score += 10;            // 6點及以前
        else if (wake <= 9) score += 5;        // 6點後～9點（包括9點）
        else if (wake < 11) score -= 5;        // 9點後～11點前（不包括11點）
        else score -= 10;                       // 11點及以後
      }
      
      // 飲水（修正後公式）
      // ≤800ml扣5分；800～1000為0分；≥1000得5分
      if (water !== null && !isNaN(water)) {
        if (water <= 800) score -= 5;
        else if (water < 1000) score += 0;
        else score += 5;
      }
      
      // 排便：有則得5分，否則0分
      if (bowel >= 1) score += 5;
      
      // 營養評估和深度護膚：各自÷10為加分
      score += nutrition / 10;
      score += skin / 10;
      
      // 自我啟發：每1小時得5分
      score += selfDev * 5;
      
      // 專注娛樂：每1小時得1分
      score += fun * 1;
      
      // 外出遊玩：每次得15分
      score += outing * 15;
      
      // 內耗空虛：每1小時扣5分
      score -= empty * 5;

      return { score: Math.round(score * 10) / 10, hasData: true, details: d };
    }

    function computeLifeTotalUntil(untilKey) {
      let sum = 0;
      Object.keys(state.life.daily).forEach(key => {
        if (isDateOnOrBefore(key, untilKey)) {
          const result = computeLifeDayScore(key);
          if (result.hasData) sum += result.score;
        }
      });
      return Math.round(sum);
    }

    function computeLifeStreakUntil(key) {
      let streak = 0;
      const today = dateFromKey(key);
      let d = addDays(today, -1);
      while (true) {
        const k = dateKeyFromDate(d);
        const result = computeLifeDayScore(k);
        if (!result.hasData) break;
        if (result.score >= 25) {
          streak++;
          d = addDays(d, -1);
        } else break;
      }
      return streak;
    }

        function renderLifeSection() {
      const key = state.selectedDateKey;
      const d = getLifeDaily(key);

      // 填回基本表單
      document.getElementById('lifeSleepTime').value = d.sleepTime ?? '';
      document.getElementById('lifeWakeTime').value = d.wakeTime ?? '';
      document.getElementById('lifeSkin').value = d.skin ?? '';
      // 更新排便和體重按鈕狀態
      const weightInput = document.getElementById('weightQuickInput');
      if (weightInput) {
        if (d.weight) {
          weightInput.value = d.weight;
          weightInput.style.color = '#333';
          weightInput.style.fontWeight = '600';
          weightInput.style.background = 'rgba(178,144,90,0.12)';
        } else {
          weightInput.value = '';
          weightInput.style.color = '';
          weightInput.style.fontWeight = '';
          weightInput.style.background = '';
          weightInput.placeholder = 'kg';
        }
      }

      // 計算各log累計
      const totalWater = getTotalWater(key);
      const totalNutrition = getTotalNutrition(key);
      const totalSelfDev = getTotalSelfDev(key);
      const totalFun = getTotalFun(key);
      const totalOuting = getTotalOuting(key);
      const totalEmpty = getTotalEmpty(key);
      
      // 更新累計顯示
      const twdEl = document.getElementById('lifeTotalWaterDisplay');
      if (twdEl) twdEl.textContent = totalWater;
      const tndEl = document.getElementById('lifeTotalNutritionDisplay');
      if (tndEl) tndEl.textContent = totalNutrition;
      const tsdEl = document.getElementById('lifeTotalSelfDevDisplay');
      if (tsdEl) tsdEl.textContent = totalSelfDev;
      const todEl = document.getElementById('lifeTotalOutingDisplay');
      if (todEl) todEl.textContent = totalOuting;
      const tfdEl = document.getElementById('lifeTotalFunDisplay');
      if (tfdEl) tfdEl.textContent = totalFun;
      const tedEl = document.getElementById('lifeTotalEmptyDisplay');
      if (tedEl) tedEl.textContent = totalEmpty;

      const { score, hasData } = computeLifeDayScore(key);
      
      if (!hasData) {
        document.getElementById('lifeFormula').innerHTML =
          `今日暫無紀錄 ⇒ 今日 <span class="formula-highlight">0</span> 分`;
      } else {
        let sleepNote = '';
        const sleep = d.sleepTime !== null ? Number(d.sleepTime) : null;
        if (sleep !== null) {
          if (sleep <= 24) sleepNote = '(≤24點 +5)';
          else if (sleep <= 26) sleepNote = '(0-2點 ±0)';
          else if (sleep <= 27) sleepNote = '(2-3點 -5)';
          else if (sleep <= 28) sleepNote = '(3-4點 -7)';
          else if (sleep <= 30) sleepNote = '(4-6點 -10)';
          else sleepNote = '(>6點 -20)';
        }
        let wakeNote = '';
        const wake = d.wakeTime !== null ? Number(d.wakeTime) : null;
        if (wake !== null) {
          if (wake <= 6) wakeNote = '(≤6點 +10)';
          else if (wake <= 9) wakeNote = '(6-9點 +5)';
          else if (wake < 11) wakeNote = '(9-11點 -5)';
          else wakeNote = '(≥11點 -10)';
        }
        let waterNote = '';
        if (totalWater > 0) {
          if (totalWater <= 800) waterNote = '(≤800 -5)';
          else if (totalWater < 1000) waterNote = '(800-1000 ±0)';
          else waterNote = '(≥1000 +5)';
        }
        
        const effectiveNutrition = totalNutrition || (d.nutrition ? Number(d.nutrition) : 0);
        const effectiveSelfDev = totalSelfDev || (d.selfDev ? Number(d.selfDev) : 0);
        const effectiveFun = totalFun || (d.fun ? Number(d.fun) : 0);
        const effectiveOuting = totalOuting || (d.outing ? Number(d.outing) : 0);
        const effectiveEmpty = totalEmpty || (d.empty ? Number(d.empty) : 0);
        
        document.getElementById('lifeFormula').innerHTML =
          `入睡 <span class="formula-highlight">${d.sleepTime ?? '—'}</span>h ${sleepNote}　` +
          `起床 <span class="formula-highlight">${d.wakeTime ?? '—'}</span>h ${wakeNote}` +
          `<br/>飲水 <span class="formula-highlight">${totalWater || '—'}</span>ml ${waterNote}　` +
          `排便 ${d.bowel >= 1 ? '<span class="formula-highlight">✓</span> (+5)' : '—'}` +
          `<br/>營養 <span class="formula-highlight">${effectiveNutrition}</span>÷10　護膚 <span class="formula-highlight">${d.skin ?? 0}</span>÷10` +
          `<br/>自我啟發 ${effectiveSelfDev}h×5 ＋ 娛樂 ${effectiveFun}h×1 ＋ 外出 ${effectiveOuting}×15 － 內耗 ${effectiveEmpty}h×5` +
          `<br/>⇒ 今日 <span class="formula-highlight">${score}</span> 分`;
      }

      document.getElementById('lifeTodayScore').textContent = hasData ? score : 0;
      document.getElementById('lifeTotalScore').textContent = computeLifeTotalUntil(key);
      const streak = computeLifeStreakUntil(key);
      document.getElementById('lifeStreak').textContent = streak;
      let grace = streak < 15 ? 0.5 : (streak > 60 ? 2 : 1);
      document.getElementById('lifeGrace').textContent = grace;

      // 渲染記錄Log
      renderLifeLog(key);
      
      // 更新 Toggle 按鈕
      updateToggleButtons();
    }

    // === V5 新增：渲染記錄Log表格 ===
    function renderLifeLog(key) {
      const tbody = document.querySelector('#lifeLogTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const mealMap = { breakfast: '早餐', lunch: '中餐', dinner: '晚餐', snack: '小食' };
      const waterTypeMap = { water: '水', juice: '果汁飲料', tea: '茶奶咖啡', alcohol: '酒' };
      
      getWaterLogs(key).forEach((log, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>飲水（${waterTypeMap[log.type] || '水'}）</td><td>${log.amount}ml</td><td></td><td><button class="btn-del">✕</button></td>`;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('life', log.id);
          getWaterLogs(key).splice(idx, 1);
          getLifeDaily(key).water = getTotalWater(key);
          saveState(); renderAll();
        };
        tbody.appendChild(tr);
      });
      
      getNutritionLogs(key).forEach((log, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>營養（${mealMap[log.meal] || ''}）</td><td>${log.score}分</td><td>${log.note || ''}</td><td><button class="btn-del">✕</button></td>`;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('life', log.id);
          getNutritionLogs(key).splice(idx, 1);
          saveState(); renderAll();
        };
        tbody.appendChild(tr);
      });
      
      getSelfDevLogs(key).forEach((log, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>自我啟發</td><td>${log.hours}h</td><td>${log.note || ''}</td><td><button class="btn-del">✕</button></td>`;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('life', log.id);
          getSelfDevLogs(key).splice(idx, 1);
          saveState(); renderAll();
        };
        tbody.appendChild(tr);
      });
      
      getOutingLogs(key).forEach((log, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>外出遊玩</td><td>${log.count}次</td><td>${log.note || ''}</td><td><button class="btn-del">✕</button></td>`;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('life', log.id);
          getOutingLogs(key).splice(idx, 1);
          saveState(); renderAll();
        };
        tbody.appendChild(tr);
      });
      
      getFunLogs(key).forEach((log, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>專注於樂</td><td>${log.hours}h</td><td>${log.note || ''}</td><td><button class="btn-del">✕</button></td>`;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('life', log.id);
          getFunLogs(key).splice(idx, 1);
          saveState(); renderAll();
        };
        tbody.appendChild(tr);
      });
      
      getEmptyLogs(key).forEach((log, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>空虛內耗</td><td>${log.hours}h</td><td>${log.note || ''}</td><td><button class="btn-del">✕</button></td>`;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('life', log.id);
          getEmptyLogs(key).splice(idx, 1);
          saveState(); renderAll();
        };
        tbody.appendChild(tr);
      });
    }

    // === V5 新增：Toggle 按鈕狀態更新 ===
    function updateToggleButtons() {
      const key = state.selectedDateKey;
      const d = getLifeDaily(key);
      const periodBtn = document.getElementById('periodToggleBtn');
      const mastBtn = document.getElementById('mastToggleBtn');
      if (periodBtn) {
        periodBtn.classList.toggle('active', d.period >= 1);
      }
      if (mastBtn) {
        mastBtn.classList.toggle('mast-active', d.masturbation >= 1);
      }
      const bowelBtn = document.getElementById('bowelToggleBtn');
      if (bowelBtn) {
        bowelBtn.classList.toggle('bowel-active', d.bowel >= 1);
      }
      // 入睡和起床按鈕
      const sleepBtn = document.getElementById('sleepQuickBtn');
      if (sleepBtn) {
        const hasSleep = d.sleepTime !== null && d.sleepTime !== undefined && d.sleepTime !== '';
        sleepBtn.classList.toggle('sleep-active', hasSleep);
      }
      const wakeBtn = document.getElementById('wakeQuickBtn');
      if (wakeBtn) {
        const hasWake = d.wakeTime !== null && d.wakeTime !== undefined && d.wakeTime !== '';
        wakeBtn.classList.toggle('wake-active', hasWake);
      }
    }

    // === V5 新增：刪除記事本中選中的標籤 ===
    function deleteSelectedTag() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      let node = sel.anchorNode;
      // 向上找最近的 span[data-tag]
      while (node && node !== document.body) {
        if (node.nodeType === 1 && node.matches && node.matches('span[data-tag]')) {
          node.remove();
          return;
        }
        node = node.parentNode;
      }
      // 也檢查選區內
      const container = range.commonAncestorContainer;
      if (container.nodeType === 1) {
        const tags = container.querySelectorAll('span[data-tag]');
        if (tags.length === 1) tags[0].remove();
      }
    }

    // ===== 新書發布（創作）計算與渲染 =====
    function computeFictionDayScore(key) {
      const entries = getFictionEntries(key);
      let words = 0;
      entries.forEach(e => words += Number(e.words) || 0);
      const unit = Math.floor(words / 1000);
      const base = unit * 50;
      return { words, unit, base };
    }

    function computeFictionTotalUntil(untilKey) {
      let sum = 0;
      Object.keys(state.fiction.dailyEntries).forEach(key => {
        if (isDateOnOrBefore(key, untilKey)) {
          sum += computeFictionDayScore(key).base;
        }
      });
      const bonus = state.fiction.projects.filter(p => p.done && (!p.doneDate || p.doneDate <= untilKey)).length * 300;
      return sum + bonus;
    }

    function renderFictionSection() {
      const key = state.selectedDateKey;
      const entries = getFictionEntries(key);
      const { words, unit, base } = computeFictionDayScore(key);

      // 表格
      const tbody = document.querySelector('#fictionTable tbody');
      tbody.innerHTML = '';
      entries.forEach((e, idx) => {
        const proj = state.fiction.projects.find(p => p.id === e.projectId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${proj ? proj.name : '（無項目）'}</td>
          <td>${e.words}</td>
          <td class="actions-cell">
            <button class="btn-del" data-idx="${idx}">✕</button>
          </td>
        `;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('fiction', e.id);
          entries.splice(idx, 1);
          saveState();
          renderAll();
        };
        tbody.appendChild(tr);
      });

      // 公式
      document.getElementById('fictionFormula').innerHTML =
        `今日字數 <span class="formula-highlight">${words}</span> ÷ 1000 = ` +
        `<span class="formula-highlight">${unit}</span> 單位 × 50 ⇒ ` +
        `今日 <span class="formula-highlight">${base}</span> 分`;

      document.getElementById('fictionTodayScore').textContent = base;
      document.getElementById('fictionTotalScore').textContent = computeFictionTotalUntil(key);

      // 奇譚 & 靈韻
      const weekly = computeWeeklyWords(state.fiction.dailyEntries, key);
      const tale = weekly.words / 1000;
      document.getElementById('fictionTaleBlock').innerHTML =
        `本週字數：${weekly.dailyLines.join(' ＋ ')} = <span class="formula-highlight">${weekly.words}</span> 字；` +
        `奇譚 = <span class="formula-highlight">${tale.toFixed(2)}</span>`;
      document.getElementById('fictionTaleVal').textContent = tale.toFixed(2);
      let spirit = tale >= 3 ? 4 : (tale < 1 ? 1 : 2);
      document.getElementById('fictionSpirit').textContent = spirit;

      renderFictionProjects();
    }

   function renderFictionProjects() {
      const wrap = document.getElementById('fictionProjectsRow');
      const select = document.getElementById('fictionProjectSelect');
      wrap.innerHTML = '';
      select.innerHTML = '<option value="">（無項目）</option>';
      state.fiction.projects.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);

        const label = document.createElement('label');
        label.className = 'badge-item' + (p.done ? ' badge-on' : '');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!p.done;
        chk.onchange = () => { 
          const wasChecked = p.done;
          p.done = chk.checked; 
          p.doneDate = chk.checked ? state.selectedDateKey : null;
          saveState(); 
          
          // 添加到動態軸
          if (chk.checked && !wasChecked) {
            const timeline = getTimeline(state.selectedDateKey);
            const now = new Date();
            timeline.push({
              id: generateId(),
              text: `🏅 完成創作項目【${p.name}】(+300)`,
              images: [],
              timestamp: now.getTime(),
              hour: now.getHours(),
              minute: now.getMinutes(),
              tag: null,
              isAuto: true,
              autoData: { module: 'fiction', type: 'project', projectId: p.id }
            });
            saveState();
          } else if (!chk.checked && wasChecked) {
            const timeline = getTimeline(state.selectedDateKey);
            const idx = timeline.findIndex(t => t.isAuto && t.autoData?.module === 'fiction' && t.autoData?.type === 'project' && t.autoData?.projectId === p.id);
            if (idx !== -1) {
              timeline.splice(idx, 1);
              saveState();
            }
          }
          
          renderAll(); 
        };
        label.appendChild(chk);
        const span = document.createElement('span');
        span.textContent = p.name + ' (+300)';
        label.appendChild(span);
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-del';
        delBtn.textContent = '✕';
        delBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); state.fiction.projects.splice(idx, 1); saveState(); renderAll(); };
        label.appendChild(delBtn);
        wrap.appendChild(label);
      });
    }

    // ===== 謄錄經典（閱讀）計算與渲染 =====
    function computeReadDayScore(key) {
      const entries = getReadEntries(key);
      let philo = 0, academic = 0, nonfic = 0;
      entries.forEach(e => {
        const p = Number(e.pages) || 0;
        if (e.type === 'philo') philo += p;
        else if (e.type === 'academic') academic += p;
        else nonfic += p;
      });
      const base = philo * 3 + academic * 0.5 + nonfic * 0.3;
      return { philo, academic, nonfic, base: Math.round(base * 10) / 10 };
    }

    function computeReadTotalUntil(untilKey) {
      let sum = 0;
      Object.keys(state.reading.dailyEntries).forEach(key => {
        if (isDateOnOrBefore(key, untilKey)) {
          sum += computeReadDayScore(key).base;
        }
      });
      const bonus = state.reading.projects.filter(p => p.done && (!p.doneDate || p.doneDate <= untilKey)).length * 100;
      return Math.round(sum + bonus);
    }

    function computeReadStreakUntil(key) {
      let streak = 0;
      const today = dateFromKey(key);
      let d = addDays(today, -1);
      while (true) {
        const k = dateKeyFromDate(d);
        const entries = getReadEntries(k);
        if (!entries.length) break;
        let pages = 0;
        entries.forEach(e => pages += Number(e.pages) || 0);
        if (pages >= 20) {
          streak++;
          d = addDays(d, -1);
        } else break;
      }
      return streak;
    }

    function renderReadSection() {
      const key = state.selectedDateKey;
      const entries = getReadEntries(key);
      const { philo, academic, nonfic, base } = computeReadDayScore(key);

      // 表格
      const tbody = document.querySelector('#readTable tbody');
      tbody.innerHTML = '';
      const typeMap = { philo: '哲學文獻', academic: '其他文獻', nonfic: '非學術讀物' };
      entries.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${typeMap[e.type] || e.type}</td>
          <td>${e.pages}</td>
          <td class="actions-cell">
            <button class="btn-del" data-idx="${idx}">✕</button>
          </td>
        `;
        tr.querySelector('.btn-del').onclick = () => {
          removeAutoTimeline('reading', e.id);
          entries.splice(idx, 1);
          saveState();
          renderAll();
        };
        tbody.appendChild(tr);
      });

      // 公式
      document.getElementById('readFormula').innerHTML =
        `哲學 <span class="formula-highlight">${philo}</span>頁×3 ＋ ` +
        `其他 <span class="formula-highlight">${academic}</span>頁×0.5 ＋ ` +
        `非學術 <span class="formula-highlight">${nonfic}</span>頁×0.3 ⇒ ` +
        `今日 <span class="formula-highlight">${base}</span> 分`;

      document.getElementById('readTodayScore').textContent = base;
      document.getElementById('readTotalScore').textContent = computeReadTotalUntil(key);

      const streak = computeReadStreakUntil(key);
      document.getElementById('readStreak').textContent = streak;
      let diff = streak < 15 ? 0.5 : (streak > 60 ? 2 : 1);
      document.getElementById('readDifferent').textContent = diff;

      renderReadProjects();
    }
function renderReadProjects() {
      const container = document.getElementById('readProjectsContainer');
      container.innerHTML = '';
      
      if (state.reading.projects.length === 0) {
        container.innerHTML = '<div style="font-size:11px;color:#999;padding:8px 0;">尚無閱讀項目</div>';
        return;
      }

      // 創建兩列容器
      const grid = document.createElement('div');
      grid.className = 'read-projects-grid';
      
      state.reading.projects.forEach((p, idx) => {
        // 確保數據完整性
        if (p.totalPages === undefined) p.totalPages = 0;
        if (p.currentPage === undefined) p.currentPage = 0;
        
        const totalPages = Number(p.totalPages) || 0;
        const currentPage = Number(p.currentPage) || 0;
        const progress = totalPages > 0 ? Math.min(100, Math.round((currentPage / totalPages) * 100)) : 0;
        const isComplete = p.done || (totalPages > 0 && currentPage >= totalPages);
        
        const item = document.createElement('div');
        item.className = 'read-project-item-compact' + (isComplete ? ' is-done' : '');
        
        item.innerHTML = `
          <div class="read-project-header-compact">
            <div class="read-project-name-compact">
              <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                <input type="checkbox" class="project-done-check" ${p.done ? 'checked' : ''} style="width:13px;height:13px;accent-color:#d4af37;" />
                <span>${p.name}</span>
              </label>
              ${isComplete ? '<span class="done-badge-small">+100</span>' : ''}
            </div>
            <button class="btn-del-small">✕</button>
          </div>
          <div class="read-project-progress-compact">
            <div class="progress-bar-wrap-compact">
              <div class="progress-bar-fill ${isComplete ? 'complete' : ''}" style="width:${progress}%"></div>
            </div>
            <span class="progress-text-compact">${currentPage}/${totalPages || '?'}</span>
          </div>
          <div class="read-project-update-compact">
            <input type="number" class="input current-page-input" value="${currentPage}" placeholder="頁碼" />
            <button class="btn btn-ghost update-page-btn">更新</button>
          </div>
        `;
        
        // 完成 checkbox 事件
        const doneCheck = item.querySelector('.project-done-check');
        doneCheck.onchange = () => {
          const wasChecked = p.done;
          p.done = doneCheck.checked;
          p.doneDate = doneCheck.checked ? state.selectedDateKey : null;
          
          if (doneCheck.checked && totalPages > 0) {
            p.currentPage = totalPages;
          }
          
          saveState();
          
          if (doneCheck.checked && !wasChecked) {
            const timeline = getTimeline(state.selectedDateKey);
            const now = new Date();
            timeline.push({
              id: generateId(),
              text: `🏅 完成閱讀項目【${p.name}】(+100)`,
              images: [],
              timestamp: now.getTime(),
              hour: now.getHours(),
              minute: now.getMinutes(),
              tag: null,
              isAuto: true,
              autoData: { module: 'reading', type: 'project', projectId: p.id }
            });
            saveState();
          } else if (!doneCheck.checked && wasChecked) {
            const timeline = getTimeline(state.selectedDateKey);
            const tlIdx = timeline.findIndex(t => t.isAuto && t.autoData?.module === 'reading' && t.autoData?.type === 'project' && t.autoData?.projectId === p.id);
            if (tlIdx !== -1) {
              timeline.splice(tlIdx, 1);
              saveState();
            }
          }
          
          renderAll();
        };
        
        // 更新頁碼
        const updateBtn = item.querySelector('.update-page-btn');
        const pageInput = item.querySelector('.current-page-input');
        
        pageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            updateBtn.click();
          }
        });
        
        updateBtn.onclick = () => {
          const newPage = Number(pageInput.value) || 0;
          p.currentPage = Math.max(0, newPage);
          
          if (totalPages > 0 && p.currentPage >= totalPages && !p.done) {
            p.done = true;
            p.doneDate = state.selectedDateKey;
            
            const timeline = getTimeline(state.selectedDateKey);
            const now = new Date();
            timeline.push({
              id: generateId(),
              text: `🏅 完成閱讀項目【${p.name}】(+100)`,
              images: [],
              timestamp: now.getTime(),
              hour: now.getHours(),
              minute: now.getMinutes(),
              tag: null,
              isAuto: true,
              autoData: { module: 'reading', type: 'project', projectId: p.id }
            });
          }
          
          saveState();
          renderReadProjects();
        };
        
        // 刪除按鈕
        const delBtn = item.querySelector('.btn-del-small');
        delBtn.onclick = () => {
          if (confirm(`確定要刪除「${p.name}」嗎？`)) {
            state.reading.projects.splice(idx, 1);
            saveState();
            renderAll();
          }
        };
        
        grid.appendChild(item);
      });
      
      container.appendChild(grid);
    }

    // ===== 氣質（店鋪清潔）計算與渲染 =====
    function calcElegance(key) {
      const hw = getHousework(key);
      let s = 100;
      Object.values(hw).forEach(v => {
        const st = houseworkStates.find(x => x.value === v);
        if (st) s -= st.deduction;
      });
      return Math.max(0, s);
    }

    function renderCleaningModal() {
      const key = state.selectedDateKey;
      const hw = getHousework(key);
      const rows = document.getElementById('cleaningRows');
      rows.innerHTML = '';
      houseworkItems.forEach(item => {
        const row = document.createElement('div');
        row.className = 'clean-row';
        const label = document.createElement('span');
        label.textContent = item.name;
        row.appendChild(label);
        const sel = document.createElement('select');
        sel.className = 'select';
        sel.style.width = 'auto';
        houseworkStates.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.value;
          opt.textContent = s.label + (s.deduction > 0 ? ` (-${s.deduction})` : '');
          sel.appendChild(opt);
        });
        sel.value = hw[item.id] || 'reasonable';
        sel.onchange = () => {
          hw[item.id] = sel.value;
          saveState();
          renderDailyAttrs();
        };
        row.appendChild(sel);
        rows.appendChild(row);
      });
    }

    // ===== 魅力 計算 =====
    function calcCharm(key) {
      const timeline = getTimeline(key);
      const notepadHtml = getNotepad(key);
      
      const weights = { red: 5, orange: 3, yellow: 1 };
      
      // 執行：動態軸中有標籤的項目
      let execScore = 0;
      timeline.forEach(t => {
        if (t.tag && weights[t.tag]) {
          execScore += weights[t.tag];
        }
      });
      
      // 計劃：記事本中的標籤（通過 data-tag 屬性）
      let planScore = 0;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = notepadHtml;
      const tagSpans = tempDiv.querySelectorAll('span[data-tag]');
      tagSpans.forEach(span => {
        const tag = span.dataset.tag;
        if (weights[tag]) planScore += weights[tag];
      });
      
      if (planScore === 0) return 100;
      return Math.min(100, Math.round((execScore / planScore) * 100));
    }

    function renderDailyAttrs() {
      const key = state.selectedDateKey;
      const elegance = calcElegance(key);
      const charm = calcCharm(key);
      
      // 更新魅力公式（在動態軸彈窗中顯示）
      const timeline = getTimeline(key);
      const notepadHtml = getNotepad(key);
      const weights = { red: 5, orange: 3, yellow: 1 };
      let execR = 0, execO = 0, execY = 0;
      timeline.forEach(t => {
        if (t.tag === 'red') execR++;
        else if (t.tag === 'orange') execO++;
        else if (t.tag === 'yellow') execY++;
      });
      let planR = 0, planO = 0, planY = 0;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = notepadHtml;
      tempDiv.querySelectorAll('span[data-tag]').forEach(span => {
        const tag = span.dataset.tag;
        if (tag === 'red') planR++;
        else if (tag === 'orange') planO++;
        else if (tag === 'yellow') planY++;
      });
      
      const charmFormulaEl = document.getElementById('charmFormula');
      if (charmFormulaEl) {
        charmFormulaEl.innerHTML =
          `執行：🔴${execR}×5 + 🟠${execO}×3 + 🟡${execY}×1 = ${execR*5 + execO*3 + execY*1}<br/>` +
          `計劃：🔴${planR}×5 + 🟠${planO}×3 + 🟡${planY}×1 = ${planR*5 + planO*3 + planY*1}<br/>` +
          `魅力 = ${execR*5 + execO*3 + execY*1} ÷ ${planR*5 + planO*3 + planY*1 || 1} × 100 = <strong>${charm}</strong>`;
      }
      
      // 渲染頭銜解鎖提示面板
      renderNextTitlePanel();
    }

    // ===== 頭銜解鎖提示面板 =====
    let titlePageIndex = 0;
    let titlePages = [];
    
    function cycleTitlePage(dir) {
      if (titlePages.length === 0) return;
      titlePageIndex = (titlePageIndex + dir + titlePages.length) % titlePages.length;
      showTitlePage();
    }
    
    function showTitlePage() {
      const el = document.getElementById('nextTitleContent');
      const ind = document.getElementById('titlePageIndicator');
      const panel = document.getElementById('nextTitlePanel');
      // Sync panel width to date-selector width
      const dateSel = document.querySelector('.date-selector');
      if (panel && dateSel) {
        panel.style.width = dateSel.offsetWidth + 'px';
      }
      if (!el || titlePages.length === 0) {
        if (el) el.innerHTML = '<span style="color:#a08060;">暫無待解鎖頭銜</span>';
        if (ind) ind.textContent = '0/0';
        return;
      }
      if (titlePageIndex >= titlePages.length) titlePageIndex = 0;
      el.innerHTML = titlePages[titlePageIndex];
      if (ind) ind.textContent = `${titlePageIndex + 1}/${titlePages.length}`;
    }
    
    function renderNextTitlePanel() {
      const key = state.selectedDateKey;
      titlePages = [];
      const charNames = Object.keys(romanceData);
      
      // Helper: get numeric value for an attribute name
      function getAttrVal(attrName, cName) {
        try {
          if (attrName.includes('才幹')) return computeJobTotalUntil(key);
          if (attrName.includes('學識')) return computeReadTotalUntil(key);
          if (attrName.includes('聲望')) return computeThesisTotalUntil(key);
          if (attrName.includes('文彩')) return computeFictionTotalUntil(key);
          if (attrName.includes('德行')) return computeLifeTotalUntil(key);
          if (attrName.includes('財富')) return computeMoneyTotalUntil(key);
          if (attrName.includes('好感度')) return getCharAffinity(state, cName, key);
          if (attrName.includes('巫山')) return getUnionCount(state, '曹丕', key);
          if (attrName.includes('雲雨')) return getUnionCount(state, '劉協', key);
          if (attrName.includes('神交')) return getUnionCount(state, '曹植', key);
          if (attrName.includes('春江')) return getUnionCount(state, '郭嘉', key);
          if (attrName.includes('蘭澤')) return getUnionCount(state, '荀彧', key);
          if (attrName.includes('野合')) return getUnionCount(state, '司馬懿', key);
        } catch(e) {}
        return null;
      }
      
      // Build a single condition text with numeric values
      function fmtCond(cond, cName) {
        let txt = cond.text;
        // "XXX > NNN"
        const gt = txt.match(/^(.+?)\s*[>＞]\s*(\d+)$/);
        if (gt) {
          const v = getAttrVal(gt[1].trim(), cName);
          if (v !== null) {
            const ok = v > parseInt(gt[2]);
            const c = ok ? '#4a7c59' : '#c04040';
            return `${gt[1].trim()}(<b style="color:${c}">${Math.round(v)}</b>/${gt[2]})`;
          }
        }
        // Complex "A<X 或 B<Y"
        const orParts = txt.split(/\s*或\s*/);
        if (orParts.length > 1) {
          return orParts.map(p => {
            const lt = p.trim().match(/^(.+?)\s*[<＜]\s*(\d+)$/);
            if (lt) {
              const v = getAttrVal(lt[1].trim(), cName);
              if (v !== null) {
                const ok = v < parseInt(lt[2]);
                const c = cond.forBE ? (ok ? '#c04040' : '#4a7c59') : (ok ? '#4a7c59' : '#c04040');
                return `${lt[1].trim()}(<b style="color:${c}">${Math.round(v)}</b>/${lt[2]})`;
              }
            }
            return p.trim();
          }).join(' 或 ');
        }
        // "XXX < NNN"
        const lt = txt.match(/^(.+?)\s*[<＜]\s*(\d+)$/);
        if (lt) {
          const v = getAttrVal(lt[1].trim(), cName);
          if (v !== null) {
            const ok = v < parseInt(lt[2]);
            const c = cond.forBE ? (ok ? '#c04040' : '#4a7c59') : (ok ? '#4a7c59' : '#c04040');
            return `${lt[1].trim()}(<b style="color:${c}">${Math.round(v)}</b>/${lt[2]})`;
          }
        }
        return txt;
      }
      
      // Color a condition span: BE met=red unmet=black; non-BE met=green unmet=red
      function condSpan(cond, cName) {
        let met = false;
        try { met = cond.check(state, key); } catch(e) {}
        const isBE = !!cond.forBE;
        const color = isBE ? (met ? '#c04040' : '#3d3529') : (met ? '#4a7c59' : '#c04040');
        return `<span style="color:${color}">${fmtCond(cond, cName)}</span>`;
      }
      
      // Get character info
      function getCharInfo(cn) {
        const cd = romanceData[cn];
        const unlocked = state.romance?.[cn]?.unlocked || [];
        const stories = cd.stories;
        let currentTitle = null;
        
        for (let i = 0; i < stories.length; i++) {
          const s = stories[i];
          const isUn = unlocked.some(uid => uid.startsWith(s.id + '_') || uid === s.id);
          if (isUn) {
            const isR = unlocked.some(uid => uid === s.id + '_r');
            const isF = unlocked.some(uid => uid === s.id + '_f');
            const isBE = unlocked.some(uid => uid === s.id + '_be');
            const isGE = unlocked.some(uid => uid === s.id + '_ge');
            const isSE = unlocked.some(uid => uid === s.id + '_se');
            let n = s.name, t = s.type;
            if (isR) { n = (s.type === 'R') ? s.name : (s.altName || s.name); t = 'R'; }
            if (isF) { n = (s.altType === 'F') ? s.altName : s.name; t = 'F'; }
            if (isBE) { n = (s.type === 'BE') ? s.name : (s.altType === 'BE' ? s.altName : (s.beName || s.name)); t = 'BE'; }
            if (isGE) t = 'GE';
            if (isSE) t = 'SE';
            currentTitle = { name: n, type: t };
            if (isBE) break;
          }
        }
        
        // Find all next un-unlocked stories (collect until next date changes)
        let nextStories = [];
        let blocked = false;
        for (let i = 0; i < stories.length; i++) {
          const s = stories[i];
          const isUn = unlocked.some(uid => uid.startsWith(s.id + '_') || uid === s.id);
          if (isUn) {
            if (unlocked.some(uid => uid.startsWith(s.id) && uid.endsWith('_be'))) { blocked = true; break; }
            continue;
          }
          // Collect this and consecutive same-date stories
          nextStories.push(s);
          for (let j = i + 1; j < stories.length; j++) {
            if (stories[j].date === s.date) nextStories.push(stories[j]);
            else break;
          }
          break;
        }
        return { currentTitle, nextStories, blocked };
      }
      
      // Split a story into variant lines. Each line = {label, conds, isBE}
      // R/F dual or triple endings → separate lines with their own conditions
      function splitStoryVariants(story, charName) {
        const lines = [];
        const hasDual = story.altName && (story.altType === 'F' || story.altType === 'R' || story.altType === 'BE');
        const hasTriple = !!story.beName;
        const conds = story.conditions || [];
        
        if (!hasDual && !hasTriple) {
          // Single story (S, standalone R, standalone BE, etc.)
          const special = ['BE','GE','SE'];
          const prefix = special.includes(story.type) ? story.type + ' ' : '';
          const relevantConds = conds.filter(c => !c.forBE || story.type === 'BE');
          const beConds = conds.filter(c => c.forBE);
          lines.push({ label: `${prefix}「${story.name}」`, conds: relevantConds, isBE: story.type === 'BE', charName });
          // If it has BE conditions but isn't a BE type, add a BE variant line
          if (story.type !== 'BE' && beConds.length > 0) {
            // This shouldn't normally happen for single stories
          }
          return lines;
        }
        
        if (hasDual && !hasTriple) {
          // Two variants: main type + alt type
          const mainType = story.type;
          const altType = story.altType;
          const special = ['BE','GE','SE'];
          
          // Main variant
          const mainPrefix = special.includes(mainType) ? mainType + ' ' : '';
          const mainConds = conds.filter(c => c.common || (mainType === 'R' && c.forR) || (mainType === 'F' && c.forF) || (mainType === 'GE' && c.forGE) || (mainType === 'SE' && c.forSE) || (mainType === 'BE' && c.forBE) || (!c.forR && !c.forF && !c.forBE && !c.forGE && !c.forSE && !c.common));
          lines.push({ label: `${mainPrefix}「${story.name}」`, conds: mainConds, isBE: mainType === 'BE', charName });
          
          // Alt variant
          const altPrefix = special.includes(altType) ? altType + ' ' : '';
          const altConds = conds.filter(c => c.common || (altType === 'R' && c.forR) || (altType === 'F' && c.forF) || (altType === 'BE' && c.forBE) || (!c.forR && !c.forF && !c.forBE && !c.forGE && !c.forSE && !c.common));
          lines.push({ label: `${altPrefix}「${story.altName}」`, conds: altConds, isBE: altType === 'BE', charName });
          
          return lines;
        }
        
        if (hasTriple) {
          // Three variants: BE + R + F (via isBEAlt + beName)
          const special = ['BE','GE','SE'];
          // R variant
          const rConds = conds.filter(c => c.common || c.forR);
          lines.push({ label: `「${story.name}」`, conds: rConds, isBE: false, charName });
          // F variant
          const fConds = conds.filter(c => c.common || c.forF);
          lines.push({ label: `「${story.altName}」`, conds: fConds, isBE: false, charName });
          // BE variant
          const beConds = conds.filter(c => c.forBE);
          lines.push({ label: `BE「${story.beName}」`, conds: beConds, isBE: true, charName });
          return lines;
        }
        
        return lines;
      }
      
      // Build one line: charName + title ｜ conditions (all inline)
      function buildLine(charName, variant, story) {
        const dateReached = key >= story.date;
        const condParts = variant.conds.map(c => condSpan(c, charName));
        
        // Check if all non-BE conditions are met
        let allNonBEMet = true;
        variant.conds.forEach(c => {
          if (!c.forBE) {
            try { if (!c.check(state, key)) allNonBEMet = false; } catch(e) { allNonBEMet = false; }
          }
        });
        
        let statusPart = '';
        if (variant.conds.length === 0) {
          // No conditions, just date
          statusPart = dateReached
            ? '<span style="color:#4a7c59;font-size:9px;">可在金風玉露中解鎖</span>'
            : '<span style="color:#c04040;font-size:9px;">未到解鎖日期</span>';
        } else if (allNonBEMet && !dateReached) {
          statusPart = '<span style="color:#c04040;font-size:9px;"> 未到解鎖日期</span>';
        } else if (allNonBEMet && dateReached) {
          statusPart = '<span style="color:#4a7c59;font-size:9px;"> 可在金風玉露中解鎖</span>';
        }
        
        const condStr = condParts.length > 0 ? condParts.join(' ') : '';
        const sep = condStr ? ' ｜ ' : '';
        return `<span style="font-weight:600;color:#5c4d3d;">${variant.label}</span>${sep}<span style="font-size:9px;">${condStr}</span>${statusPart}`;
      }
      
      // Build a line with charName prefix for page 0
      function buildLineWithChar(charName, variant, story) {
        return `<div style="font-size:10px;line-height:1.5;margin-bottom:1px;"><span style="font-weight:500;color:#8b6914;">${charName}</span> ${buildLine(charName, variant, story)}</div>`;
      }
      
      // Build a line without charName for per-character pages
      function buildLineNoChar(charName, variant, story) {
        return `<div style="font-size:10px;line-height:1.5;margin-bottom:1px;">${buildLine(charName, variant, story)}</div>`;
      }
      
      // === Collect all next items across characters ===
      let allNextItems = []; // {charName, story, variants, date, info}
      charNames.forEach(cn => {
        const info = getCharInfo(cn);
        if (info.blocked || info.nextStories.length === 0) return;
        info.nextStories.forEach(s => {
          const variants = splitStoryVariants(s, cn);
          variants.forEach(v => {
            allNextItems.push({ charName: cn, story: s, variant: v, date: s.date, info });
          });
        });
      });
      
      // === Page 0: Nearest unlock date (relative to selectedDateKey) ===
      // Find nearest date >= selectedDateKey
      const futureDates = [...new Set(allNextItems.map(it => it.date))].sort();
      const nearestDate = futureDates.find(d => d >= key) || futureDates[0];
      
      if (nearestDate && allNextItems.length > 0) {
        const nearestItems = allNextItems.filter(it => it.date === nearestDate);
        let p0 = `<div style="font-size:10px;font-weight:600;color:#8b6914;margin-bottom:3px;">最近判定：${nearestDate.replace(/-/g, '/')}</div>`;
        nearestItems.forEach(it => {
          p0 += buildLineWithChar(it.charName, it.variant, it.story);
        });
        titlePages.push(p0);
      }
      
      // === Page 1+: Per-character pages ===
      charNames.forEach(cn => {
        const info = getCharInfo(cn);
        if (info.nextStories.length === 0 && !info.blocked) return;
        
        const curT = info.currentTitle;
        const special = ['BE','GE','SE'];
        let curLabel = curT ? ((special.includes(curT.type) ? curT.type + ' ' : '') + `「${curT.name}」`) : '';
        
        let page = `<div style="font-size:10px;font-weight:600;color:#8b6914;margin-bottom:2px;">${cn}${curLabel ? '·' + curLabel : ''}</div>`;
        
        if (info.blocked) {
          page += `<div style="font-size:9px;color:#999;font-style:italic;">已進入BE路線</div>`;
        } else if (info.nextStories.length > 0) {
          const nextDate = info.nextStories[0].date.replace(/-/g, '/');
          page += `<div style="font-size:9px;color:#a08060;margin-bottom:2px;">下個判定：${nextDate}</div>`;
          info.nextStories.forEach(s => {
            const variants = splitStoryVariants(s, cn);
            variants.forEach(v => {
              page += buildLineNoChar(cn, v, s);
            });
          });
        }
        titlePages.push(page);
      });
      
      if (titlePageIndex >= titlePages.length) titlePageIndex = 0;
      showTitlePage();
    }

// ===== 月經助手功能 =====
    function getPeriodDates() {
      // 獲取所有標記了月經的日期
      const periodDates = [];
      Object.keys(state.life.daily).forEach(key => {
        const d = state.life.daily[key];
        if (d && d.period && Number(d.period) >= 1) {
          periodDates.push(key);
        }
      });
      return periodDates.sort();
    }

    function getPeriodStreaks(periodDates) {
      // 將所有日期分成多段連續的月經期
      if (periodDates.length === 0) return [];
      const streaks = [];
      let currentStreak = [];
      
      for (let i = 0; i < periodDates.length; i++) {
        const current = periodDates[i];
        if (currentStreak.length === 0) {
          currentStreak.push(current);
        } else {
          const lastDate = dateFromKey(currentStreak[currentStreak.length - 1]);
          const currentDate = dateFromKey(current);
          const diff = (currentDate - lastDate) / (1000 * 60 * 60 * 24);
          
          if (diff === 1) {
            currentStreak.push(current);
          } else {
            streaks.push([...currentStreak]);
            currentStreak = [current];
          }
        }
      }
      if (currentStreak.length > 0) {
        streaks.push(currentStreak);
      }
      return streaks;
    }

    function getLastPeriodEndDate() {
      // 獲取「相對於選定日期」的上一次月經結束日期
      // 只考慮在選定日期之前（含）已結束的月經期
      const periodDates = getPeriodDates();
      if (periodDates.length === 0) return null;
      
      const selectedKey = state.selectedDateKey;
      
      // 只取選定日期之前（含）的月經日期
      const datesBeforeOrOn = periodDates.filter(d => d <= selectedKey);
      if (datesBeforeOrOn.length === 0) return null;
      
      const streaks = getPeriodStreaks(datesBeforeOrOn);
      if (streaks.length === 0) return null;
      
      // 檢查最後一段是否包含選定日（正在進行中的月經期）
      const lastStreak = streaks[streaks.length - 1];
      const isCurrentlyInPeriod = lastStreak.includes(selectedKey);
      
      if (isCurrentlyInPeriod) {
        // 正在經期中，返回「上上次」的結束日期
        if (streaks.length >= 2) {
          const previousStreak = streaks[streaks.length - 2];
          return previousStreak[previousStreak.length - 1];
        } else {
          return null;
        }
      } else {
        // 不在經期中，返回最後一段的最後一天
        // 但要確認這段是否已「結束」（即結束日期的次日不是月經日）
        const lastDay = lastStreak[lastStreak.length - 1];
        const nextDay = dateKeyFromDate(addDays(dateFromKey(lastDay), 1));
        // 如果nextDay也是月經日且在未來（超過選定日），仍認為已結束（因為我們不看未來）
        return lastDay;
      }
    }

    function getCurrentPeriodDay() {
      // 如果選定日是月經期，返回是第幾天
      const selectedKey = state.selectedDateKey;
      const periodDates = getPeriodDates();
      
      if (!periodDates.includes(selectedKey)) return null;
      
      // 往前數連續的月經天數
      let count = 1;
      let checkDate = addDays(dateFromKey(selectedKey), -1);
      
      while (periodDates.includes(dateKeyFromDate(checkDate))) {
        count++;
        checkDate = addDays(checkDate, -1);
      }
      
      return count;
    }

    function getDaysSinceLastPeriod() {
      // 獲取距離上次月經結束的天數（相對於選定日期）
      const lastEnd = getLastPeriodEndDate();
      if (!lastEnd) return null;
      
      const selected = dateFromKey(state.selectedDateKey);
      const lastEndDate = dateFromKey(lastEnd);
      const diff = Math.floor((selected - lastEndDate) / (1000 * 60 * 60 * 24));
      
      return diff;
    }

    function getPeriodPrediction() {
      // 預測下次月經日期（基於選定日期）
      const currentDay = getCurrentPeriodDay();
      const selected = dateFromKey(state.selectedDateKey);
      
      if (currentDay) {
        // 經期內：假設經期持續6天，然後28天後來下次
        const daysUntilEnd = 6 - currentDay;
        const estimatedEndDate = addDays(selected, daysUntilEnd);
        const predictDate = addDays(estimatedEndDate, 28);
        return dateKeyFromDate(predictDate);
      } else {
        // 非經期：上次結束後28天
        const lastEnd = getLastPeriodEndDate();
        if (!lastEnd) return null;
        
        const basicPredictDate = addDays(dateFromKey(lastEnd), 28);
        
        // 如果預測日期已經過了選定日（延遲情況）
        if (basicPredictDate < selected) {
          // 但不要跳過 — 返回原始預測日以便顯示延遲
          return dateKeyFromDate(basicPredictDate);
        }
        
        return dateKeyFromDate(basicPredictDate);
      }
    }

    function checkPeriodDelay() {
      // 檢查選定日期是否處於「延遲」狀態
      // 延遲 = 過了預測日但尚未來月經（基於選定日當時的視角）
      const selectedKey = state.selectedDateKey;
      const periodDates = getPeriodDates();
      const currentDay = getCurrentPeriodDay();
      
      // 如果選定日正在經期中，檢查這次經期是否延遲來的
      if (currentDay) {
        // 找到這次經期的第一天
        let firstDay = dateFromKey(selectedKey);
        while (periodDates.includes(dateKeyFromDate(addDays(firstDay, -1)))) {
          firstDay = addDays(firstDay, -1);
        }
        const firstDayKey = dateKeyFromDate(firstDay);
        
        // 找這次經期之前的上一次結束日
        const datesBeforeThisPeriod = periodDates.filter(d => d < firstDayKey);
        const streaksBefore = getPeriodStreaks(datesBeforeThisPeriod);
        if (streaksBefore.length > 0) {
          const prevEnd = streaksBefore[streaksBefore.length - 1];
          const prevEndDate = dateFromKey(prevEnd[prevEnd.length - 1]);
          const expectedDate = addDays(prevEndDate, 28);
          const delayDays = Math.floor((firstDay - expectedDate) / (1000 * 60 * 60 * 24));
          if (delayDays > 0) {
            return delayDays;
          }
        }
        return 0;
      }
      
      // 不在經期中，檢查是否超過預測日
      const lastEnd = getLastPeriodEndDate();
      if (!lastEnd) return 0;
      
      const selected = dateFromKey(selectedKey);
      const basicPredictDate = addDays(dateFromKey(lastEnd), 28);
      const delayDays = Math.floor((selected - basicPredictDate) / (1000 * 60 * 60 * 24));
      
      // 檢查在選定日之後是否有月經記錄（代表後來確實來了）
      // 但不影響延遲狀態的顯示 — 「那一天確實是延遲的」
      
      return delayDays > 0 ? delayDays : 0;
    }

    function checkPeriodReminder() {
      const key = state.selectedDateKey;
      const periodDates = getPeriodDates();
      const currentDay = getCurrentPeriodDay();
      const daysSince = getDaysSinceLastPeriod();
      const prediction = getPeriodPrediction();
      const delayDays = checkPeriodDelay();
      
      let message = null;
      let reminderType = null;
      
      // 情況1：今天是月經期
      if (currentDay) {
        if (delayDays > 0) {
          message = `今天是月經第 ${currentDay} 天（延遲 ${delayDays} 天後來潮），記得多休息、注意保暖哦。`;
        } else {
          message = `今天是月經第 ${currentDay} 天，記得多休息、注意保暖哦。`;
        }
        reminderType = 'current';
      }
      // 情況2：已延遲（超過預測日尚未來月經）
      else if (delayDays > 0) {
        message = `距離上次月經已經 ${daysSince} 天了，已延遲 ${delayDays} 天，請注意身體狀況。`;
        reminderType = 'delay';
      }
      // 情況3：預測日前3天提醒
      else if (prediction) {
        const predictDate = dateFromKey(prediction);
        const selected = dateFromKey(key);
        const daysUntil = Math.floor((predictDate - selected) / (1000 * 60 * 60 * 24));
        
        if (daysUntil >= 0 && daysUntil <= 3) {
          // 檢查這幾天是否已經來了
          let alreadyCame = false;
          for (let i = 0; i <= 3; i++) {
            const checkKey = dateKeyFromDate(addDays(dateFromKey(prediction), -i));
            if (periodDates.includes(checkKey)) {
              alreadyCame = true;
              break;
            }
          }
          
          if (!alreadyCame) {
            if (daysUntil === 0) {
              message = `根據週期計算，今天可能是月經來的日子，請注意身體變化。`;
            } else {
              message = `距離預計月經還有 ${daysUntil} 天，請提前準備。`;
            }
            reminderType = 'predict';
          }
        }
      }
      
      return { message, reminderType };
    }

   function showPeriodReminder() {
      const periodCard = document.getElementById('periodCard');
      const periodDates = getPeriodDates();
      const lastEnd = getLastPeriodEndDate();
      const daysSince = getDaysSinceLastPeriod();
      const prediction = getPeriodPrediction();
      const currentDay = getCurrentPeriodDay();
      const delayDays = checkPeriodDelay();
      const reminder = checkPeriodReminder();
      
      // 更新基本信息
      // 只看選定日之前（含）的記錄
      const datesBeforeOrOn = periodDates.filter(d => d <= state.selectedDateKey);
      if (datesBeforeOrOn.length === 0) {
        periodCard.classList.add('no-data');
        document.getElementById('periodStatus').textContent = '暫無月經記錄';
        document.getElementById('periodLastEnd').textContent = '--';
        document.getElementById('periodDaysSince').textContent = '--';
        document.getElementById('periodPredict').textContent = '--';
        return;
      }
      
      periodCard.classList.remove('no-data');
      
      // 上次結束日期
      if (lastEnd) {
        const d = dateFromKey(lastEnd);
        document.getElementById('periodLastEnd').textContent = `${d.getMonth()+1}/${d.getDate()}`;
      } else {
        document.getElementById('periodLastEnd').textContent = '--';
      }
      
      // 已過天數
      if (daysSince !== null) {
        document.getElementById('periodDaysSince').textContent = daysSince;
      } else {
        document.getElementById('periodDaysSince').textContent = '--';
      }
      
      // 預計下次
      if (prediction) {
        const d = dateFromKey(prediction);
        document.getElementById('periodPredict').textContent = `${d.getMonth()+1}/${d.getDate()}`;
      } else {
        document.getElementById('periodPredict').textContent = '--';
      }
      
      // 狀態文字
      if (currentDay) {
        const delayInfo = delayDays > 0 ? `（延遲${delayDays}天後來潮）` : '';
        document.getElementById('periodStatus').textContent = `🔴 月經第 ${currentDay} 天${delayInfo}`;
      } else if (delayDays > 0) {
        document.getElementById('periodStatus').textContent = `⚠️ 已延遲 ${delayDays} 天`;
      } else if (daysSince !== null) {
        document.getElementById('periodStatus').textContent = `週期正常，距上次 ${daysSince} 天`;
      } else {
        document.getElementById('periodStatus').textContent = '週期計算中...';
      }
      
      // 角色關心語
      if (!reminder.message) {
        document.getElementById('periodMessage').style.display = 'none';
        return;
      }
      
      document.getElementById('periodMessage').style.display = 'block';
      
      // 隨機選擇一個已解鎖的角色來發送提醒
      const unlockedChars = Object.keys(romanceData).filter(name => isCharUnlocked(state, name));
      const char = unlockedChars[Math.floor(Math.random() * unlockedChars.length)] || '曹丕';
      
      // 角色特色關心語
      const careMessages = {
        '曹丕': {
          current: `「今天是月經第 ${currentDay} 天，這幾日便不要太過操勞了。」`,
          predict: `「距離預計月經還有幾天，孤已命人備好薑湯。」`,
          delay: `「已經延遲了，可要請太醫診脈？」`
        },
        '劉協': {
          current: `「今天是月經第 ${currentDay} 天，朕略通醫理，這幾日可為卿診脈調養。」`,
          predict: `「快到日子了，朕會留意的。」`,
          delay: `「延遲了這麼久，朕有些擔心，可要去看看？」`
        },
        '郭嘉': {
          current: `「月經第 ${currentDay} 天了，今日便陪你在屋裡待著吧。」`,
          predict: `「快到日子了……我記著呢。」`,
          delay: `「延遲了？嗯？要不要讓我找個大夫？」`
        },
        '荀彧': {
          current: `「今天是第 ${currentDay} 天，我備了些紅棗枸杞茶，對身體好。」`,
          predict: `「快到日子了，這幾日注意飲食清淡。」`,
          delay: `「延遲了這麼久，若有不適，切莫強撐。」`
        },
        '曹植': {
          current: `「月經第 ${currentDay} 天，我新寫了首詩，念給你聽可好？」`,
          predict: `「快到日子了，我會記得提醒你的。」`,
          delay: `「延遲了……你沒事吧？我很擔心……」`
        },
        '司馬懿': {
          current: `「今天是第 ${currentDay} 天，這幾日的事我來處理。」`,
          predict: `「快到日子了，注意身體。」`,
          delay: `「延遲了，需要我做什麼嗎？」`
        }
      };
      
      const charMessages = careMessages[char] || careMessages['曹丕'];
      const displayMessage = charMessages[reminder.reminderType] || `「請注意身體。」`;
      
      document.getElementById('periodMsgFrom').textContent = `來自${char}的關心`;
      document.getElementById('periodMsgText').textContent = displayMessage;
    }

    // ===== 金風玉露面板 =====
    let currentRomanceChar = '曹丕';
    let spinnerResult = null;

    function initRomanceState() {
      if (!state.romance) {
        state.romance = {
          spinHistory: {}, // dateKey -> true
        };
      }
      // 為每個角色初始化
      Object.keys(romanceData).forEach(charName => {
        if (!state.romance[charName]) {
          state.romance[charName] = {
            unlocked: [], // 已解鎖的劇情ID，格式如 'cp_s1', 'cp_r0_r', 'cp_r0_f'
            affinityRecords: [], // [{date, value, hasUnion}]
            beExpired: [] // BE日期已過但未觸發的故事ID
          };
        }
        if (!state.romance[charName].beExpired) {
          state.romance[charName].beExpired = [];
        }
      });
    }

    function getAttributeValue(attrKey, dateKey) {
      // 根據屬性key獲取對應的加權值
      switch (attrKey) {
        case 'jobFate': return computeJobFate(computeJobAuspiciousForWeek(dateKey).sum);
        case 'thesisLeling': {
          const weekly = computeWeeklyWords(state.thesis.dailyEntries, dateKey);
          const rumor = weekly.words / 1000;
          return rumor >= 3 ? 2 : (rumor < 1 ? 0.5 : 1);
        }
        case 'fictionSpirit': {
          const weekly = computeWeeklyWords(state.fiction.dailyEntries, dateKey);
          const tale = weekly.words / 1000;
          return tale >= 3 ? 4 : (tale < 1 ? 1 : 2);
        }
        case 'moneyFreedom': {
          const streak = computeMoneyStreakUntil(dateKey);
          return streak < 15 ? 0.5 : (streak > 60 ? 2 : 1);
        }
        case 'lifeGrace': {
          const streak = computeLifeStreakUntil(dateKey);
          return streak < 15 ? 0.5 : (streak > 60 ? 2 : 1);
        }
        case 'readDifferent': {
          const streak = computeReadStreakUntil(dateKey);
          return streak < 15 ? 0.5 : (streak > 60 ? 2 : 1);
        }
        default: return 1;
      }
    }

    function canUnlockStory(charName, story, choiceType) {
      const key = state.selectedDateKey;
      const charData = state.romance[charName];
      const unlocked = charData?.unlocked || [];
      
      // 檢查日期
      if (key < story.date) return { can: false, reason: '未到解鎖日期' };
      
      // 檢查是否已解鎖
      const storyIdBase = story.id;
      const typeLC = choiceType ? choiceType.toLowerCase() : '';
      
      if (typeLC === 'r' && unlocked.includes(storyIdBase + '_r')) return { can: false, reason: '已解鎖' };
      if (typeLC === 'f' && unlocked.includes(storyIdBase + '_f')) return { can: false, reason: '已解鎖' };
      if (typeLC === 'be' && unlocked.includes(storyIdBase + '_be')) return { can: false, reason: '已解鎖' };
      if (typeLC === 'ge' && unlocked.includes(storyIdBase + '_ge')) return { can: false, reason: '已解鎖' };
      if (typeLC === 'se' && unlocked.includes(storyIdBase + '_se')) return { can: false, reason: '已解鎖' };
      if (typeLC === 's' && (unlocked.includes(storyIdBase + '_s') || unlocked.includes(storyIdBase))) return { can: false, reason: '已解鎖' };
      
      // 檢查前置劇情
      const stories = romanceData[charName].stories;
      const storyIndex = stories.findIndex(s => s.id === story.id);
      if (storyIndex > 0) {
        const prevStory = stories[storyIndex - 1];
        const prevUnlocked = unlocked.some(id => id.startsWith(prevStory.id) && !id.includes('_be'));
        if (!prevUnlocked) return { can: false, reason: '需先解鎖前置劇情' };
        // 檢查前置是否為BE
        if (unlocked.some(id => id.startsWith(prevStory.id) && id.includes('_be'))) {
          return { can: false, reason: '前置劇情為BE，後續不可解鎖' };
        }
      }
      
      // S類型特殊處理：無條件或條件全部滿足即可
      if (story.type === 'S' && typeLC === 's') {
        const conditions = story.conditions || [];
        if (conditions.length === 0) return { can: true };
        const allMet = conditions.every(cond => cond.check(state, key));
        if (!allMet) return { can: false, reason: '條件未滿足' };
        return { can: true };
      }
      
      // 檢查條件
      const conditions = story.conditions || [];
      let allMet = true;
      
      conditions.forEach(cond => {
        // 根據選擇的類型過濾條件
        if (typeLC === 'r' && cond.forF) return;
        if (typeLC === 'r' && cond.forBE) return;
        if (typeLC === 'f' && cond.forR) return;
        if (typeLC === 'f' && cond.forBE) return;
        if (typeLC === 'be' && cond.forR) return;
        if (typeLC === 'be' && cond.forF) return;
        if (typeLC === 'be' && cond.forGE) return;
        if (typeLC === 'be' && cond.forSE) return;
        if (typeLC === 'ge' && cond.forBE) return;
        if (typeLC === 'se' && cond.forBE) return;
        
        if (!cond.check(state, key)) allMet = false;
      });
      
      if (!allMet) return { can: false, reason: '條件未滿足' };
      
      return { can: true };
    }

function unlockStory(charName, storyId, choiceType) {
      initRomanceState();
      const typeLC = choiceType ? choiceType.toLowerCase() : '';
      const suffix = typeLC ? '_' + typeLC : '';
      const fullId = storyId + suffix;
      
      if (!state.romance[charName].unlocked.includes(fullId)) {
        state.romance[charName].unlocked.push(fullId);
        saveState();
        
        // 添加到動態軸
        const story = romanceData[charName].stories.find(s => s.id === storyId);
        let storyName = story.name;
        if (typeLC === 'f' && story.altName) storyName = story.altName;
        if (typeLC === 'be' && story.altName && story.altType === 'BE') storyName = story.altName;
        if (typeLC === 'be' && story.beName) storyName = story.beName;
        
        const displayType = choiceType || story.type;
        
        const timeline = getTimeline(state.selectedDateKey);
        const now = new Date();
        timeline.push({
          id: generateId(),
          text: `🎭 解鎖【${charName}】劇情：${storyName}（${displayType}）`,
          images: [],
          timestamp: now.getTime(),
          hour: now.getHours(),
          minute: now.getMinutes(),
          tag: null,
          isAuto: true,
          autoData: { module: 'romance', storyId: fullId }
        });
        saveState();
      }
    }

    function renderRomanceCharTabs() {
      const tabs = document.getElementById('romanceCharTabs');
      tabs.innerHTML = '';
      
      Object.keys(romanceData).forEach(charName => {
        const char = characters.find(c => c.name === charName);
        const unlocked = isCharUnlocked(state, charName);
        
        const tab = document.createElement('div');
        tab.className = 'romance-char-tab' + (currentRomanceChar === charName ? ' active' : '') + (!unlocked ? ' locked' : '');
        tab.innerHTML = `
          <div class="char-avatar-small">${char?.avatar || charName[0]}</div>
          <span>${charName}</span>
          ${!unlocked ? '<span style="font-size:9px;">🔒</span>' : ''}
        `;
        
        if (unlocked) {
          tab.onclick = () => {
            currentRomanceChar = charName;
            renderRomancePanel();
          };
        }
        
        tabs.appendChild(tab);
      });
    }

    function renderRomancePanel() {
      renderRomanceCharTabs();
      
      const panel = document.getElementById('romanceCharPanel');
      const charName = currentRomanceChar;
      const charData = romanceData[charName];
      const char = characters.find(c => c.name === charName);
      const key = state.selectedDateKey;
      
      if (!isCharUnlocked(state, charName)) {
        panel.innerHTML = `<div class="romance-panel"><p style="text-align:center;color:#999;">此角色尚未解鎖</p></div>`;
        return;
      }
      
      initRomanceState();
      const stateChar = state.romance[charName];
      const affinity = getCharAffinity(state, charName, key);
      const unionCount = getUnionCount(state, charName, key);
      const attrValue = getAttributeValue(charData.attributeKey, key);
      
      let html = `
        <div class="romance-panel">
          <div class="romance-header">
            <div class="romance-avatar">${char?.avatar || charName[0]}</div>
            <div class="romance-info">
              <h4>${charName}</h4>
              <div class="subtitle">${char?.title || ''} ｜ 加權屬性：${charData.attribute}（${attrValue}）｜ 結合事件：${charData.unionEvent}</div>
            </div>
            <div class="romance-stats">
              <div class="romance-stat-item">
                <span class="stat-label">好感度</span>
                <span class="stat-value">${affinity}</span>
              </div>
              <div class="romance-stat-item">
                <span class="stat-label">${charData.unionEvent}</span>
                <span class="stat-value">${unionCount}</span>
              </div>
            </div>
          </div>
          
          <div class="romance-story-list">
      `;
      
      charData.stories.forEach((story, storyIdx) => {
        const unlocked = stateChar.unlocked || [];
        const isUnlockedR = unlocked.includes(story.id + '_r');
        const isUnlockedF = unlocked.includes(story.id + '_f');
        const isUnlockedBE = unlocked.includes(story.id + '_be');
        const isUnlockedGE = unlocked.includes(story.id + '_ge');
        const isUnlockedSE = unlocked.includes(story.id + '_se');
        const isUnlockedS = unlocked.includes(story.id + '_s') || unlocked.includes(story.id);
        
        const dateReached = key >= story.date;
        
        // 判斷此故事是否被封鎖（需要加半透明斜線overlay）
        let isBlocked = false;
        // 1. 前置故事為BE → 後續全部封鎖
        if (storyIdx > 0) {
          for (let pi = 0; pi < storyIdx; pi++) {
            const prev = charData.stories[pi];
            if (unlocked.some(id => id.startsWith(prev.id) && id.endsWith('_be'))) {
              isBlocked = true;
              break;
            }
          }
        }
        // 2. BE日期已過但未觸發 → BE框封鎖
        const beExpired = stateChar.beExpired || [];
        const hasBECond = (story.conditions || []).some(c => c.forBE);
        const isBEStory = story.type === 'BE' || story.altType === 'BE' || story.beName;
        if (isBEStory && beExpired.includes(story.id) && !isUnlockedBE) {
          // 只封鎖BE那一側，不封鎖整個故事
        }
        // 3. R/F互斥：如果同級的R已解鎖，F被封鎖；反之亦然
        // 曹丕cp_r0: R='金屋藏嬌' F='樂未央' → 選了F則R封鎖
        const hasDualEndings = story.altName && (story.altType === 'F' || story.altType === 'R' || story.altType === 'BE');
        let mainBlocked = false;
        let altBlocked = false;
        if (hasDualEndings) {
          const isAnyUnlocked = isUnlockedR || isUnlockedF || isUnlockedBE || isUnlockedGE || isUnlockedSE;
          if (isAnyUnlocked) {
            // 選了R → alt(F)被封鎖
            if (isUnlockedR && story.altType === 'F') altBlocked = true;
            if (isUnlockedR && story.altType === 'BE') altBlocked = true;
            // 選了F → main(R)被封鎖
            if (isUnlockedF && story.type === 'R') mainBlocked = true;
            // 選了BE → both others blocked
            if (isUnlockedBE) { mainBlocked = true; altBlocked = true; }
          }
        }
        const hasTripleEndings = story.beName;
        
        if (hasDualEndings && !hasTripleEndings) {
          // 雙頭銜劇情：並排展示為兩個獨立框框
          const mainType = story.type;
          const altType = story.altType;
          
          // 主類型頭銜
          const mainUnlocked = mainType === 'R' ? isUnlockedR : 
                              (mainType === 'F' ? isUnlockedF : 
                              (mainType === 'BE' ? isUnlockedBE :
                              (mainType === 'GE' ? isUnlockedGE : isUnlockedS)));
          
          // 構建主類型條件顯示（分類顯示）
          let mainCondHtml = '<div class="story-conditions">';
          const mainConds = (story.conditions || []).filter(cond => 
            cond.common || (mainType === 'R' && cond.forR) || (mainType === 'BE' && cond.forBE) || (mainType === 'GE' && cond.forGE) ||
            (!cond.forR && !cond.forF && !cond.forBE && !cond.forGE && !cond.forSE && !cond.common)
          );
         mainConds.forEach(cond => {
            const met = cond.check(state, key);
            const cls = cond.forBE ? (met ? 'cond-be-met' : 'cond-be-unmet') : (met ? 'cond-met' : 'cond-unmet');
            mainCondHtml += `<span class="${cls}">${cond.text}</span><br/>`;
          });
          mainCondHtml += '</div>';
          
          // 主類型圖標
          let mainIcon = '⬜';
          if (mainUnlocked) {
            mainIcon = mainType === 'R' ? '💕' : (mainType === 'BE' ? '💔' : (mainType === 'GE' ? '👑' : '✅'));
          }
          
          let mainItemClass = 'romance-story-item';
          if (mainUnlocked) mainItemClass += ' unlocked';
          if (mainType === 'BE') mainItemClass += ' be';
          if (isBlocked || mainBlocked) mainItemClass += ' blocked-overlay';
          
          // 主類型解鎖按鈕
          let mainBtnHtml = '';
          const isAnyUnlocked = isUnlockedR || isUnlockedF || isUnlockedBE || isUnlockedGE || isUnlockedSE;
          if (!mainUnlocked && !isAnyUnlocked && dateReached) {
            const canMain = canUnlockStory(charName, story, mainType);
            if (canMain.can) {
              const btnClass = mainType === 'BE' ? 'btn-danger' : 'btn-primary';
              mainBtnHtml = `<button class="btn ${btnClass} story-unlock-btn" data-char="${charName}" data-story="${story.id}" data-type="${mainType}">解鎖</button>`;
            }
          }
          let mainStatus = mainUnlocked ? `<span style="color:${mainType === 'BE' ? '#c04040' : '#4a7c59'};font-size:10px;">✓ 已解鎖</span>` : '';
          
          // 副類型頭銜
          const altUnlocked = altType === 'R' ? isUnlockedR : 
                             (altType === 'F' ? isUnlockedF : 
                             (altType === 'BE' ? isUnlockedBE : isUnlockedS));
          
          // 構建副類型條件顯示
          let altCondHtml = '<div class="story-conditions">';
          const altConds = (story.conditions || []).filter(cond => 
            cond.common || (altType === 'F' && cond.forF) || (altType === 'R' && cond.forR) || (altType === 'BE' && cond.forBE)
          );
        altConds.forEach(cond => {
            const met = cond.check(state, key);
            const cls = cond.forBE ? (met ? 'cond-be-met' : 'cond-be-unmet') : (met ? 'cond-met' : 'cond-unmet');
            altCondHtml += `<span class="${cls}">${cond.text}</span><br/>`;
          });
          altCondHtml += '</div>';
          
          // 副類型圖標
          let altIcon = '⬜';
          if (altUnlocked) {
            altIcon = altType === 'F' ? '🤝' : (altType === 'R' ? '💕' : (altType === 'BE' ? '💔' : '✅'));
          }
          
          let altItemClass = 'romance-story-item';
          if (altUnlocked) altItemClass += ' unlocked';
          if (altType === 'BE') altItemClass += ' be';
          if (isBlocked || altBlocked) altItemClass += ' blocked-overlay';
          
          // 副類型解鎖按鈕
          let altBtnHtml = '';
          if (!altUnlocked && !isAnyUnlocked && dateReached) {
            const canAlt = canUnlockStory(charName, story, altType);
            if (canAlt.can) {
              const btnClass = altType === 'BE' ? 'btn-danger' : (altType === 'R' ? 'btn-primary' : 'btn-ghost');
              altBtnHtml = `<button class="btn ${btnClass} story-unlock-btn" data-char="${charName}" data-story="${story.id}" data-type="${altType}">解鎖</button>`;
            }
          }
          let altStatus = altUnlocked ? `<span style="color:${altType === 'BE' ? '#c04040' : (altType === 'F' ? '#6080c0' : '#4a7c59')};font-size:10px;">✓ 已解鎖</span>` : '';
          
          // 並排顯示
          html += `
            <div class="story-row" style="display:flex;gap:8px;">
              <div class="${mainItemClass}" style="flex:1;">
                <div class="story-icon">${mainIcon}</div>
                <div class="story-content">
                  <div class="story-title ${mainUnlocked ? '' : 'locked'}">${mainType} ${story.name}</div>
                  <div class="story-date">${story.date} 可解鎖 ${mainStatus}</div>
                  ${mainCondHtml}
                </div>
                <div>${mainBtnHtml}</div>
              </div>
              <div class="${altItemClass}" style="flex:1;">
                <div class="story-icon">${altIcon}</div>
                <div class="story-content">
                  <div class="story-title ${altUnlocked ? '' : 'locked'}">${altType} ${story.altName}</div>
                  <div class="story-date">${story.date} 可解鎖 ${altStatus}</div>
                  ${altCondHtml}
                </div>
                <div>${altBtnHtml}</div>
              </div>
            </div>
          `;
          
        } else if (hasTripleEndings) {
          // 三頭銜劇情（BE/R/F）：分開展示為三個獨立框框
          const types = ['BE', 'R', 'F'];
          const names = [story.beName, story.name, story.altName];
          const unlockedMap = { 'BE': isUnlockedBE, 'R': isUnlockedR, 'F': isUnlockedF };
          const iconMap = { 'BE': '💔', 'R': '💕', 'F': '🤝' };
          const btnClassMap = { 'BE': 'btn-danger', 'R': 'btn-primary', 'F': 'btn-ghost' };
          const colorMap = { 'BE': '#c04040', 'R': '#c06080', 'F': '#6080c0' };
          
          html += `<div class="story-row" style="display:flex;gap:8px;flex-wrap:wrap;">`;
          
          types.forEach((type, idx) => {
            const isThisUnlocked = unlockedMap[type];
            const isAnyUnlocked = isUnlockedR || isUnlockedF || isUnlockedBE;
            
            // 構建條件顯示
            let condHtml = '<div class="story-conditions">';
            (story.conditions || []).forEach(cond => {
              const forThisType = (type === 'R' && cond.forR) || (type === 'F' && cond.forF) || (type === 'BE' && cond.forBE) || cond.common;
              if (forThisType) {
                const met = cond.check(state, key);
                let prefix = '';
                if (cond.common) prefix = '【共通】';
                condHtml += `<span class="${cond.forBE ? (met ? 'cond-be-met' : 'cond-be-unmet') : (met ? 'cond-met' : 'cond-unmet')}">${prefix}${cond.text}</span><br/>`;
              }
            });
            condHtml += '</div>';
            
            let icon = isThisUnlocked ? iconMap[type] : '⬜';
            let itemClass = 'romance-story-item';
            if (isThisUnlocked) itemClass += ' unlocked';
            if (type === 'BE') itemClass += ' be';
            if (isBlocked) itemClass += ' blocked-overlay';
            // R/F互斥封鎖
            if (isAnyUnlocked && !isThisUnlocked) itemClass += ' blocked-overlay';
            
            let btnHtml = '';
            if (!isAnyUnlocked && dateReached) {
              const canThis = canUnlockStory(charName, story, type);
              if (canThis.can) {
                btnHtml = `<button class="btn ${btnClassMap[type]} story-unlock-btn" data-char="${charName}" data-story="${story.id}" data-type="${type}">解鎖</button>`;
              }
            }
            let statusText = isThisUnlocked ? `<span style="color:${colorMap[type]};font-size:10px;">✓ 已解鎖</span>` : '';
            
            html += `
              <div class="${itemClass}" style="flex:1;min-width:150px;">
                <div class="story-icon">${icon}</div>
                <div class="story-content">
                  <div class="story-title ${isThisUnlocked ? '' : 'locked'}">${type} ${names[idx]}</div>
                  <div class="story-date">${story.date} 可解鎖 ${statusText}</div>
                  ${condHtml}
                </div>
                <div>${btnHtml}</div>
              </div>
            `;
          });
          
          html += `</div>`;
          
        } else {
          // 單一頭銜劇情
          const isAnyUnlocked = isUnlockedR || isUnlockedF || isUnlockedBE || isUnlockedGE || isUnlockedSE || isUnlockedS;
          const isBE = story.type === 'BE';
          
          // 構建條件顯示（分類）
          let condHtml = '<div class="story-conditions">';
          const conditions = story.conditions || [];
          
          if (conditions.length === 0 && story.type === 'S') {
            condHtml += '<span class="cond-met">無條件限制（需手動解鎖）</span><br/>';
          } else {
            conditions.forEach(cond => {
              const met = cond.check(state, key);
              let prefix = '';
              if (cond.forR) prefix = '【R】';
              if (cond.forF) prefix = '【F】';
              if (cond.forBE) prefix = '【BE】';
              if (cond.forGE) prefix = '【GE】';
              if (cond.forSE) prefix = '【SE】';
              if (cond.common) prefix = '【共通】';
              condHtml += `<span class="${cond.forBE ? (met ? 'cond-be-met' : 'cond-be-unmet') : (met ? 'cond-met' : 'cond-unmet')}">${prefix}${cond.text}</span><br/>`;
            });
          }
          condHtml += '</div>';
          
          // 狀態圖標
          let icon = '⬜';
          if (isUnlockedR) icon = '💕';
          else if (isUnlockedF) icon = '🤝';
          else if (isUnlockedBE) icon = '💔';
          else if (isUnlockedGE) icon = '👑';
          else if (isUnlockedSE) icon = '✨';
          else if (isUnlockedS) icon = '✅';
          
          let itemClass = 'romance-story-item';
          if (isAnyUnlocked) itemClass += ' unlocked';
          if (isBE && isUnlockedBE) itemClass += ' be unlocked';
          else if (isBE) itemClass += ' be';
          if (isBlocked) itemClass += ' blocked-overlay';
          // BE expired overlay (date passed, not triggered)
          if (isBE && beExpired.includes(story.id) && !isUnlockedBE) itemClass += ' blocked-overlay';
          
          // 解鎖按鈕
          let buttonsHtml = '';
          if (!isAnyUnlocked && dateReached) {
            if (story.type === 'S') {
              const canS = canUnlockStory(charName, story, 'S');
              if (canS.can || conditions.length === 0) {
                buttonsHtml = `<button class="btn btn-primary story-unlock-btn" data-char="${charName}" data-story="${story.id}" data-type="S">解鎖</button>`;
              }
            } else {
              const canUnlock = canUnlockStory(charName, story, story.type);
              if (canUnlock.can) {
                const btnClass = story.type === 'BE' ? 'btn-danger' : (story.type === 'GE' ? 'btn-primary' : 'btn-ghost');
                buttonsHtml = `<button class="btn ${btnClass} story-unlock-btn" data-char="${charName}" data-story="${story.id}" data-type="${story.type}">解鎖</button>`;
              }
            }
          }
          
          // 已解鎖狀態顯示
          let statusText = '';
          if (isUnlockedR) statusText = '<span style="color:#c06080;font-size:10px;">✓ 已解鎖 R</span>';
          else if (isUnlockedF) statusText = '<span style="color:#6080c0;font-size:10px;">✓ 已解鎖 F</span>';
          else if (isUnlockedBE) statusText = '<span style="color:#c04040;font-size:10px;">✓ 已解鎖 BE</span>';
          else if (isUnlockedGE) statusText = '<span style="color:#d4af37;font-size:10px;">✓ 已解鎖 GE</span>';
          else if (isUnlockedSE) statusText = '<span style="color:#9060c0;font-size:10px;">✓ 已解鎖 SE</span>';
          else if (isUnlockedS) statusText = '<span style="color:#4a7c59;font-size:10px;">✓ 已解鎖</span>';
          
          // 標題
          let typeLabel = story.type;
          if (story.type === 'S') typeLabel = `S${storyIdx + 1}`;
          
          html += `
            <div class="${itemClass}">
              <div class="story-icon">${icon}</div>
              <div class="story-content">
                <div class="story-title ${isAnyUnlocked ? '' : 'locked'}">${typeLabel} ${story.name}</div>
                <div class="story-date">${story.date} 可解鎖 ${statusText}</div>
                ${condHtml}
              </div>
              <div>${buttonsHtml}</div>
            </div>
          `;
        }
      });
      
      html += '</div></div>';
      panel.innerHTML = html;
      
      // 綁定解鎖按鈕事件
      panel.querySelectorAll('.story-unlock-btn').forEach(btn => {
        btn.onclick = () => {
          const char = btn.dataset.char;
          const storyId = btn.dataset.story;
          const type = btn.dataset.type;
          if (confirm(`確定要解鎖【${char}】的此劇情（${type}）嗎？`)) {
            unlockStory(char, storyId, type);
            renderRomancePanel();
            renderTimeline();
          }
        };
      });
    }

    function renderAffinitySpinner() {
      const area = document.getElementById('affinitySpinnerContent');
      const key = state.selectedDateKey;
      const now = new Date();
      const h = now.getHours();
      const okTime = (h >= 22 || h < 1);
      const elegance = calcElegance(key);
      const charm = calcCharm(key);
      const spunToday = hasSpunToday(state, key);
      
      // 檢查解鎖條件
      const canSpin = okTime && elegance >= 80 && charm >= 80 && !spunToday;
      
      // 獲取可用角色（已解鎖的）
      const availableChars = Object.keys(romanceData).filter(name => isCharUnlocked(state, name));
      
      // 顯示解鎖條件狀態
      let statusHtml = `
        <div style="background:rgba(250,246,236,0.9);border-radius:8px;padding:12px;margin-bottom:16px;border:1px solid rgba(178,144,90,0.3);">
          <div style="font-size:12px;font-weight:500;color:#8b6914;margin-bottom:8px;">轉盤解鎖條件</div>
          <div style="font-size:11px;display:grid;grid-template-columns:1fr 1fr;gap:6px;">
            <span class="${okTime ? 'cond-met' : 'cond-unmet'}">⏰ 時間 22:00～01:00 ${okTime ? '✓' : '✗'}</span>
            <span class="${elegance >= 80 ? 'cond-met' : 'cond-unmet'}">✨ 氣質 ≥ 80（當前：${elegance}）${elegance >= 80 ? '✓' : '✗'}</span>
            <span class="${charm >= 80 ? 'cond-met' : 'cond-unmet'}">💄 魅力 ≥ 80（當前：${charm}）${charm >= 80 ? '✓' : '✗'}</span>
            <span class="${!spunToday ? 'cond-met' : 'cond-unmet'}">🎯 今日未使用 ${!spunToday ? '✓' : '（已使用）'}</span>
          </div>
        </div>
      `;
      
      if (!canSpin) {
        let reason = '';
        if (spunToday) reason = '今日已轉過轉盤，明天再來吧！';
        else if (!okTime) reason = '請在 22:00～01:00 時段使用轉盤';
        else if (elegance < 80) reason = `氣質不足，需 ≥ 80（當前：${elegance}）`;
        else if (charm < 80) reason = `魅力不足，需 ≥ 80（當前：${charm}）`;
        
        area.innerHTML = statusHtml + `
          <div style="text-align:center;padding:30px;color:#a08060;">
            <p style="font-size:40px;margin:0 0 12px;">🔒</p>
            <p style="font-size:12px;margin:0;">${reason}</p>
          </div>
        `;
        return;
      }
      
      if (availableChars.length === 0) {
        area.innerHTML = statusHtml + `<div style="text-align:center;padding:20px;color:#999;">暫無已解鎖的角色可參與轉盤</div>`;
        return;
      }
      
      area.innerHTML = statusHtml + `
        <div style="text-align:center;">
          <div class="spinner-wheel" style="margin:0 auto;">
            <div class="spinner-pointer"></div>
            <div class="spinner-circle" id="affinitySpinnerCircle" style="background:conic-gradient(${availableChars.map((c, i) => {
              const from = (i / availableChars.length) * 100;
              const to = ((i + 1) / availableChars.length) * 100;
              const col = i % 2 === 0 ? '#f8f4e8' : '#efe8d8';
              return `${col} ${from}% ${to}%`;
            }).join(',')});">
              ${availableChars.map((c, i) => {
                const char = characters.find(ch => ch.name === c);
                const sliceAngle = 360 / availableChars.length;
                const angle = (i + 0.5) * sliceAngle;
                const r = 75;
                const rad = (angle - 90) * Math.PI / 180;
                const x = Math.cos(rad) * r;
                const y = Math.sin(rad) * r;
                return `<div class="spinner-avatar" style="left:calc(50% + ${x}px);top:calc(50% + ${y}px);transform:translate(-50%,-50%);">${char?.avatar || c[0]}</div>`;
              }).join('')}
            </div>
          </div>
          <div id="affinitySpinnerResult" style="min-height:80px;margin:16px 0;"></div>
          <button id="affinitySpinBtn" class="btn btn-primary" style="padding:10px 30px;font-size:13px;">開始轉動</button>
        </div>
      `;
      
      // 綁定轉盤按鈕
      document.getElementById('affinitySpinBtn').onclick = () => spinAffinityWheel(availableChars);
    }

    let affinitySpinnerRotation = 0;
    let affinitySpinning = false;

    function spinAffinityWheel(availableChars) {
      if (affinitySpinning) return;
      affinitySpinning = true;
      
      const btn = document.getElementById('affinitySpinBtn');
      btn.disabled = true;
      btn.textContent = '轉動中...';
      
      const circleEl = document.getElementById('affinitySpinnerCircle');
      const sliceAngle = 360 / availableChars.length;
      const chosenIndex = Math.floor(Math.random() * availableChars.length);
      const angleCenter = chosenIndex * sliceAngle + sliceAngle / 2;
      const desiredAngle = (360 - angleCenter) % 360;
      const base = ((affinitySpinnerRotation % 360) + 360) % 360;
      const offset = (desiredAngle - base + 360) % 360;
      const extraSpins = 5 + Math.floor(Math.random() * 3);
      affinitySpinnerRotation = affinitySpinnerRotation + extraSpins * 360 + offset;
      
      circleEl.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
      circleEl.style.transform = `rotate(${affinitySpinnerRotation}deg)`;
      
      setTimeout(() => {
        affinitySpinning = false;
        btn.disabled = false;
        btn.textContent = '已完成';
        btn.style.display = 'none';
        
        const selectedChar = availableChars[chosenIndex];
        spinnerResult = { char: selectedChar };
        
        // 標記今日已轉
        if (!state.romance.spinHistory) state.romance.spinHistory = {};
        state.romance.spinHistory[state.selectedDateKey] = true;
        saveState();
        
        showAffinityResult(selectedChar);
      }, 4000);
    }

    function showAffinityResult(charName) {
      const key = state.selectedDateKey;
      const charm = calcCharm(key);
      const charData = romanceData[charName];
      const char = characters.find(c => c.name === charName);
      const attrValue = getAttributeValue(charData.attributeKey, key);
      
      const resultDiv = document.getElementById('affinitySpinnerResult');
      
      // 基礎好感度計算
      const baseAffinity = Math.round(attrValue * charm);
      
      let html = `
        <div class="romance-result-card" style="text-align:left;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <div class="romance-avatar" style="width:45px;height:45px;font-size:18px;">${char?.avatar || charName[0]}</div>
            <div>
              <div style="font-size:15px;color:#8b6914;font-weight:500;">${charName}</div>
              <div style="font-size:11px;color:#a08060;">${char?.title || ''}</div>
            </div>
          </div>
          <div class="affinity-formula" style="margin-bottom:12px;">
            <div style="font-weight:500;margin-bottom:6px;">好感度計算公式：</div>
            ${charData.attribute}（${attrValue}）× 魅力（${charm}）= <strong style="color:#8b6914;font-size:14px;">${baseAffinity}</strong>
          </div>
      `;
      
      // 檢查是否可以進入結合事件（魅力 >= 90）
      if (charm >= 90) {
        html += `
          <div style="padding:12px;background:rgba(212,175,55,0.15);border-radius:8px;border:1px solid rgba(212,175,55,0.4);">
            <p style="font-size:13px;color:#8b6914;margin:0 0 8px;font-weight:500;">✨ 魅力達到90！</p>
            <p style="font-size:11px;color:#6b5a4a;margin:0 0 10px;">可進入結合事件【${charData.unionEvent}】，額外獲得 +20 好感度</p>
            <div style="display:flex;gap:8px;">
              <button id="unionEventYesBtn" class="btn btn-primary" style="font-size:12px;">進入【${charData.unionEvent}】</button>
              <button id="unionEventNoBtn" class="btn btn-ghost" style="font-size:12px;">跳過</button>
            </div>
          </div>
        `;
      } else {
        html += `
          <div style="text-align:center;margin-top:8px;">
            <button id="confirmAffinityBtn" class="btn btn-primary" style="font-size:12px;padding:8px 20px;">確認獲得 +${baseAffinity} 好感度</button>
          </div>
        `;
      }
      
      html += '</div>';
      resultDiv.innerHTML = html;
      
      // 綁定按鈕
      if (charm >= 90) {
        document.getElementById('unionEventYesBtn').onclick = () => {
          confirmAffinity(charName, baseAffinity + 20, true);
        };
        document.getElementById('unionEventNoBtn').onclick = () => {
          confirmAffinity(charName, baseAffinity, false);
        };
      } else {
        document.getElementById('confirmAffinityBtn').onclick = () => {
          confirmAffinity(charName, baseAffinity, false);
        };
      }
    }

    function confirmAffinity(charName, value, hasUnion) {
      const key = state.selectedDateKey;
      initRomanceState();
      
      // 記錄好感度
      if (!state.romance[charName].affinityRecords) {
        state.romance[charName].affinityRecords = [];
      }
      state.romance[charName].affinityRecords.push({
        date: key,
        value: value,
        hasUnion: hasUnion
      });
      
      saveState();
      
      // 添加到動態軸
      const charData = romanceData[charName];
      let text = `💕 與【${charName}】互動，好感度 +${value}`;
      if (hasUnion) {
        text = `💕 與【${charName}】${charData.unionEvent}，好感度 +${value}（含結合事件bonus）`;
      }
      
      const timeline = getTimeline(key);
      const now = new Date();
      timeline.push({
        id: generateId(),
        text: text,
        images: [],
        timestamp: now.getTime(),
        hour: now.getHours(),
        minute: now.getMinutes(),
        tag: null,
        isAuto: true,
        autoData: { module: 'romance', type: 'affinity' }
      });
      saveState();
      
      // 更新顯示
      const resultDiv = document.getElementById('affinitySpinnerResult');
      const newTotal = getCharAffinity(state, charName, key);
      resultDiv.innerHTML = `
        <div class="romance-result-card" style="text-align:center;">
          <p style="color:#4a7c59;font-size:14px;margin:0 0 8px;">
            ✓ 已獲得【${charName}】好感度 +${value}
          </p>
          <p style="font-size:12px;color:#6b5a4a;margin:0;">
            當前累計好感度：<strong style="color:#8b6914;">${newTotal}</strong>
          </p>
        </div>
      `;
      
      renderTimeline();
      renderDailyAttrs();
    }

 // ===== 動態軸 渲染 =====
    let timelineImages = []; // 暫存待發佈圖片

    function renderTimeline() {
      const key = state.selectedDateKey;
      const timeline = getTimeline(key);
      const body = document.getElementById('timelineBody');
      body.innerHTML = '';

      // 按時間排序（舊的在上，新的在下）
      const sorted = [...timeline].sort((a, b) => a.timestamp - b.timestamp);

      sorted.forEach((item, displayIdx) => {
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.dataset.itemId = item.id; // 使用 data 屬性存儲 ID

        // 時間標籤（可點擊添加難度標籤）
        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-label';
        const h = String(item.hour).padStart(2, '0');
        const m = String(item.minute).padStart(2, '0');
        timeLabel.innerHTML = `${h}:${m}`;
        
        // 難度標籤顯示
        const tagDots = document.createElement('span');
        tagDots.className = 'tag-dots';
        ['yellow', 'orange', 'red'].forEach(color => {
          const dot = document.createElement('span');
          dot.className = 'tag-dot ' + (item.tag === color ? color : 'empty');
          dot.onclick = (e) => {
            e.stopPropagation();
            // 直接通過 ID 找到原始項目
            const originalItem = timeline.find(t => t.id === item.id);
            if (originalItem) {
              originalItem.tag = originalItem.tag === color ? null : color;
              saveState();
              renderTimeline();
              renderDailyAttrs();
            }
          };
          tagDots.appendChild(dot);
        });
        timeLabel.appendChild(tagDots);
        div.appendChild(timeLabel);

        // 內容
        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = item.text;
        div.appendChild(content);

        // 圖片
        if (item.images && item.images.length > 0) {
          const imagesDiv = document.createElement('div');
          imagesDiv.className = 'images';
          item.images.forEach(imgData => {
            const img = document.createElement('img');
            img.src = imgData;
            img.onclick = () => {
              document.getElementById('overlayImg').src = imgData;
              document.getElementById('imageOverlay').style.display = 'flex';
            };
            imagesDiv.appendChild(img);
          });
          div.appendChild(imagesDiv);
        }

        // 操作按鈕
        const actions = document.createElement('div');
        actions.className = 'item-actions';
        
        if (!item.isAuto) {
          // 非自動項目可編輯
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-ghost';
          editBtn.style.fontSize = '10px';
          editBtn.style.padding = '2px 6px';
          editBtn.textContent = '編輯';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            e.preventDefault();
            openEditTimeline(item);
          };
          actions.appendChild(editBtn);
        } else {
          // 自動項目顯示一個「自動」標記，不提供編輯
          const autoTag = document.createElement('span');
          autoTag.style.marginLeft = '6px';
          autoTag.style.fontSize = '9px';
          autoTag.style.color = '#a08060';
          autoTag.textContent = '⚡ 自動';
          actions.appendChild(autoTag);
        }
        
        // 只有手動發佈的項目可刪除
        if (!item.isAuto) {
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-danger';
          delBtn.style.fontSize = '10px';
          delBtn.style.padding = '2px 6px';
          delBtn.style.marginLeft = '4px';
          delBtn.textContent = '刪除';
          delBtn.onclick = (e) => {
            e.stopPropagation();
            e.preventDefault();
            const itemId = item.id;
            if (confirm('確定刪除此動態？')) {
              const idx = timeline.findIndex(t => t.id === itemId);
              if (idx !== -1) {
                timeline.splice(idx, 1);
                saveState();
                renderTimeline();
                renderDailyAttrs();
              }
            }
          };
          actions.appendChild(delBtn);
        }
        
        div.appendChild(actions);

        body.appendChild(div);
      });

      renderDailyAttrs();
      // 同步更新店鋪狀態中的動態軸
      renderShopTimeline();
    }

    let editingTimelineItem = null;

    function openEditTimeline(item) {
      editingTimelineItem = item;
      document.getElementById('timelinePostText').value = item.text;
      // 清空並加載圖片
      timelineImages = item.images ? [...item.images] : [];
      renderTimelineImagePreview();
    }

    function toggleInlineEdit(div, item, timeline) {
      // 檢查是否已有編輯表單
      let editForm = div.querySelector('.inline-edit-form');
      
      if (editForm) {
        // 已有表單，切換顯示狀態
        editForm.classList.toggle('active');
        return;
      }
      
      // 創建編輯表單
      editForm = document.createElement('div');
      editForm.className = 'inline-edit-form active';
      
      // 文本輸入
      const textarea = document.createElement('textarea');
      textarea.value = item.text;
      editForm.appendChild(textarea);
      
      // 圖片預覽區
      const imagesDiv = document.createElement('div');
      imagesDiv.className = 'inline-edit-images';
      let editImages = item.images ? [...item.images] : [];
      
      function renderEditImages() {
        imagesDiv.innerHTML = '';
        editImages.forEach((imgData, idx) => {
          const wrap = document.createElement('div');
          wrap.className = 'img-wrap';
          const img = document.createElement('img');
          img.src = imgData;
          wrap.appendChild(img);
          const delBtn = document.createElement('button');
          delBtn.className = 'img-del';
          delBtn.textContent = '✕';
          delBtn.onclick = (e) => {
            e.stopPropagation();
            editImages.splice(idx, 1);
            renderEditImages();
          };
          wrap.appendChild(delBtn);
          imagesDiv.appendChild(wrap);
        });
      }
      renderEditImages();
      editForm.appendChild(imagesDiv);
      
      // 添加圖片按鈕
      const addImgInput = document.createElement('input');
      addImgInput.type = 'file';
      addImgInput.accept = 'image/*';
      addImgInput.multiple = true;
      addImgInput.style.display = 'none';
      addImgInput.onchange = (e) => {
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            editImages.push(ev.target.result);
            renderEditImages();
          };
          reader.readAsDataURL(files[i]);
        }
        e.target.value = '';
      };
      editForm.appendChild(addImgInput);
      
      // 操作按鈕區
      const editActions = document.createElement('div');
      editActions.className = 'edit-actions';
      
      const addImgBtn = document.createElement('button');
      addImgBtn.className = 'btn btn-ghost';
      addImgBtn.style.fontSize = '10px';
      addImgBtn.style.padding = '2px 6px';
      addImgBtn.textContent = '📷 添加圖片';
      addImgBtn.onclick = (e) => {
        e.stopPropagation();
        addImgInput.click();
      };
      editActions.appendChild(addImgBtn);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-ghost';
      cancelBtn.style.fontSize = '10px';
      cancelBtn.style.padding = '2px 6px';
      cancelBtn.textContent = '取消';
      cancelBtn.onclick = (e) => {
        e.stopPropagation();
        editForm.classList.remove('active');
      };
      editActions.appendChild(cancelBtn);
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-primary';
      saveBtn.style.fontSize = '10px';
      saveBtn.style.padding = '2px 6px';
      saveBtn.textContent = '保存';
      saveBtn.onclick = (e) => {
        e.stopPropagation();
        // 更新原始項目
        const originalItem = timeline.find(t => t.id === item.id);
        if (originalItem) {
          originalItem.text = textarea.value;
          originalItem.images = [...editImages];
          saveState();
          renderTimeline();
        }
      };
      editActions.appendChild(saveBtn);
      
      editForm.appendChild(editActions);
      div.appendChild(editForm);
    }

    function renderTimelineImagePreview() {
      const preview = document.getElementById('timelineImagePreview');
      preview.innerHTML = '';
      timelineImages.forEach((imgData, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'img-wrap';
        const img = document.createElement('img');
        img.src = imgData;
        img.onclick = () => {
          document.getElementById('overlayImg').src = imgData;
          document.getElementById('imageOverlay').style.display = 'flex';
        };
        wrap.appendChild(img);
        const delBtn = document.createElement('button');
        delBtn.className = 'img-del';
        delBtn.textContent = '✕';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          timelineImages.splice(idx, 1);
          renderTimelineImagePreview();
        };
        wrap.appendChild(delBtn);
        preview.appendChild(wrap);
      });
    }

    // ===== 記事本 功能 =====
    function renderNotepad() {
      const key = state.selectedDateKey;
      const content = getNotepad(key);
      document.getElementById('notepadContent').innerHTML = content;
    }

    function saveNotepad() {
      const key = state.selectedDateKey;
      state.notepad[key] = document.getElementById('notepadContent').innerHTML;
      saveState();
      renderDailyAttrs(); // 更新魅力計算
      renderShopStatus();
    }

    function execNotepadCommand(command, value = null) {
      document.execCommand(command, false, value);
      document.getElementById('notepadContent').focus();
    }

    function insertNotepadTag(color) {
      // Insert tag followed by a zero-width space outside the span to prevent text coloring
      const tagHtml = `<span class="tag-inline" data-tag="${color}" style="background:${tagColors[color]};"></span>&#8203;`;
      document.execCommand('insertHTML', false, tagHtml);
      // Move cursor after the zero-width space
      const sel = window.getSelection();
      if (sel.rangeCount) {
        const range = sel.getRangeAt(0);
        range.collapse(false);
      }
      // Focus the active notepad
      const shopNote = document.getElementById('shopNotepadContent');
      const modalNote = document.getElementById('notepadContent');
      if (document.activeElement === modalNote) modalNote.focus();
      else if (shopNote) shopNote.focus();
    }

    // ===== 獎杯 =====
    function isTrophyUnlocked(t) {
      if (t.defaultUnlocked) return true;
      if (!t.conditions || !t.conditions.length) return false;
      return t.conditions.every(c => state.trophyConditions[c]);
    }

    function renderTrophies() {
      const wrap = document.getElementById('trophyList');
      wrap.innerHTML = '';
      trophyData.forEach(t => {
        const unlocked = isTrophyUnlocked(t);
        const card = document.createElement('div');
        card.className = 'trophy-card' + (unlocked ? ' unlocked' : '');

        const header = document.createElement('div');
        header.className = 'trophy-header';
        const icon = document.createElement('span');
        icon.className = 'trophy-icon';
        icon.textContent = '🏆';
        icon.style.opacity = unlocked ? '1' : '0.3';
        header.appendChild(icon);
        const info = document.createElement('div');
        const name = document.createElement('span');
        name.className = 'trophy-name';
        name.style.color = unlocked ? '#8b6914' : '#999';
        name.textContent = t.name;
        info.appendChild(name);
        const date = document.createElement('div');
        date.className = 'trophy-date';
        date.textContent = t.date;
        info.appendChild(date);
        header.appendChild(info);
        card.appendChild(header);

        if (t.conditions && t.conditions.length > 0) {
          const condDiv = document.createElement('div');
          condDiv.className = 'trophy-conditions';
          t.conditions.forEach(c => {
            const label = document.createElement('label');
            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.checked = !!state.trophyConditions[c];
            chk.onchange = () => {
              const wasChecked = state.trophyConditions[c];
              state.trophyConditions[c] = chk.checked;
              saveState();
              
              // 如果是新勾选（达成），添加到动态轴
              if (chk.checked && !wasChecked) {
                const timeline = getTimeline(state.selectedDateKey);
                const now = new Date();
                timeline.push({
                  id: generateId(),
                  text: `🏆 達成徽章條件：${c}`,
                  images: [],
                  timestamp: now.getTime(),
                  hour: now.getHours(),
                  minute: now.getMinutes(),
                  tag: null,
                  isAuto: true,
                  autoData: { module: 'trophy', condition: c }
                });
                saveState();
                renderTimeline();
              }
              
              renderTrophies();
            };
            label.appendChild(chk);
            const txt = document.createElement('span');
            txt.textContent = c;
            label.appendChild(txt);
            condDiv.appendChild(label);
          });
          card.appendChild(condDiv);
        }

        if (t.defaultUnlocked) {
          const def = document.createElement('div');
          def.style.fontSize = '10px';
          def.style.color = '#4a7c59';
          def.style.marginLeft = '26px';
          def.textContent = '✓ 默認獲得';
          card.appendChild(def);
        }

        wrap.appendChild(card);
      });
    }

    // ===== 轉盤 =====
    function unlockedCharacters() {
      return characters.filter(c => !c.unlockCondition || isTrophyUnlocked(trophyData.find(t => t.name === c.unlockCondition)));
    }

    function spinnerAvailable(now) {
      const h = now.getHours();
      const okTime = (h >= 22 || h < 1);
      const key = state.selectedDateKey;
      return okTime && calcElegance(key) >= 80 && calcCharm(key) >= 80;
    }

    let spinnerRotation = 0;
    let spinnerSpinning = false;

    function renderSpinnerModal() {
      const cont = document.getElementById('spinnerContent');
      cont.innerHTML = '';
      const now = new Date();

      if (!spinnerAvailable(now)) {
        const elegance = calcElegance(state.selectedDateKey);
        const charm = calcCharm(state.selectedDateKey);
        cont.innerHTML = `
          <div class="spinner-locked">
            <p>🔒 轉盤未解鎖</p>
            <p style="font-size:11px;margin-top:8px;">解鎖條件：</p>
            <p style="font-size:10px;">• 時間：22:00～01:00 ${(now.getHours() >= 22 || now.getHours() < 1) ? '✓' : '✗'}</p>
            <p style="font-size:10px;">• 氣質 ≥ 80（當前：${elegance}）${elegance >= 80 ? '✓' : '✗'}</p>
            <p style="font-size:10px;">• 魅力 ≥ 80（當前：${charm}）${charm >= 80 ? '✓' : '✗'}</p>
          </div>
        `;
        return;
      }

      const chars = unlockedCharacters();
      if (!chars.length) {
        cont.innerHTML = '<div class="spinner-locked">暫無解鎖角色</div>';
        return;
      }

      // 轉盤
      const wheel = document.createElement('div');
      wheel.className = 'spinner-wheel';
      const pointer = document.createElement('div');
      pointer.className = 'spinner-pointer';
      wheel.appendChild(pointer);
      const circle = document.createElement('div');
      circle.className = 'spinner-circle';
      circle.id = 'spinnerCircle';
      circle.style.background = 'conic-gradient(' + chars.map((c, i) => {
        const from = (i / chars.length) * 100;
        const to = ((i + 1) / chars.length) * 100;
        const col = i % 2 === 0 ? '#f8f4e8' : '#efe8d8';
        return `${col} ${from}% ${to}%`;
      }).join(',') + ')';
      circle.style.transform = `rotate(${spinnerRotation}deg)`;

      chars.forEach((c, i) => {
        const sliceAngle = 360 / chars.length;
        const angle = (i + 0.5) * sliceAngle;
        const r = 75;
        const rad = (angle - 90) * Math.PI / 180;
        const x = Math.cos(rad) * r;
        const y = Math.sin(rad) * r;
        const avatar = document.createElement('div');
        avatar.className = 'spinner-avatar';
        avatar.textContent = c.avatar;
        avatar.style.left = `calc(50% + ${x}px)`;
        avatar.style.top = `calc(50% + ${y}px)`;
        avatar.style.transform = 'translate(-50%, -50%)';
        circle.appendChild(avatar);
      });
      wheel.appendChild(circle);
      cont.appendChild(wheel);

      const result = document.createElement('div');
      result.className = 'spinner-result';
      result.id = 'spinnerResult';
      cont.appendChild(result);

      const btn = document.createElement('button');
      btn.className = 'btn btn-primary';
      btn.style.padding = '8px 28px';
      btn.textContent = '開始轉動';
      btn.onclick = () => {
        if (spinnerSpinning || !chars.length) return;
        spinnerSpinning = true;
        btn.disabled = true;
        btn.textContent = '轉動中...';

        const circleEl = document.getElementById('spinnerCircle');
        const sliceAngle = 360 / chars.length;
        const chosenIndex = Math.floor(Math.random() * chars.length);
        const angleCenter = chosenIndex * sliceAngle + sliceAngle / 2;
        const desiredAngle = (360 - angleCenter) % 360;
        const base = ((spinnerRotation % 360) + 360) % 360;
        const offset = (desiredAngle - base + 360) % 360;
        const extraSpins = 5 + Math.floor(Math.random() * 3);
        spinnerRotation = spinnerRotation + extraSpins * 360 + offset;

        circleEl.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
        circleEl.style.transform = `rotate(${spinnerRotation}deg)`;

        setTimeout(() => {
          spinnerSpinning = false;
          btn.disabled = false;
          btn.textContent = '開始轉動';
          const selected = chars[chosenIndex];
          document.getElementById('spinnerResult').innerHTML = `
            <div style="background:linear-gradient(135deg, rgba(212,175,55,0.1), rgba(255,255,255,0.8));border-radius:8px;padding:12px;">
              <div style="font-size:15px;color:#8b6914;font-weight:500;">${selected.name}</div>
              <div style="font-size:10px;color:#a08060;">${selected.title}</div>
              <div style="font-size:11px;color:#5c4d3d;margin-top:6px;font-style:italic;">「今夜，與${selected.name}共度...」</div>
            </div>
          `;
        }, 4000);
      };
      cont.appendChild(btn);
    }

    // ===== 日曆 =====
    function initCalendar() {
      const yearSel = document.getElementById('calYear');
      const monthSel = document.getElementById('calMonth');
      const weekRow = document.getElementById('calWeekRow');
      const daysEl = document.getElementById('calDays');

      yearSel.innerHTML = '';
      for (let y = 2024; y <= 2030; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y + '年';
        yearSel.appendChild(opt);
      }
      monthSel.innerHTML = '';
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m + '月';
        monthSel.appendChild(opt);
      }

      const now = dateFromKey(state.selectedDateKey);
      yearSel.value = now.getFullYear();
      monthSel.value = now.getMonth() + 1;

      weekRow.innerHTML = '';
      ['日','一','二','三','四','五','六'].forEach(d => {
        const div = document.createElement('div');
        div.className = 'calendar-weekday';
        div.textContent = d;
        weekRow.appendChild(div);
      });

  const renderDays = () => {
        const y = Number(yearSel.value);
        const m = Number(monthSel.value) - 1;
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const todayKeyStr = todayKey();
        
        // 獲取月經相關數據
        const periodDates = getPeriodDates();
        const prediction = getPeriodPrediction();

        daysEl.innerHTML = '';
        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement('div');
          daysEl.appendChild(empty);
        }
        for (let d = 1; d <= daysInMonth; d++) {
          const btn = document.createElement('button');
          btn.className = 'calendar-cell';
          const key = dateKeyFromDate(new Date(y, m, d));
          if (key === todayKeyStr) btn.classList.add('today');
          if (key === state.selectedDateKey) btn.classList.add('selected');
          // 有數據的日期標記
          if (state.timeline[key] || state.notepad[key] || state.life.daily[key]) {
            btn.classList.add('has-data');
          }
          // 月經日期標記
          if (periodDates.includes(key)) {
            btn.classList.add('period-day');
          }
          // 預測月經日期標記（前後2天）
          if (prediction) {
            const predDate = dateFromKey(prediction);
            const cellDate = new Date(y, m, d);
            const diff = Math.abs((cellDate - predDate) / (1000 * 60 * 60 * 24));
            if (diff <= 2 && !periodDates.includes(key)) {
              btn.classList.add('period-predict');
            }
          }
          
          btn.textContent = d;
          btn.onclick = () => {
            state.selectedDateKey = key;
            saveState();
            closeModal('dateModalOverlay');
            renderAll();
          };
          daysEl.appendChild(btn);
        }
      };

      renderDays();
      yearSel.onchange = renderDays;
      monthSel.onchange = renderDays;

      document.getElementById('calPrevMonth').onclick = () => {
        let y = Number(yearSel.value);
        let m = Number(monthSel.value) - 1;
        m--;
        if (m < 0) { m = 11; y--; }
        yearSel.value = y;
        monthSel.value = m + 1;
        renderDays();
      };
      document.getElementById('calNextMonth').onclick = () => {
        let y = Number(yearSel.value);
        let m = Number(monthSel.value) - 1;
        m++;
        if (m > 11) { m = 0; y++; }
        yearSel.value = y;
        monthSel.value = m + 1;
        renderDays();
      };
    }

    // ===== Header 時鐘與年份 =====
    function renderHeader() {
      const now = new Date();
      document.getElementById('clock').textContent = formatTime(now);
      document.getElementById('dateText').textContent = formatDateFull(now);
      const gameInfo = getGameYear(now);
      document.getElementById('eraText').textContent = gameInfo.era;
      document.getElementById('eraDesc').textContent = historicalEvents[gameInfo.year] || '';
    }

    // ===== BE自動判定（每日21:00） =====
    let lastBECheckDate = '';
    function checkBEAutoUnlock() {
      const now = new Date();
      if (now.getHours() < 21) return; // 未到21:00
      const todayKey = dateKeyFromDate(now);
      if (lastBECheckDate === todayKey) return; // 今天已檢查過
      
      const charNames = Object.keys(romanceData);
      let anyChanged = false;
      
      charNames.forEach(charName => {
        const charData = romanceData[charName];
        if (!charData || !charData.stories) return;
        initRomanceState();
        const unlocked = state.romance[charName]?.unlocked || [];
        
        charData.stories.forEach((story, idx) => {
          // 只處理含BE條件的故事
          const hasBECond = (story.conditions || []).some(c => c.forBE);
          const isBEType = story.type === 'BE' || story.altType === 'BE';
          if (!hasBECond && !isBEType) return;
          
          // 檢查日期是否為今天
          if (story.date !== todayKey) return;
          
          // 檢查前置是否已解鎖（非BE）
          if (idx > 0) {
            const prev = charData.stories[idx - 1];
            const prevUnlocked = unlocked.some(id => id.startsWith(prev.id) && !id.includes('_be'));
            if (!prevUnlocked) return;
            if (unlocked.some(id => id.startsWith(prev.id) && id.includes('_be'))) return;
          }
          
          // 檢查此故事是否已解鎖
          const alreadyUnlocked = unlocked.some(uid => uid.startsWith(story.id + '_') || uid === story.id);
          if (alreadyUnlocked) return;
          
          // 檢查BE條件
          const beConds = (story.conditions || []).filter(c => c.forBE);
          const beAllMet = beConds.length > 0 && beConds.every(c => {
            try { return c.check(state, todayKey); } catch(e) { return false; }
          });
          
          if (beAllMet) {
            // BE條件滿足 → 自動解鎖BE
            const beId = story.type === 'BE' ? story.id + '_be' : 
                         (story.altType === 'BE' ? story.id + '_be' : 
                         (story.beName ? story.id + '_be' : null));
            if (beId && !unlocked.includes(beId)) {
              unlocked.push(beId);
              state.romance[charName].unlocked = unlocked;
              anyChanged = true;
              // 記錄到動態軸
              const tl = getTimeline(todayKey);
              tl.push({
                id: Date.now() + '_be_' + charName,
                hour: 21, minute: 0,
                text: `⚠ ${charName}・BE「${story.type === 'BE' ? story.name : (story.altType === 'BE' ? story.altName : story.beName)}」自動判定解鎖`,
                timestamp: Date.now(),
                isAuto: true
              });
            }
          } else {
            // BE條件未滿足 → 標記此故事BE已失效（記錄到state）
            if (!state.romance[charName].beExpired) state.romance[charName].beExpired = [];
            if (!state.romance[charName].beExpired.includes(story.id)) {
              state.romance[charName].beExpired.push(story.id);
              anyChanged = true;
            }
          }
        });
      });
      
      if (anyChanged) {
        saveState();
        renderAll();
      }
      lastBECheckDate = todayKey;
    }

    function renderDatePill() {
      const d = dateFromKey(state.selectedDateKey);
      document.getElementById('datePillText').textContent =
        d.toLocaleDateString('zh-TW', { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'short' });
    }

    // ===== 吳質助手彈窗 =====
    let lastWuZhiTime = 0;

    function maybeShowWuZhi(now) {
      const nowMs = now.getTime();
      if (nowMs - lastWuZhiTime < 120000) return;
      const h = now.getHours();
      let msg = '';
      if (h < 6) msg = '夜深了，主人該休息了。';
      else if (h < 9) msg = '早安！新的一天開始了。';
      else if (h < 12) msg = '上午是工作的黃金時段！';
      else if (h < 14) msg = '午間小憩。';
      else if (h < 18) msg = '下午時光，繼續努力！';
      else if (h < 21) msg = '傍晚了，今日進展如何？';
      else msg = '夜幕降臨。';
      document.getElementById('wuZhiMessage').textContent = msg;
      document.getElementById('wuZhiToast').style.display = 'block';
      lastWuZhiTime = nowMs;
      setTimeout(() => { document.getElementById('wuZhiToast').style.display = 'none'; }, 10000);
    }

    // ===== 角色問候彈窗 =====
    function showRandomCharacterGreeting(now) {
      const chars = unlockedCharacters();
      if (!chars.length) return;
      const char = chars[Math.floor(Math.random() * chars.length)];
      const h = now.getHours();
      const tod = h < 6 ? 'night' : h < 12 ? 'morning' : h < 18 ? 'afternoon' : h < 22 ? 'evening' : 'night';
      const msgs = (greetings[char.name] && greetings[char.name][tod]) || ['問候。'];
      const msg = msgs[Math.floor(Math.random() * msgs.length)];
      document.getElementById('charAvatar').textContent = char.avatar;
      document.getElementById('charName').textContent = char.name;
      document.getElementById('charTitle').textContent = char.title;
      document.getElementById('charGreeting').textContent = '「' + msg + '」';
      document.getElementById('charToast').style.display = 'block';
      setTimeout(() => { document.getElementById('charToast').style.display = 'none'; }, 10000);
    }

    // ===== Modal 控制 =====
    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
    }
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    // ===== 渲染全部 =====

    // === V5：店鋪狀態渲染 ===
    function renderShopStatus() {
      const key = state.selectedDateKey;
      
      // 渲染家務（與cleaningModal邏輯相同）
      const hw = getHousework(key);
      const rows = document.getElementById('shopCleaningRows');
      if (rows) {
        rows.innerHTML = '';
        houseworkItems.forEach(item => {
          const row = document.createElement('div');
          row.className = 'clean-row';
          const label = document.createElement('span');
          label.textContent = item.name;
          row.appendChild(label);
          const sel = document.createElement('select');
          sel.className = 'select';
          sel.style.width = 'auto';
          houseworkStates.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.value;
            opt.textContent = s.label + (s.deduction > 0 ? ` (-${s.deduction})` : '');
            sel.appendChild(opt);
          });
          sel.value = hw[item.id] || 'reasonable';
          sel.onchange = () => {
            hw[item.id] = sel.value;
            saveState();
            renderDailyAttrs();
            renderShopStatus();
          };
          row.appendChild(sel);
          rows.appendChild(row);
        });
      }
      
      // 渲染記事本
      const notepadEl = document.getElementById('shopNotepadContent');
      if (notepadEl && document.activeElement !== notepadEl) {
        const content = getNotepad(key);
        notepadEl.innerHTML = content;
      }
      
      // 渲染動態軸（簡化版，同timelineBody）
      renderShopTimeline();
      
      // 渲染魅力氣質
      const elegance = calcElegance(key);
      const charm = calcCharm(key);
      const elegEl = document.getElementById('shopEleganceDisplay');
      if (elegEl) {
        elegEl.textContent = elegance;
        elegEl.style.color = elegance >= 80 ? '#4a7c59' : elegance >= 50 ? '#c08020' : '#c04040';
      }
      
      // 氣質公式
      let mustMissCount = 0, canMissCount = 0;
      houseworkItems.forEach(item => {
        const val = hw[item.id] || 'reasonable';
        const stateObj = houseworkStates.find(s => s.value === val);
        if (stateObj && stateObj.deduction === 20) mustMissCount++;
        if (stateObj && stateObj.deduction === 5) canMissCount++;
      });
      const elegFormulaEl = document.getElementById('shopEleganceFormula');
      if (elegFormulaEl) {
        elegFormulaEl.innerHTML = `100 − 必做未做(${mustMissCount})×20 − 可做未做(${canMissCount})×5 = <strong>${elegance}</strong>`;
      }
      
      const charmEl = document.getElementById('shopCharmDisplay');
      if (charmEl) {
        charmEl.textContent = charm;
        charmEl.style.color = charm >= 80 ? '#4a7c59' : charm >= 50 ? '#c08020' : '#c04040';
      }
      
      // 魅力公式
      const timeline = getTimeline(key);
      const notepadHtml = getNotepad(key);
      const weights = { red: 5, orange: 3, yellow: 1 };
      let execR = 0, execO = 0, execY = 0;
      timeline.forEach(t => {
        if (t.tag === 'red') execR++;
        else if (t.tag === 'orange') execO++;
        else if (t.tag === 'yellow') execY++;
      });
      let planR = 0, planO = 0, planY = 0;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = notepadHtml;
      tempDiv.querySelectorAll('span[data-tag]').forEach(span => {
        const tag = span.dataset.tag;
        if (tag === 'red') planR++;
        else if (tag === 'orange') planO++;
        else if (tag === 'yellow') planY++;
      });
      const formulaEl = document.getElementById('shopCharmFormula');
      if (formulaEl) {
        formulaEl.innerHTML =
          `執行：🔴${execR}×5 + 🟠${execO}×3 + 🟡${execY}×1 = ${execR*5 + execO*3 + execY*1}<br/>` +
          `計劃：🔴${planR}×5 + 🟠${planO}×3 + 🟡${planY}×1 = ${planR*5 + planO*3 + planY*1}<br/>` +
          `魅力 = ${execR*5 + execO*3 + execY*1} ÷ ${planR*5 + planO*3 + planY*1 || 1} × 100 = <strong>${charm}</strong>`;
      }
    }
    
    function renderShopTimeline() {
      // 重定向到今日動態彈窗（如果已打開）
      renderFeedTimeline();
    }

    // ===== 今日動態彈窗 =====
    let feedViewDateKey = null;
    
    function renderFeedTimeline(dateKeyOverride) {
      const body = document.getElementById('feedTimelineBody');
      if (!body) return;
      const key = dateKeyOverride || feedViewDateKey || state.selectedDateKey;
      feedViewDateKey = key;
      const timeline = getTimeline(key);
      body.innerHTML = '';
      
      // 更新日期標籤
      const labelEl = document.getElementById('feedDateLabel');
      if (labelEl) {
        const d = dateFromKey(key);
        labelEl.textContent = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${['日','一','二','三','四','五','六'][d.getDay()]}`;
      }
      const pickerEl = document.getElementById('feedDatePicker');
      if (pickerEl) pickerEl.value = key;
      
      const sorted = [...timeline].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      if (sorted.length === 0) {
        body.innerHTML = '<div style="text-align:center;color:#a08060;padding:30px;font-size:11px;">這天還沒有動態</div>';
        return;
      }
      
      sorted.forEach((item) => {
        const div = document.createElement('div');
        div.style.cssText = 'padding:8px 10px;margin-bottom:6px;background:rgba(255,255,255,0.6);border-radius:6px;border:1px solid rgba(178,144,90,0.12);font-size:11px;';
        
        const timeStr = item.hour !== undefined ? `${String(item.hour).padStart(2,'0')}:${String(item.minute).padStart(2,'0')}` : '';
        
        const timeRow = document.createElement('div');
        timeRow.style.cssText = 'display:flex;align-items:center;gap:4px;margin-bottom:3px;';
        timeRow.innerHTML = `<span style="color:#a08060;font-size:10px;">${timeStr}</span>`;
        
        // 三色標籤點
        const tagDots = document.createElement('span');
        tagDots.style.cssText = 'display:flex;gap:3px;margin-left:8px;';
        ['yellow', 'orange', 'red'].forEach(color => {
          const dot = document.createElement('span');
          dot.className = 'tag-dot ' + (item.tag === color ? color : 'empty');
          dot.onclick = (e) => {
            e.stopPropagation();
            const tl = getTimeline(key);
            const orig = tl.find(t => t.id === item.id);
            if (orig) { orig.tag = orig.tag === color ? null : color; saveState(); renderFeedTimeline(key); renderTimeline(); renderDailyAttrs(); renderShopStatus(); }
          };
          tagDots.appendChild(dot);
        });
        timeRow.appendChild(tagDots);
        
        // 右側按鈕
        const btnArea = document.createElement('span');
        btnArea.style.cssText = 'margin-left:auto;display:flex;gap:6px;align-items:center;';
        
        if (item.isAuto) {
          btnArea.innerHTML = '<span style="font-size:9px;color:#a08060;">⚡ 自動</span>';
        } else {
          // 編輯按鈕
          const editBtn = document.createElement('button');
          editBtn.style.cssText = 'border:none;background:none;cursor:pointer;color:#8b6914;font-size:12px;padding:0;';
          editBtn.textContent = '✎';
          editBtn.title = '編輯';
          editBtn.onclick = (e) => { e.stopPropagation(); startFeedInlineEdit(div, item, key); };
          btnArea.appendChild(editBtn);
          
          // 刪除按鈕
          const delBtn = document.createElement('button');
          delBtn.style.cssText = 'border:none;background:none;cursor:pointer;color:#c04040;font-size:10px;padding:0;';
          delBtn.textContent = '✕';
          delBtn.onclick = () => {
            const tl = getTimeline(key);
            const idx = tl.findIndex(t => t.id === item.id);
            if (idx >= 0) { tl.splice(idx, 1); saveState(); renderFeedTimeline(key); renderTimeline(); renderDailyAttrs(); renderShopStatus(); }
          };
          btnArea.appendChild(delBtn);
        }
        timeRow.appendChild(btnArea);
        div.appendChild(timeRow);
        
        // 內容
        const contentEl = document.createElement('div');
        contentEl.style.cssText = 'font-size:12px;color:#5c4d3d;line-height:1.5;white-space:pre-wrap;';
        contentEl.textContent = item.text;
        div.appendChild(contentEl);
        
        // 圖片
        if (item.images && item.images.length > 0) {
          const imgDiv = document.createElement('div');
          imgDiv.style.cssText = 'margin-top:4px;display:flex;gap:4px;flex-wrap:wrap;';
          item.images.forEach(img => {
            const imgEl = document.createElement('img');
            imgEl.src = img;
            imgEl.style.cssText = 'max-width:80px;max-height:80px;border-radius:4px;object-fit:cover;cursor:zoom-in;';
            imgEl.onclick = () => { document.getElementById('overlayImg').src = img; document.getElementById('imageOverlay').style.display = 'flex'; };
            imgDiv.appendChild(imgEl);
          });
          div.appendChild(imgDiv);
        }
        
        body.appendChild(div);
      });
    }
    
    function startFeedInlineEdit(container, item, dateKey) {
      container.innerHTML = '';
      container.style.background = 'rgba(255,250,230,0.9)';
      const textarea = document.createElement('textarea');
      textarea.value = item.text;
      textarea.style.cssText = 'width:100%;min-height:60px;font-size:12px;line-height:1.5;padding:6px;border:1px solid #d4af37;border-radius:4px;box-sizing:border-box;resize:vertical;';
      container.appendChild(textarea);

      // 圖片編輯區
      let editImages = item.images ? [...item.images] : [];
      const imagesDiv = document.createElement('div');
      imagesDiv.className = 'inline-edit-images';
      imagesDiv.style.cssText = 'display:flex;gap:4px;flex-wrap:wrap;margin-top:6px;';
      function renderFeedEditImages() {
        imagesDiv.innerHTML = '';
        editImages.forEach((imgData, idx) => {
          const wrap = document.createElement('div');
          wrap.style.position = 'relative';
          wrap.style.display = 'inline-block';
          const img = document.createElement('img');
          img.src = imgData;
          img.style.cssText = 'width:40px;height:40px;object-fit:cover;border-radius:4px;';
          wrap.appendChild(img);
          const delBtn = document.createElement('button');
          delBtn.style.cssText = 'position:absolute;top:-4px;right:-4px;width:14px;height:14px;border-radius:50%;background:#c04040;color:#fff;font-size:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;';
          delBtn.textContent = '✕';
          delBtn.onclick = (e) => { e.stopPropagation(); editImages.splice(idx, 1); renderFeedEditImages(); };
          wrap.appendChild(delBtn);
          imagesDiv.appendChild(wrap);
        });
      }
      renderFeedEditImages();
      container.appendChild(imagesDiv);

      // 添加圖片的隱藏input
      const addImgInput = document.createElement('input');
      addImgInput.type = 'file';
      addImgInput.accept = 'image/*';
      addImgInput.multiple = true;
      addImgInput.style.display = 'none';
      addImgInput.onchange = (e) => {
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          const reader = new FileReader();
          reader.onload = (ev) => { editImages.push(ev.target.result); renderFeedEditImages(); };
          reader.readAsDataURL(files[i]);
        }
        e.target.value = '';
      };
      container.appendChild(addImgInput);

      const btnRow = document.createElement('div');
      btnRow.style.cssText = 'display:flex;gap:6px;margin-top:4px;justify-content:flex-end;align-items:center;';

      const addImgBtn = document.createElement('button');
      addImgBtn.className = 'btn btn-ghost';
      addImgBtn.style.cssText = 'font-size:10px;padding:2px 6px;margin-right:auto;';
      addImgBtn.textContent = '📷 添加圖片';
      addImgBtn.onclick = (e) => { e.stopPropagation(); addImgInput.click(); };
      btnRow.appendChild(addImgBtn);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-ghost';
      cancelBtn.style.cssText = 'font-size:10px;padding:3px 12px;';
      cancelBtn.textContent = '取消';
      cancelBtn.onclick = () => renderFeedTimeline(dateKey);
      btnRow.appendChild(cancelBtn);

      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn btn-primary';
      saveBtn.style.cssText = 'font-size:10px;padding:3px 12px;';
      saveBtn.textContent = '保存';
      saveBtn.onclick = () => {
        const tl = getTimeline(dateKey);
        const orig = tl.find(t => t.id === item.id);
        if (orig) { orig.text = textarea.value; orig.images = [...editImages]; saveState(); }
        renderFeedTimeline(dateKey);
        renderTimeline();
      };
      btnRow.appendChild(saveBtn);
      container.appendChild(btnRow);
      textarea.focus();
    }


    function renderAll() {
      renderDatePill();
      renderHeader();
      renderShopStatus();
      renderJobSection();
      renderThesisSection();
      renderMoneySection();
      renderLifeSection();
      renderFictionSection();
      renderReadSection();
      renderTimeline();
      renderNotepad();
      renderDailyAttrs();
      showPeriodReminder();
      renderAllTrends();
    }

    // ===== 趨勢圖系統 =====
    function drawTrendChart(canvasId, summaryId, data, labels) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      const W = rect.width, H = rect.height;
      ctx.clearRect(0, 0, W, H);
      
      if (data.length === 0) return;
      
      const max = Math.max(...data, 1);
      const min = Math.min(...data, 0);
      const range = max - min || 1;
      const padL = 30, padR = 10, padT = 10, padB = 20;
      const chartW = W - padL - padR;
      const chartH = H - padT - padB;
      
      // 網格
      ctx.strokeStyle = 'rgba(178,144,90,0.12)';
      ctx.lineWidth = 0.5;
      for (let i = 0; i <= 4; i++) {
        const y = padT + (chartH / 4) * i;
        ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
        ctx.fillStyle = '#a08060';
        ctx.font = '9px sans-serif';
        ctx.textAlign = 'right';
        const val = max - (range / 4) * i;
        ctx.fillText(val % 1 === 0 ? val.toString() : val.toFixed(1), padL - 3, y + 3);
      }
      
      // 折線
      ctx.beginPath();
      ctx.strokeStyle = '#8b6914';
      ctx.lineWidth = 1.5;
      const points = [];
      data.forEach((v, i) => {
        const x = padL + (chartW / Math.max(data.length - 1, 1)) * i;
        const y = padT + chartH - ((v - min) / range) * chartH;
        points.push({ x, y, v });
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // 填充
      ctx.lineTo(points[points.length - 1].x, padT + chartH);
      ctx.lineTo(points[0].x, padT + chartH);
      ctx.closePath();
      ctx.fillStyle = 'rgba(139,105,20,0.08)';
      ctx.fill();
      
      // 數據點
      points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2.5, 0, Math.PI * 2);
        ctx.fillStyle = '#8b6914';
        ctx.fill();
      });
      
      // X軸標籤（每隔幾個顯示）
      const step = Math.max(1, Math.floor(labels.length / 7));
      ctx.fillStyle = '#a08060';
      ctx.font = '8px sans-serif';
      ctx.textAlign = 'center';
      labels.forEach((lbl, i) => {
        if (i % step === 0 || i === labels.length - 1) {
          const x = padL + (chartW / Math.max(data.length - 1, 1)) * i;
          ctx.fillText(lbl, x, H - 3);
        }
      });
      
      // 統計
      const total = data.reduce((a, b) => a + b, 0);
      const avg = data.length ? (total / data.length) : 0;
      const sumEl = document.getElementById(summaryId);
      if (sumEl) sumEl.textContent = `合計：${total % 1 === 0 ? total : total.toFixed(1)} ｜ 均值：${avg.toFixed(1)}`;
    }
    
    function getTrendData(module, metric, fromKey, toKey) {
      const fromDate = dateFromKey(fromKey);
      const toDate = dateFromKey(toKey);
      const data = [], labels = [];
      let d = new Date(fromDate);
      while (d <= toDate) {
        const k = dateKeyFromDate(d);
        labels.push(`${d.getMonth()+1}/${d.getDate()}`);
        data.push(getTrendDayValue(module, metric, k));
        d = addDays(d, 1);
      }
      return { data, labels, dateKeys: generateDateKeys(fromKey, toKey) };
    }

    function generateDateKeys(fromKey, toKey) {
      const keys = [];
      let d = dateFromKey(fromKey);
      const end = dateFromKey(toKey);
      while (d <= end) {
        keys.push(dateKeyFromDate(d));
        d = addDays(d, 1);
      }
      return keys;
    }

    function getTrendDayValue(module, metric, k) {
      try {
        if (module === 'life') {
          const ld = getLifeDaily(k);
          if (metric === 'score') return computeLifeDaily(k);
          if (metric === 'water') return getTotalWater(k);
          if (metric === 'nutrition') return getTotalNutrition(k);
          if (metric === 'selfDev') return getTotalSelfDev(k);
          if (metric === 'fun') return getTotalFun(k);
          if (metric === 'outing') return getTotalOuting(k);
          if (metric === 'empty') return getTotalEmpty(k);
          if (metric === 'streak') return computeLifeStreak(k);
          if (metric === 'weight') return ld.weight || 0;
          if (metric === 'bowel') return ld.bowel >= 1 ? 1 : 0;
          if (metric === 'sleepTime') return ld.sleepTime || 0;
          if (metric === 'wakeTime') return ld.wakeTime || 0;
          if (metric === 'grace') {
            const s = computeLifeStreak(k);
            return s < 15 ? 0.5 : s <= 60 ? 1 : 2;
          }
        } else if (module === 'money') {
          const entries = getMoneyEntries(k);
          if (metric === 'score') {
            const r = computeMoneyDayScore(k);
            return r.hasData ? r.base : 0;
          }
          if (metric === 'streak') return computeMoneyStreakUntil(k);
          if (metric === 'freedom') {
            const s = computeMoneyStreakUntil(k);
            return s < 15 ? 0.5 : s <= 60 ? 1 : 2;
          }
          // Wallet metrics
          if (metric.startsWith('wallet_')) {
            const walletType = metric.replace('wallet_', '');
            return entries.filter(e => e.wallet === walletType).reduce((s,e) => s + Math.abs(Number(e.amount)||0), 0);
          }
          // Sub-category metrics
          if (metric.startsWith('dailyOut_')) {
            const sub = metric.replace('dailyOut_', '');
            if (sub === 'total') return entries.filter(e => e.main === 'dailyOut').reduce((s,e) => s + (Number(e.amount)||0), 0);
            return entries.filter(e => e.main === 'dailyOut' && e.sub === sub).reduce((s,e) => s + (Number(e.amount)||0), 0);
          }
          if (metric === 'basicOut_total') return entries.filter(e => e.main === 'basicOut').reduce((s,e) => s + (Number(e.amount)||0), 0);
          if (metric === 'specialOut_total') return entries.filter(e => e.main === 'specialOut').reduce((s,e) => s + (Number(e.amount)||0), 0);
          if (metric === 'income_total') return entries.filter(e => e.main === 'income').reduce((s,e) => s + (Number(e.amount)||0), 0);
        } else if (module === 'job') {
          const entries = getJobEntries(k);
          if (metric === 'score') return computeJobForDay(k).total;
          if (metric === 'survey') return entries.filter(e=>e.type==='research').reduce((s,e)=>s+(Number(e.amount)||0),0);
          if (metric === 'interview') return entries.filter(e=>e.type==='prep').reduce((s,e)=>s+(Number(e.amount)||0),0);
          if (metric === 'writing') return entries.filter(e=>e.type==='writing').reduce((s,e)=>s+(Number(e.amount)||0),0);
          if (metric === 'prep') return entries.filter(e=>e.type==='general').reduce((s,e)=>s+(Number(e.amount)||0),0);
          if (metric === 'auspicious') return computeJobAuspicious(k);
          if (metric === 'fate') return computeJobFate(computeJobAuspicious(k));
        } else if (module === 'read') {
          const entries = getReadEntries(k);
          if (metric === 'score') return computeReadDayScore(k).base;
          if (metric === 'streak') return computeReadStreak(k);
          if (metric === 'different') {
            const s = computeReadStreak(k);
            return s < 15 ? 0.5 : s <= 60 ? 1 : 2;
          }
          if (metric === 'philo') return entries.filter(e=>e.type==='philo').reduce((s,e)=>s+(Number(e.pages)||0),0);
          if (metric === 'academic') return entries.filter(e=>e.type==='academic').reduce((s,e)=>s+(Number(e.pages)||0),0);
          if (metric === 'nonfic') return entries.filter(e=>e.type==='nonfic').reduce((s,e)=>s+(Number(e.pages)||0),0);
        } else if (module === 'thesis') {
          const entries = getThesisEntries(k);
          if (metric === 'score') return computeThesisDayScore(k).base;
          if (metric === 'words') return entries.reduce((s,e)=>s+(Number(e.words)||0),0);
          if (metric === 'rumor') return computeThesisRumor(k);
          if (metric === 'leling') {
            const r = computeThesisRumor(k);
            return r >= 3 ? 2 : r < 1 ? 0.5 : 1;
          }
        } else if (module === 'fiction') {
          const entries = getFictionEntries(k);
          if (metric === 'score') return computeFictionDayScore(k).base;
          if (metric === 'words') return entries.reduce((s,e)=>s+(Number(e.words)||0),0);
          if (metric === 'tale') return computeFictionTale(k);
          if (metric === 'spirit') {
            const t = computeFictionTale(k);
            return t >= 3 ? 4 : t < 1 ? 1 : 2;
          }
        }
        return 0;
      } catch(e) { return 0; }
    }

    // Group daily data into weekly or monthly buckets (sum)
    function groupTrendData(data, labels, dateKeys, groupBy) {
      if (groupBy === 'day') return { data, labels };
      
      const buckets = [];
      let currentBucket = null;
      
      for (let i = 0; i < dateKeys.length; i++) {
        const d = dateFromKey(dateKeys[i]);
        let bucketKey;
        if (groupBy === 'week') {
          // ISO week: Monday-based
          const mon = new Date(d);
          const dow = mon.getDay() || 7;
          mon.setDate(mon.getDate() - (dow - 1));
          bucketKey = dateKeyFromDate(mon);
        } else {
          bucketKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        }
        
        if (!currentBucket || currentBucket.key !== bucketKey) {
          currentBucket = { key: bucketKey, sum: 0, count: 0, label: '' };
          if (groupBy === 'week') {
            const mon = dateFromKey(bucketKey);
            currentBucket.label = `${mon.getMonth()+1}/${mon.getDate()}週`;
          } else {
            currentBucket.label = `${d.getMonth()+1}月`;
          }
          buckets.push(currentBucket);
        }
        currentBucket.sum += data[i];
        currentBucket.count++;
      }
      
      return {
        data: buckets.map(b => Math.round(b.sum * 100) / 100),
        labels: buckets.map(b => b.label)
      };
    }
    
    // 輔助：取得各模組單日分數（安全封裝）
    function computeLifeDaily(k) {
      try {
        const d = getLifeDaily(k);
        const water = getTotalWater(k);
        const nut = getTotalNutrition(k);
        const sd = getTotalSelfDev(k);
        const fun = getTotalFun(k);
        const out = getTotalOuting(k);
        const emp = getTotalEmpty(k);
        const skin = d.skin || 0;
        const sl = d.sleepTime; const wk = d.wakeTime;
        let sleepScore = 0;
        if (sl !== null && sl !== undefined && wk !== null && wk !== undefined) {
          let dur = wk - sl; if (dur < 0) dur += 24;
          sleepScore = dur >= 7 && dur <= 9 ? 15 : dur >= 6 ? 10 : 5;
        }
        const bowelScore = d.bowel >= 1 ? 5 : 0;
        return Math.round(water * 0.01 + nut * 0.3 + sd * 5 + fun * 2 + out * 3 - emp * 5 + skin * 0.1 + sleepScore + bowelScore);
      } catch(e) { return 0; }
    }
    function computeLifeStreak(k) {
      let streak = 0;
      let checkDate = dateFromKey(k);
      while(true) {
        checkDate = addDays(checkDate, -1);
        const ck = dateKeyFromDate(checkDate);
        if (computeLifeDaily(ck) >= 25) streak++;
        else break;
        if (streak > 365) break;
      }
      return streak;
    }
    function computeMoneyDaily(k) {
      try { const r = computeMoneyDayScore(k); return r.hasData ? r.base : 0; } catch(e) { return 0; }
    }
    function computeMoneyStreak(k) {
      try { return computeMoneyStreakUntil(k); } catch(e) { return 0; }
    }
    function computeJobDaily(k) {
      try { return computeJobForDay(k).total; } catch(e) { return 0; }
    }
    function getJobItemCount(k, item) {
      try {
        const entries = getJobEntries(k);
        const typeMap = { survey: 'research', interview: 'prep', writing: 'writing', prep: 'general' };
        const t = typeMap[item] || item;
        return entries.filter(e => e.type === t).reduce((s,e) => s + (Number(e.amount)||0), 0);
      } catch(e) { return 0; }
    }
    function computeJobAuspicious(k) {
      try {
        const d = dateFromKey(k);
        const dow = d.getDay() || 7;
        let count = 0;
        for (let i = 0; i < 7; i++) {
          const ck = dateKeyFromDate(addDays(d, -dow + 1 + i));
          if (computeJobDaily(ck) > 0) count++;
        }
        return count;
      } catch(e) { return 0; }
    }
    function computeReadDaily(k) {
      try {
        const entries = getReadEntries(k);
        return entries.reduce((s,e) => s + (Number(e.pages)||0), 0);
      } catch(e) { return 0; }
    }
    function computeReadStreak(k) {
      let streak = 0;
      let checkDate = dateFromKey(k);
      while(true) {
        checkDate = addDays(checkDate, -1);
        const ck = dateKeyFromDate(checkDate);
        if (computeReadDaily(ck) >= 20) streak++;
        else break;
        if (streak > 365) break;
      }
      return streak;
    }
    function computeThesisDaily(k) {
      try {
        const entries = getThesisEntries(k);
        return entries.reduce((s,e) => s + (Number(e.words)||0), 0);
      } catch(e) { return 0; }
    }
    function computeThesisRumor(k) {
      try {
        const d = dateFromKey(k);
        const dow = d.getDay() || 7;
        let count = 0;
        for (let i = 0; i < 7; i++) {
          const ck = dateKeyFromDate(addDays(d, -dow + 1 + i));
          if (computeThesisDaily(ck) > 0) count++;
        }
        return count;
      } catch(e) { return 0; }
    }
    function computeFictionDaily(k) {
      try {
        const entries = getFictionEntries(k);
        return entries.reduce((s,e) => s + (Number(e.words)||0), 0);
      } catch(e) { return 0; }
    }
    function computeFictionTale(k) {
      try {
        const d = dateFromKey(k);
        const dow = d.getDay() || 7;
        let count = 0;
        for (let i = 0; i < 7; i++) {
          const ck = dateKeyFromDate(addDays(d, -dow + 1 + i));
          if (computeFictionDaily(ck) > 0) count++;
        }
        return count;
      } catch(e) { return 0; }
    }
    
    function initTrendDateDefaults() {
      const today = dateFromKey(state.selectedDateKey);
      const sevenDaysAgo = addDays(today, -6);
      const toStr = dateKeyFromDate(today);
      const fromStr = dateKeyFromDate(sevenDaysAgo);
      ['life','money','job','read','thesis','fiction'].forEach(mod => {
        const fromEl = document.getElementById(mod + 'TrendFrom');
        const toEl = document.getElementById(mod + 'TrendTo');
        if (fromEl && !fromEl.value) fromEl.value = fromStr;
        if (toEl && !toEl.value) toEl.value = toStr;
      });
    }

    function renderAllTrends() {
      initTrendDateDefaults();
      const modules = [
        { id: 'life', select: 'lifeTrendSelect', from: 'lifeTrendFrom', to: 'lifeTrendTo', group: 'lifeTrendGroup', canvas: 'lifeTrendCanvas', summary: 'lifeTrendSummary' },
        { id: 'money', select: 'moneyTrendSelect', from: 'moneyTrendFrom', to: 'moneyTrendTo', group: 'moneyTrendGroup', canvas: 'moneyTrendCanvas', summary: 'moneyTrendSummary' },
        { id: 'job', select: 'jobTrendSelect', from: 'jobTrendFrom', to: 'jobTrendTo', group: 'jobTrendGroup', canvas: 'jobTrendCanvas', summary: 'jobTrendSummary' },
        { id: 'read', select: 'readTrendSelect', from: 'readTrendFrom', to: 'readTrendTo', group: 'readTrendGroup', canvas: 'readTrendCanvas', summary: 'readTrendSummary' },
        { id: 'thesis', select: 'thesisTrendSelect', from: 'thesisTrendFrom', to: 'thesisTrendTo', group: 'thesisTrendGroup', canvas: 'thesisTrendCanvas', summary: 'thesisTrendSummary' },
        { id: 'fiction', select: 'fictionTrendSelect', from: 'fictionTrendFrom', to: 'fictionTrendTo', group: 'fictionTrendGroup', canvas: 'fictionTrendCanvas', summary: 'fictionTrendSummary' },
      ];
      modules.forEach(m => {
        const selEl = document.getElementById(m.select);
        const fromEl = document.getElementById(m.from);
        const toEl = document.getElementById(m.to);
        const groupEl = document.getElementById(m.group);
        if (!selEl || !fromEl || !toEl) return;
        const metric = selEl.value;
        const fromKey = fromEl.value;
        const toKey = toEl.value;
        const groupBy = groupEl ? groupEl.value : 'day';
        if (!fromKey || !toKey || fromKey > toKey) return;
        
        const raw = getTrendData(m.id, metric, fromKey, toKey);
        const grouped = groupTrendData(raw.data, raw.labels, generateDateKeys(fromKey, toKey), groupBy);
        
        // Limit to 50 data points
        let finalData = grouped.data;
        let finalLabels = grouped.labels;
        if (finalData.length > 50) {
          finalData = finalData.slice(finalData.length - 50);
          finalLabels = finalLabels.slice(finalLabels.length - 50);
        }
        
        drawTrendChart(m.canvas, m.summary, finalData, finalLabels);
      });
    }
    
    // ===== 事件綁定 =====
    window.addEventListener('DOMContentLoaded', () => {
      loadState();initRomanceState();

      // 時鐘
      renderHeader();
      setInterval(renderHeader, 1000);

      // 趨勢圖選擇器事件
      ['life','money','job','read','thesis','fiction'].forEach(mod => {
        const sel = document.getElementById(mod + 'TrendSelect');
        const fromEl = document.getElementById(mod + 'TrendFrom');
        const toEl = document.getElementById(mod + 'TrendTo');
        const groupEl = document.getElementById(mod + 'TrendGroup');
        if (sel) sel.onchange = renderAllTrends;
        if (fromEl) fromEl.onchange = renderAllTrends;
        if (toEl) toEl.onchange = renderAllTrends;
        if (groupEl) groupEl.onchange = renderAllTrends;
      });

      // 吳質 & 角色問候
      setTimeout(() => maybeShowWuZhi(new Date()), 5000);
      setInterval(() => maybeShowWuZhi(new Date()), 180000);
      setTimeout(() => showRandomCharacterGreeting(new Date()), 15000);
      setInterval(() => showRandomCharacterGreeting(new Date()), 300000);

      // BE自動判定（每分鐘檢查一次）
      checkBEAutoUnlock();
      setInterval(checkBEAutoUnlock, 60000);

      // 日期切換
      document.getElementById('prevDayBtn').onclick = () => {
        const d = dateFromKey(state.selectedDateKey);
        state.selectedDateKey = dateKeyFromDate(addDays(d, -1));
        saveState();
        renderAll();
      };
      document.getElementById('nextDayBtn').onclick = () => {
        const d = dateFromKey(state.selectedDateKey);
        state.selectedDateKey = dateKeyFromDate(addDays(d, 1));
        saveState();
        renderAll();
      };
      document.getElementById('datePill').onclick = () => {
        initCalendar();
        openModal('dateModalOverlay');
      };
      document.getElementById('dateModalClose').onclick = () => closeModal('dateModalOverlay');
      document.getElementById('dateModalOverlay').onclick = (e) => {
        if (e.target.id === 'dateModalOverlay') closeModal('dateModalOverlay');
      };

      // 聯絡客戶
      document.getElementById('jobAddBtn').onclick = () => {
        const type = document.getElementById('jobType').value;
        const amount = Number(document.getElementById('jobAmount').value);
        if (!amount) return;
        const id = generateId();
        const entries = getJobEntries(state.selectedDateKey);
        entries.push({ id, type, amount, timestamp: Date.now() });
        document.getElementById('jobAmount').value = '';
        
        const typeLabels = { research: '企業調查', prep: '面試對策', writing: '文書寫作', general: '綜合準備' };
        addAutoTimeline(`${typeLabels[type]} ×${amount}，才幹+${type === 'research' ? amount : amount * (type === 'prep' ? 30 : 15)}`, { module: 'job', entryId: id });
        saveState();
        renderAll();
      };
      document.getElementById('jobOfferStatus').onchange = (e) => {
        if (e.target.value === 'has') {
          if (!state.job.offerDate) state.job.offerDate = state.selectedDateKey;
        } else {
          state.job.offerDate = null;
        }
        saveState();
        renderAll();
      };

      // 雅客宴遊（論文）
      document.getElementById('thesisAddProjectBtn').onclick = () => {
        const name = document.getElementById('thesisNewProjectName').value.trim();
        if (!name) return;
        state.thesis.projects.push({ id: generateId(), name, done: false, doneDate: null });
        document.getElementById('thesisNewProjectName').value = '';
        saveState();
        renderAll();
      };
      document.getElementById('thesisAddBtn').onclick = () => {
        const words = Number(document.getElementById('thesisWords').value);
        if (!words) return;
        const projectId = document.getElementById('thesisProjectSelect').value || null;
        const id = generateId();
        getThesisEntries(state.selectedDateKey).push({ id, words, projectId, timestamp: Date.now() });
        document.getElementById('thesisWords').value = '';
        
        const proj = state.thesis.projects.find(p => p.id === projectId);
        const projName = proj ? proj.name : '論文';
        addAutoTimeline(`為${projName}寫作 ${words} 字，聲望+${Math.floor(words / 1000) * 30}`, { module: 'thesis', entryId: id });
        saveState();
        renderAll();
      };

      // 財務管理
      document.getElementById('moneyMainType').onchange = (e) => {
        const subWrap = document.getElementById('moneySubWrapper');
        subWrap.style.display = e.target.value === 'dailyOut' ? 'block' : 'none';
      };
      document.getElementById('moneyAddBtn').onclick = () => {
        const main = document.getElementById('moneyMainType').value;
        const sub = document.getElementById('moneySubType').value;
        const amount = Number(document.getElementById('moneyAmount').value);
        const note = document.getElementById('moneyNote').value.trim();
        const wallet = document.getElementById('moneyWallet').value;
        if (!amount) return;
        const id = generateId();
        getMoneyEntries(state.selectedDateKey).push({ id, main, sub, amount, note, wallet, timestamp: Date.now() });
        document.getElementById('moneyAmount').value = '';
        document.getElementById('moneyNote').value = '';
        
        const mainMap = { dailyOut: '日常支出', basicOut: '基本支出', specialOut: '特殊支出', income: '收入' };
        const noteText = note ? `（${note}）` : '';
        addAutoTimeline(`${mainMap[main]} ${amount} 日圓${noteText}`, { module: 'money', entryId: id });
        saveState();
        renderAll();
      };

    // 組織經營（生活）- 單項即時保存並記錄到動態軸
      const lifeFieldLabels = {
        sleepTime: '入睡時間',
        wakeTime: '起床時間',
        water: '飲水量',
        bowel: '排便',
        nutrition: '營養評估',
        skin: '深度護膚',
        selfDev: '自我啟發',
        fun: '專注娛樂',
        outing: '外出遊玩',
        empty: '內耗空虛',
        period: '月經',
        masturbation: '自慰',
        weight: '體重'
      };
      const lifeFieldUnits = {
        sleepTime: 'h',
        wakeTime: 'h',
        water: 'ml',
        bowel: '',
        nutrition: '分',
        skin: '分',
        selfDev: '小時',
        fun: '小時',
        outing: '次',
        empty: '小時',
        period: '',
        masturbation: '',
        weight: 'kg'
      };

      function formatLifeFieldText(field, value) {
        if (value === null || value === '') return null;
        const numVal = Number(value);
        const label = lifeFieldLabels[field] || field;
        const unit = lifeFieldUnits[field] || '';
        
        // 特殊處理某些欄位的顯示
        if (field === 'bowel') {
          return numVal >= 1 ? '已排便 ✓' : null;
        } else if (field === 'period') {
          return numVal >= 1 ? '月經期 🔴' : null;
        } else if (field === 'masturbation') {
          return numVal >= 1 ? '自慰 ✓' : null;
        } else if (field === 'sleepTime') {
          const h = numVal;
          if (h >= 24) {
            return `入睡時間：${h - 24}:${((h % 1) * 60) === 0 ? '00' : (h % 1) * 60}（次日凌晨）`;
          } else {
            const hh = Math.floor(h);
            const mm = (h % 1) * 60;
            return `入睡時間：${hh}:${mm === 0 ? '00' : mm}`;
          }
        } else if (field === 'wakeTime') {
          const hh = Math.floor(numVal);
          const mm = (numVal % 1) * 60;
          return `起床時間：${hh}:${mm === 0 ? '00' : mm}`;
        } else {
          return `${label}：${numVal}${unit}`;
        }
      }

      function updateLifeFieldTimeline(field, value) {
        const key = state.selectedDateKey;
        const timeline = getTimeline(key);
        const now = new Date();
        
        // 查找該欄位的現有記錄
        const existingIdx = timeline.findIndex(t => 
          t.isAuto && t.autoData && t.autoData.module === 'life' && t.autoData.field === field
        );
        
        const text = formatLifeFieldText(field, value);
        
        if (text) {
          // 有值：更新或新增
          if (existingIdx !== -1) {
            // 更新現有記錄的文字，保留原時間戳
            timeline[existingIdx].text = text;
          } else {
            // 新增記錄
            timeline.push({
              id: generateId(),
              text: text,
              images: [],
              timestamp: now.getTime(),
              hour: now.getHours(),
              minute: now.getMinutes(),
              tag: null,
              isAuto: true,
              autoData: { module: 'life', field: field }
            });
          }
        } else {
          // 無值或清空：刪除現有記錄
          if (existingIdx !== -1) {
            timeline.splice(existingIdx, 1);
          }
        }
        
        saveState();
        renderTimeline();
      }

      function saveLifeField(input) {
        const field = input.dataset.lifeField;
        const d = getLifeDaily(state.selectedDateKey);
        const newVal = input.value === '' ? null : Number(input.value);
        
        // 更新數據
        d[field] = newVal;
        saveState();
        
        // 更新動態軸（會自動處理新增/更新/刪除）
        updateLifeFieldTimeline(field, newVal);
        
        renderLifeSection();
      }

      document.querySelectorAll('[data-life-field]').forEach(input => {
        input.addEventListener('change', () => {
          saveLifeField(input);
        });
        
        // 也支持按 Enter 保存
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            input.blur();
          }
        });
      });

      // === V5：飲水量記錄（帶類型） ===
      function addWaterRecord() {
        const amount = Number(document.getElementById('lifeWaterInput').value);
        if (!amount || amount <= 0) return;
        const type = document.getElementById('lifeWaterType').value;
        const typeNames = { water: '水', juice: '果汁飲料', tea: '茶奶咖啡', alcohol: '酒' };
        
        const key = state.selectedDateKey;
        const id = generateId();
        const logs = getWaterLogs(key);
        logs.push({ id, amount, type, timestamp: Date.now() });
        
        const d = getLifeDaily(key);
        d.water = getTotalWater(key);
        
        document.getElementById('lifeWaterInput').value = '';
        
        addAutoTimeline(`喝${typeNames[type] || '水'} ${amount} ml（累計 ${d.water} ml）`, { module: 'life', type: 'water', logId: id, entryId: id });
        
        saveState();
        renderLifeSection();
      }

      document.getElementById('lifeWaterInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addWaterRecord(); }
      });
      const waterAddBtn = document.getElementById('lifeWaterAddBtn');
      if (waterAddBtn) waterAddBtn.onclick = addWaterRecord;
      
      // === V5：營養記錄（多次） ===
      function addNutritionRecord() {
        const score = Number(document.getElementById('lifeNutritionInput').value);
        if (!score && score !== 0) return;
        const meal = document.getElementById('lifeNutritionMeal').value;
        const note = document.getElementById('lifeNutritionNote').value.trim();
        const mealNames = { breakfast: '早餐', lunch: '中餐', dinner: '晚餐', snack: '小食' };
        
        const key = state.selectedDateKey;
        const id = generateId();
        getNutritionLogs(key).push({ id, score, meal, note, timestamp: Date.now() });
        
        document.getElementById('lifeNutritionInput').value = '';
        document.getElementById('lifeNutritionNote').value = '';
        
        const noteText = note ? `（${note}）` : '';
        addAutoTimeline(`${mealNames[meal]}營養 ${score} 分${noteText}（累計 ${getTotalNutrition(key)} 分）`, { module: 'life', type: 'nutrition', entryId: id });
        
        saveState();
        renderLifeSection();
      }
      const nutritionAddBtn = document.getElementById('lifeNutritionAddBtn');
      if (nutritionAddBtn) nutritionAddBtn.onclick = addNutritionRecord;
      document.getElementById('lifeNutritionInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addNutritionRecord(); }
      });
      
      // === V5：自我啟發（多次） ===
      function addSelfDevRecord() {
        const hours = Number(document.getElementById('lifeSelfDevInput').value);
        if (!hours) return;
        const note = document.getElementById('lifeSelfDevNote').value.trim();
        
        const key = state.selectedDateKey;
        const id = generateId();
        getSelfDevLogs(key).push({ id, hours, note, timestamp: Date.now() });
        
        document.getElementById('lifeSelfDevInput').value = '';
        document.getElementById('lifeSelfDevNote').value = '';
        
        const noteText = note ? `（${note}）` : '';
        addAutoTimeline(`自我啟發 ${hours}h${noteText}（累計 ${getTotalSelfDev(key)}h）`, { module: 'life', type: 'selfDev', entryId: id });
        
        saveState();
        renderLifeSection();
      }
      const selfDevAddBtn = document.getElementById('lifeSelfDevAddBtn');
      if (selfDevAddBtn) selfDevAddBtn.onclick = addSelfDevRecord;
      document.getElementById('lifeSelfDevInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addSelfDevRecord(); }
      });
      
      // === V5：外出遊玩（多次） ===
      function addOutingRecord() {
        const count = Number(document.getElementById('lifeOutingInput').value) || 1;
        const note = document.getElementById('lifeOutingNote').value.trim();
        
        const key = state.selectedDateKey;
        const id = generateId();
        getOutingLogs(key).push({ id, count, note, timestamp: Date.now() });
        
        document.getElementById('lifeOutingInput').value = '';
        document.getElementById('lifeOutingNote').value = '';
        
        const noteText = note ? `（${note}）` : '';
        addAutoTimeline(`外出遊玩${noteText}（累計 ${getTotalOuting(key)} 次）`, { module: 'life', type: 'outing', entryId: id });
        
        saveState();
        renderLifeSection();
      }
      const outingAddBtn = document.getElementById('lifeOutingAddBtn');
      if (outingAddBtn) outingAddBtn.onclick = addOutingRecord;
      document.getElementById('lifeOutingInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addOutingRecord(); }
      });
      
      // === V5：專注於樂（多次） ===
      function addFunRecord() {
        const hours = Number(document.getElementById('lifeFunInput').value);
        if (!hours) return;
        const note = document.getElementById('lifeFunNote').value.trim();
        
        const key = state.selectedDateKey;
        const id = generateId();
        getFunLogs(key).push({ id, hours, note, timestamp: Date.now() });
        
        document.getElementById('lifeFunInput').value = '';
        document.getElementById('lifeFunNote').value = '';
        
        const noteText = note ? `（${note}）` : '';
        addAutoTimeline(`專注於樂 ${hours}h${noteText}（累計 ${getTotalFun(key)}h）`, { module: 'life', type: 'fun', entryId: id });
        
        saveState();
        renderLifeSection();
      }
      const funAddBtn = document.getElementById('lifeFunAddBtn');
      if (funAddBtn) funAddBtn.onclick = addFunRecord;
      document.getElementById('lifeFunInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addFunRecord(); }
      });
      
      // === V5：空虛內耗（多次） ===
      function addEmptyRecord() {
        const hours = Number(document.getElementById('lifeEmptyInput').value);
        if (!hours) return;
        const note = document.getElementById('lifeEmptyNote').value.trim();
        
        const key = state.selectedDateKey;
        const id = generateId();
        getEmptyLogs(key).push({ id, hours, note, timestamp: Date.now() });
        
        document.getElementById('lifeEmptyInput').value = '';
        document.getElementById('lifeEmptyNote').value = '';
        
        const noteText = note ? `（${note}）` : '';
        addAutoTimeline(`空虛內耗 ${hours}h${noteText}（累計 ${getTotalEmpty(key)}h）`, { module: 'life', type: 'empty', entryId: id });
        
        saveState();
        renderLifeSection();
      }
      const emptyAddBtn = document.getElementById('lifeEmptyAddBtn');
      if (emptyAddBtn) emptyAddBtn.onclick = addEmptyRecord;
      document.getElementById('lifeEmptyInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); addEmptyRecord(); }
      });

      document.getElementById('lifeSaveBtn').onclick = () => {
        const d = getLifeDaily(state.selectedDateKey);
        
        document.querySelectorAll('[data-life-field]').forEach(input => {
          const field = input.dataset.lifeField;
          const newVal = input.value === '' ? null : Number(input.value);
          d[field] = newVal;
          updateLifeFieldTimeline(field, newVal);
        });
        
        saveState();
        renderAll();
        showPeriodReminder();
      };
      
      // === V5：Toggle 按鈕事件 ===
      document.getElementById('periodToggleBtn').onclick = () => {
        const key = state.selectedDateKey;
        const d = getLifeDaily(key);
        d.period = d.period >= 1 ? 0 : 1;
        
        updateLifeFieldTimeline('period', d.period);
        
        if (d.period >= 1) {
          // 月經Toggle開啟時，默認延續7天
          for (let i = 1; i <= 6; i++) {
            const futureDate = addDays(dateFromKey(key), i);
            const futureKey = dateKeyFromDate(futureDate);
            const fd = getLifeDaily(futureKey);
            if (fd.period === null || fd.period === 0) {
              fd.period = 1;
            }
          }
        } else {
          // 月經Toggle關閉時，清除後續連續的自動標記
          for (let i = 1; i <= 6; i++) {
            const futureDate = addDays(dateFromKey(key), i);
            const futureKey = dateKeyFromDate(futureDate);
            const fd = getLifeDaily(futureKey);
            if (fd.period >= 1) {
              fd.period = 0;
            } else {
              break; // 遇到已經為0的就停止
            }
          }
        }
        
        saveState();
        renderAll();
        showPeriodReminder();
      };
      
      document.getElementById('mastToggleBtn').onclick = () => {
        const key = state.selectedDateKey;
        const d = getLifeDaily(key);
        d.masturbation = d.masturbation >= 1 ? 0 : 1;
        updateLifeFieldTimeline('masturbation', d.masturbation);
        saveState();
        renderAll();
      };

      // === 排便按鈕 ===
      document.getElementById('bowelToggleBtn').onclick = () => {
        const key = state.selectedDateKey;
        const d = getLifeDaily(key);
        d.bowel = d.bowel >= 1 ? 0 : 1;
        updateLifeFieldTimeline('bowel', d.bowel);
        saveState();
        renderAll();
      };
      
      // === 體重Enter輸入 ===
      document.getElementById('weightQuickInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const inp = document.getElementById('weightQuickInput');
          const val = parseFloat(inp.value);
          if (isNaN(val)) return;
          const key = state.selectedDateKey;
          const d = getLifeDaily(key);
          d.weight = val;
          updateLifeFieldTimeline('weight', val);
          saveState();
          inp.value = val;
          inp.style.color = '#333';
          inp.style.fontWeight = '600';
          inp.style.background = 'rgba(178,144,90,0.12)';
          renderAll();
        }
      });
      
      // === 入睡按鈕（toggle：點亮=記錄當前時間，再點=撤銷） ===
      document.getElementById('sleepQuickBtn').onclick = () => {
        const key = state.selectedDateKey;
        const d = getLifeDaily(key);
        if (d.sleepTime !== null && d.sleepTime !== undefined && d.sleepTime !== '') {
          // 撤銷
          d.sleepTime = null;
          updateLifeFieldTimeline('sleepTime', null);
        } else {
          const now = new Date();
          // 精準記錄：小時 + 分鐘/60（保留2位小數）
          let timeVal = Math.round((now.getHours() + now.getMinutes() / 60) * 100) / 100;
          // 凌晨0-5點自動識別為前一天的深夜，用24+格式
          if (timeVal < 5) {
            timeVal = 24 + timeVal;
          }
          d.sleepTime = timeVal;
          updateLifeFieldTimeline('sleepTime', timeVal);
          const sleepEl = document.getElementById('lifeSleepTime');
          if (sleepEl) sleepEl.value = timeVal;
        }
        saveState();
        renderAll();
      };
      
      // === 起床按鈕（toggle：點亮=記錄當前時間，再點=撤銷） ===
      document.getElementById('wakeQuickBtn').onclick = () => {
        const key = state.selectedDateKey;
        const d = getLifeDaily(key);
        if (d.wakeTime !== null && d.wakeTime !== undefined && d.wakeTime !== '') {
          d.wakeTime = null;
          updateLifeFieldTimeline('wakeTime', null);
        } else {
          const now = new Date();
          // 精準記錄
          const timeVal = Math.round((now.getHours() + now.getMinutes() / 60) * 100) / 100;
          d.wakeTime = timeVal;
          updateLifeFieldTimeline('wakeTime', timeVal);
          const wakeEl = document.getElementById('lifeWakeTime');
          if (wakeEl) wakeEl.value = timeVal;
        }
        saveState();
        renderAll();
      };
      
      // === V5：店鋪記事本自動保存 ===
      let notepadSaveTimer = null;
      document.getElementById('shopNotepadContent').addEventListener('input', () => {
        clearTimeout(notepadSaveTimer);
        notepadSaveTimer = setTimeout(() => {
          const key = state.selectedDateKey;
          state.notepad[key] = document.getElementById('shopNotepadContent').innerHTML;
          saveState();
          renderDailyAttrs();
          // 更新魅力計算（不重置記事本內容）
          const charmVal = calcCharm(key);
          const charmEl = document.getElementById('shopCharmDisplay');
          if (charmEl) {
            charmEl.textContent = charmVal;
            charmEl.style.color = charmVal >= 80 ? '#4a7c59' : charmVal >= 50 ? '#c08020' : '#c04040';
          }
          // 更新魅力公式
          const tl = getTimeline(key);
          const npHtml = state.notepad[key] || '';
          const wts = { red: 5, orange: 3, yellow: 1 };
          let eR2=0,eO2=0,eY2=0;
          tl.forEach(t => { if(t.tag==='red')eR2++; else if(t.tag==='orange')eO2++; else if(t.tag==='yellow')eY2++; });
          let pR2=0,pO2=0,pY2=0;
          const td2 = document.createElement('div'); td2.innerHTML = npHtml;
          td2.querySelectorAll('span[data-tag]').forEach(sp => { const tg=sp.dataset.tag; if(tg==='red')pR2++; else if(tg==='orange')pO2++; else if(tg==='yellow')pY2++; });
          const fe = document.getElementById('shopCharmFormula');
          if (fe) {
            fe.innerHTML = `執行：🔴${eR2}×5 + 🟠${eO2}×3 + 🟡${eY2}×1 = ${eR2*5+eO2*3+eY2*1}<br/>計劃：🔴${pR2}×5 + 🟠${pO2}×3 + 🟡${pY2}×1 = ${pR2*5+pO2*3+pY2*1}<br/>魅力 = ${eR2*5+eO2*3+eY2*1} ÷ ${pR2*5+pO2*3+pY2*1||1} × 100 = <strong>${charmVal}</strong>`;
          }
          // 同步到彈窗版記事本（彈窗不在焦點時才同步）
          const modalNotepad = document.getElementById('notepadContent');
          if (modalNotepad && document.activeElement !== modalNotepad) {
            modalNotepad.innerHTML = state.notepad[key];
          }
        }, 500);
      });
      
      // === V5：店鋪動態發佈 ===
      let shopTimelineImages = [];
      document.getElementById('shopTimelineImageBtn').onclick = () => {
        document.getElementById('shopTimelineImageInput').click();
      };
      document.getElementById('shopTimelineImageInput').onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = (ev) => {
            shopTimelineImages.push(ev.target.result);
            renderShopTimelineImagePreview();
          };
          reader.readAsDataURL(file);
        });
      };
      function renderShopTimelineImagePreview() {
        const wrap = document.getElementById('shopTimelineImagePreview');
        wrap.innerHTML = shopTimelineImages.map((img, i) =>
          `<img src="${img}" style="width:30px;height:30px;border-radius:3px;object-fit:cover;cursor:pointer;" onclick="shopTimelineImages.splice(${i},1);renderShopTimelineImagePreview();" />`
        ).join('');
      }
      document.getElementById('shopTimelinePostBtn').onclick = () => {
        const text = document.getElementById('shopTimelinePostText').value.trim();
        if (!text && shopTimelineImages.length === 0) return;
        const key = state.selectedDateKey;
        const now = new Date();
        const timeline = getTimeline(key);
        timeline.push({
          id: generateId(),
          text: text,
          images: [...shopTimelineImages],
          timestamp: now.getTime(),
          hour: now.getHours(),
          minute: now.getMinutes(),
          tag: null,
          isAuto: false
        });
        document.getElementById('shopTimelinePostText').value = '';
        shopTimelineImages = [];
        renderShopTimelineImagePreview();
        saveState();
        renderShopTimeline();
        renderTimeline();
        renderDailyAttrs();
      };


      // 新書發布（創作）
      document.getElementById('fictionAddProjectBtn').onclick = () => {
        const name = document.getElementById('fictionNewProjectName').value.trim();
        if (!name) return;
        state.fiction.projects.push({ id: generateId(), name, done: false, doneDate: null });
        document.getElementById('fictionNewProjectName').value = '';
        saveState();
        renderAll();
      };
      document.getElementById('fictionAddBtn').onclick = () => {
        const words = Number(document.getElementById('fictionWords').value);
        if (!words) return;
        const projectId = document.getElementById('fictionProjectSelect').value || null;
        const id = generateId();
        getFictionEntries(state.selectedDateKey).push({ id, words, projectId, timestamp: Date.now() });
        document.getElementById('fictionWords').value = '';
        
        const proj = state.fiction.projects.find(p => p.id === projectId);
        const projName = proj ? proj.name : '創作';
        addAutoTimeline(`為${projName}創作 ${words} 字，文彩+${Math.floor(words / 1000) * 50}`, { module: 'fiction', entryId: id });
        saveState();
        renderAll();
      };

      // 謄錄經典（閱讀）
      document.getElementById('readAddProjectBtn').onclick = () => {
        const name = document.getElementById('readNewProjectName').value.trim();
        const totalPages = Number(document.getElementById('readNewProjectPages').value) || 0;
        if (!name) return;
        state.reading.projects.push({ 
          id: generateId(), 
          name, 
          totalPages,
          currentPage: 0,
          done: false, 
          doneDate: null 
        });
        document.getElementById('readNewProjectName').value = '';
        document.getElementById('readNewProjectPages').value = '';
        saveState();
        renderAll();
      };
      document.getElementById('readAddBtn').onclick = () => {
        const type = document.getElementById('readType').value;
        const pages = Number(document.getElementById('readPages').value);
        if (!pages) return;
        const id = generateId();
        getReadEntries(state.selectedDateKey).push({ id, type, pages, timestamp: Date.now() });
        document.getElementById('readPages').value = '';
        
        const typeMap = { philo: '哲學文獻', academic: '學術文獻', nonfic: '非學術讀物' };
        const mult = type === 'philo' ? 3 : (type === 'academic' ? 0.5 : 0.3);
        addAutoTimeline(`閱讀${typeMap[type]} ${pages} 頁，學識+${Math.round(pages * mult * 10) / 10}`, { module: 'reading', entryId: id });
        saveState();
        renderAll();
      };

      // 店鋪清潔 (button removed from toolbar, now inline in shop status)
      // document.getElementById('btnCleaning') removed
      document.getElementById('cleaningCloseBtn').onclick = () => closeModal('cleaningModalOverlay');
      document.getElementById('cleaningModalOverlay').onclick = (e) => {
        if (e.target.id === 'cleaningModalOverlay') closeModal('cleaningModalOverlay');
      };

      // 記事本彈窗 (button removed from toolbar, now inline in shop status)
      document.getElementById('notepadSaveBtn').onclick = () => {
        saveNotepad();
        // 同步到店鋪版記事本
        const shopNote = document.getElementById('shopNotepadContent');
        if (shopNote) shopNote.innerHTML = state.notepad[state.selectedDateKey] || '';
      };
      document.getElementById('notepadCloseBtn').onclick = () => {
        saveNotepad();
        const shopNote = document.getElementById('shopNotepadContent');
        if (shopNote) shopNote.innerHTML = state.notepad[state.selectedDateKey] || '';
        closeModal('notepadModalOverlay');
      };
      document.getElementById('notepadModalOverlay').onclick = (e) => {
        if (e.target.id === 'notepadModalOverlay') {
          saveNotepad();
          closeModal('notepadModalOverlay');
        }
      };
      document.getElementById('notepadBold').onclick = () => execNotepadCommand('bold');
      document.getElementById('notepadUnderline').onclick = () => execNotepadCommand('underline');
      document.getElementById('notepadStrike').onclick = () => execNotepadCommand('strikeThrough');
      document.getElementById('notepadColorBlack').onclick = () => execNotepadCommand('foreColor', '#000000');
      document.getElementById('notepadColorRed').onclick = () => execNotepadCommand('foreColor', '#c04040');
      document.getElementById('notepadColorBlue').onclick = () => execNotepadCommand('foreColor', '#2060a0');
      document.getElementById('notepadColorGreen').onclick = () => execNotepadCommand('foreColor', '#308030');
      document.getElementById('notepadTagYellow').onclick = () => insertNotepadTag('yellow');
      document.getElementById('notepadTagOrange').onclick = () => insertNotepadTag('orange');
      document.getElementById('notepadTagRed').onclick = () => insertNotepadTag('red');
      document.getElementById('notepadBullet').onclick = () => execNotepadCommand('insertUnorderedList');
      document.getElementById('notepadIndent').onclick = () => execNotepadCommand('indent');
      document.getElementById('notepadOutdent').onclick = () => execNotepadCommand('outdent');
      document.getElementById('notepadTagDelete').onclick = () => deleteSelectedTag();

      // 動態軸發佈彈窗 (button removed, now inline)
      // document.getElementById('btnPostTimeline') removed
      document.getElementById('timelinePostCloseBtn').onclick = () => {
        closeModal('timelinePostModalOverlay');
      };
      document.getElementById('timelinePostModalOverlay').onclick = (e) => {
        if (e.target.id === 'timelinePostModalOverlay') closeModal('timelinePostModalOverlay');
      };
      
      document.getElementById('timelineImageBtn').onclick = () => {
        document.getElementById('timelineImageInput').click();
      };
      document.getElementById('timelineImageInput').onchange = (e) => {
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            timelineImages.push(ev.target.result);
            renderTimelineImagePreview();
          };
          reader.readAsDataURL(files[i]);
        }
        e.target.value = '';
      };
      document.getElementById('timelinePostBtn').onclick = () => {
        const text = document.getElementById('timelinePostText').value.trim();
        if (!text && !timelineImages.length) return;
        const now = new Date();
        const timeline = getTimeline(state.selectedDateKey);
        
        if (editingTimelineItem) {
          editingTimelineItem.text = text;
          editingTimelineItem.images = [...timelineImages];
          editingTimelineItem = null;
        } else {
          timeline.push({
            id: generateId(),
            text,
            images: [...timelineImages],
            timestamp: now.getTime(),
            hour: now.getHours(),
            minute: now.getMinutes(),
            tag: null,
            isAuto: false,
            autoData: null
          });
        }
        
        document.getElementById('timelinePostText').value = '';
        timelineImages = [];
        renderTimelineImagePreview();
        saveState();
        renderTimeline();
        closeModal('timelinePostModalOverlay');
      };

      // 獎盃一覽
      document.getElementById('btnTrophies').onclick = () => {
        renderTrophies();
        openModal('trophyModalOverlay');
      };
      document.getElementById('trophyCloseBtn').onclick = () => closeModal('trophyModalOverlay');
      document.getElementById('trophyModalOverlay').onclick = (e) => {
        if (e.target.id === 'trophyModalOverlay') closeModal('trophyModalOverlay');
      };

    // 金風玉露面板（原轉盤按鈕）
      document.getElementById('btnSpinner').onclick = () => {
        initRomanceState();
        renderRomancePanel();
        openModal('romanceModalOverlay');
      };
      document.getElementById('romanceCloseBtn').onclick = () => closeModal('romanceModalOverlay');
      document.getElementById('romanceModalOverlay').onclick = (e) => {
        if (e.target.id === 'romanceModalOverlay') closeModal('romanceModalOverlay');
      };

      // 好感度轉盤彈窗（獨立）
      document.getElementById('btnAffinity').onclick = () => {
        initRomanceState();
        renderAffinitySpinner();
        openModal('affinityModalOverlay');
      };
      document.getElementById('affinityCloseBtn').onclick = () => closeModal('affinityModalOverlay');
      document.getElementById('affinityModalOverlay').onclick = (e) => {
        if (e.target.id === 'affinityModalOverlay') closeModal('affinityModalOverlay');
      };

      // 動態軸彈窗 (button removed, timeline now inline)
      // document.getElementById('btnTimeline') removed
      document.getElementById('timelineCloseBtn').onclick = () => closeModal('timelineModalOverlay');
      document.getElementById('timelineModalOverlay').onclick = (e) => {
        if (e.target.id === 'timelineModalOverlay') closeModal('timelineModalOverlay');
      };

      // 今日動態彈窗
      document.getElementById('btnFeedViewer').onclick = () => {
        feedViewDateKey = state.selectedDateKey;
        document.getElementById('feedViewerModalOverlay').style.display = 'flex';
        renderFeedTimeline(feedViewDateKey);
      };
      document.getElementById('feedCloseBtn').onclick = () => {
        document.getElementById('feedViewerModalOverlay').style.display = 'none';
      };
      document.getElementById('feedViewerModalOverlay').onclick = (e) => {
        if (e.target.id === 'feedViewerModalOverlay') document.getElementById('feedViewerModalOverlay').style.display = 'none';
      };
      document.getElementById('feedPrevDay').onclick = () => {
        const d = addDays(dateFromKey(feedViewDateKey), -1);
        feedViewDateKey = dateKeyFromDate(d);
        renderFeedTimeline(feedViewDateKey);
      };
      document.getElementById('feedNextDay').onclick = () => {
        const d = addDays(dateFromKey(feedViewDateKey), 1);
        feedViewDateKey = dateKeyFromDate(d);
        renderFeedTimeline(feedViewDateKey);
      };
      document.getElementById('feedDatePicker').onchange = (e) => {
        if (e.target.value) { feedViewDateKey = e.target.value; renderFeedTimeline(feedViewDateKey); }
      };

      // 圖策天下
      const tvMetricOptions = {
        life: [
          {v:'water',l:'飲水量'},{v:'nutrition',l:'營養評估'},{v:'selfDev',l:'自我啟發'},{v:'fun',l:'專注於樂'},{v:'outing',l:'外出遊玩'},{v:'empty',l:'空虛內耗'},{v:'weight',l:'體重'},{v:'bowel',l:'排便'},{v:'sleepTime',l:'入睡時間'},{v:'wakeTime',l:'起床時間'},
          {v:'score',l:'德行（日分）'},{v:'streak',l:'起居錄'},{v:'grace',l:'風儀'}
        ],
        money: [
          {v:'dailyOut_total',l:'日常支出'},{v:'dailyOut_food',l:'日常-外食外賣'},{v:'dailyOut_drink',l:'日常-咖啡飲料'},{v:'dailyOut_dessert',l:'日常-外食甜品'},{v:'dailyOut_fresh',l:'日常-生鮮果蔬'},{v:'dailyOut_snack',l:'日常-零食小吃'},{v:'dailyOut_life',l:'日常-生活用品'},{v:'dailyOut_entertain',l:'日常-娛樂支出'},
          {v:'basicOut_total',l:'基本支出'},{v:'specialOut_total',l:'特殊支出'},{v:'income_total',l:'日常收入'},
          {v:'wallet_wechat',l:'微信支付'},{v:'wallet_alipay',l:'支付寶'},{v:'wallet_credit',l:'信用卡'},{v:'wallet_cash',l:'現金'},{v:'wallet_other',l:'其他錢包'},
          {v:'score',l:'財富（日分）'},{v:'streak',l:'聚寶盆'},{v:'freedom',l:'逍遙'}
        ],
        job: [
          {v:'survey',l:'企業調查'},{v:'interview',l:'面試對策'},{v:'writing',l:'文書寫作'},{v:'prep',l:'綜合準備'},
          {v:'score',l:'才幹（日分）'},{v:'auspicious',l:'祥瑞'},{v:'fate',l:'天命'}
        ],
        read: [
          {v:'philo',l:'哲學文獻'},{v:'academic',l:'學術文獻'},{v:'nonfic',l:'非學術讀物'},
          {v:'score',l:'學識（日分）'},{v:'streak',l:'人物誌'},{v:'different',l:'異心'}
        ],
        thesis: [
          {v:'words',l:'寫作字數'},
          {v:'score',l:'聲望（日分）'},{v:'rumor',l:'傳聞'},{v:'leling',l:'玲瓏'}
        ],
        fiction: [
          {v:'words',l:'創作字數'},
          {v:'score',l:'文彩（日分）'},{v:'tale',l:'奇譚'},{v:'spirit',l:'靈韻'}
        ]
      };
      
      function updateTvMetrics() {
        const mod = document.getElementById('tvModule').value;
        const sel = document.getElementById('tvMetric');
        sel.innerHTML = '';
        (tvMetricOptions[mod]||[]).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.v; opt.textContent = o.l;
          sel.appendChild(opt);
        });
      }
      
      function renderTvChart() {
        const mod = document.getElementById('tvModule').value;
        const metric = document.getElementById('tvMetric').value;
        const groupBy = document.getElementById('tvGroup').value;
        const fromKey = document.getElementById('tvFrom').value;
        const toKey = document.getElementById('tvTo').value;
        if (!fromKey || !toKey || fromKey > toKey || !metric) return;
        const raw = getTrendData(mod, metric, fromKey, toKey);
        const dKeys = generateDateKeys(fromKey, toKey);
        const grouped = groupTrendData(raw.data, raw.labels, dKeys, groupBy);
        let d = grouped.data, l = grouped.labels;
        if (d.length > 50) { d = d.slice(d.length-50); l = l.slice(l.length-50); }
        drawTrendChart('tvCanvas', 'tvSummary', d, l);
      }
      
      document.getElementById('btnTrendViewer').onclick = () => {
        updateTvMetrics();
        const today = dateFromKey(state.selectedDateKey);
        document.getElementById('tvFrom').value = dateKeyFromDate(addDays(today, -29));
        document.getElementById('tvTo').value = dateKeyFromDate(today);
        openModal('trendViewerModalOverlay');
        setTimeout(renderTvChart, 100);
      };
      document.getElementById('trendViewerCloseBtn').onclick = () => closeModal('trendViewerModalOverlay');
      document.getElementById('trendViewerModalOverlay').onclick = (e) => {
        if (e.target.id === 'trendViewerModalOverlay') closeModal('trendViewerModalOverlay');
      };
      document.getElementById('tvModule').onchange = () => { updateTvMetrics(); renderTvChart(); };
      document.getElementById('tvMetric').onchange = renderTvChart;
      document.getElementById('tvGroup').onchange = renderTvChart;
      document.getElementById('tvFrom').onchange = renderTvChart;
      document.getElementById('tvTo').onchange = renderTvChart;

      // 數據管理彈窗
      document.getElementById('btnDataManager').onclick = () => {
        renderDataOverview();
        openModal('dataManagerModalOverlay');
      };
      document.getElementById('dataManagerCloseBtn').onclick = () => closeModal('dataManagerModalOverlay');
      document.getElementById('dataManagerModalOverlay').onclick = (e) => {
        if (e.target.id === 'dataManagerModalOverlay') closeModal('dataManagerModalOverlay');
      };
      
      // 導出功能
      document.getElementById('btnExportJson').onclick = exportToJsonFile;
      document.getElementById('btnExportClipboard').onclick = exportToClipboard;
      
      // 導入功能
      document.getElementById('btnImportFile').onclick = () => {
        document.getElementById('importFileInput').click();
      };
      document.getElementById('importFileInput').onchange = (e) => {
        if (e.target.files.length > 0) {
          importFromFile(e.target.files[0]);
          e.target.value = '';
        }
      };
      document.getElementById('btnImportClipboard').onclick = importFromClipboard;
      
      // 導入確認彈窗
      document.getElementById('btnImportCancel').onclick = () => {
        pendingImportData = null;
        closeModal('importPreviewModalOverlay');
      };
      document.getElementById('btnImportConfirm').onclick = () => {
        if (pendingImportData) {
          executeImport(pendingImportData);
          pendingImportData = null;
          closeModal('importPreviewModalOverlay');
        }
      };
      document.getElementById('importPreviewModalOverlay').onclick = (e) => {
        if (e.target.id === 'importPreviewModalOverlay') {
          pendingImportData = null;
          closeModal('importPreviewModalOverlay');
        }
      };
      
      // 合併功能
      document.getElementById('btnMergeFile').onclick = () => {
        document.getElementById('mergeFileInput').click();
      };
      document.getElementById('mergeFileInput').onchange = (e) => {
        if (e.target.files.length > 0) {
          mergeFromFile(e.target.files[0]);
          e.target.value = '';
        }
      };
      
      // 合併確認彈窗
      document.getElementById('btnMergeCancel').onclick = () => {
        pendingMergeData = null;
        closeModal('mergePreviewModalOverlay');
      };
      document.getElementById('btnMergeConfirm').onclick = () => {
        if (pendingMergeData) {
          executeMerge(pendingMergeData);
          pendingMergeData = null;
          closeModal('mergePreviewModalOverlay');
        }
      };
      document.getElementById('mergePreviewModalOverlay').onclick = (e) => {
        if (e.target.id === 'mergePreviewModalOverlay') {
          pendingMergeData = null;
          closeModal('mergePreviewModalOverlay');
        }
      };
      
      // 清除所有數據
      document.getElementById('btnClearAllData').onclick = clearAllData;

      // 圖片大圖
      document.getElementById('imageOverlay').onclick = () => {
        document.getElementById('imageOverlay').style.display = 'none';
      };

// 移動端 header 滾動隱藏功能（toolbar 變成普通區塊，不再隨滾動隱藏）
let lastScrollY = window.scrollY;
let ticking = false;

function updateHeaderVisibility() {
  const header = document.querySelector('header');
  const currentScrollY = window.scrollY;
  
  if (window.innerWidth <= 768) {
    if (currentScrollY > lastScrollY && currentScrollY > 100) {
      header.classList.add('header-hidden');
    } else {
      header.classList.remove('header-hidden');
    }
  } else {
    header.classList.remove('header-hidden');
  }

  // 控制回到頂部按鈕顯示
  const backToTopBtn = document.getElementById('backToTop');
  if (backToTopBtn) {
    if (currentScrollY > 200) {
      backToTopBtn.classList.add('show');
    } else {
      backToTopBtn.classList.remove('show');
    }
  }
  
  lastScrollY = currentScrollY;
  ticking = false;
}

      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(updateHeaderVisibility);
          ticking = true;
        }
      });

    // 回到頂部按鈕點擊事件
const backToTopBtn = document.getElementById('backToTop');
if (backToTopBtn) {
  backToTopBtn.onclick = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
}

      // 月經助手 - 立即顯示並定時更新
      showPeriodReminder();
      setInterval(() => showPeriodReminder(), 600000); // 每10分鐘更新一次

      // 初始渲染
      renderAll();
    });
  </script>

 <!-- 回到頂部（極簡版） -->
  <button id="backToTop" class="back-to-top" aria-label="回到頂部">↑</button>
</body>
</html>
